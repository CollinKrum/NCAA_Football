<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🏈 NCAAF Betting Analysis Dashboard</title>
  <meta name="description" content="Comprehensive analysis of college football games and betting lines. Interactive charts, spread analysis, and conference breakdowns.">
  <meta property="og:title" content="NCAAF Betting Analysis Dashboard">
  <meta property="og:description" content="Interactive analysis of NCAAF betting lines and results.">
  <meta property="og:type" content="website">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color:#333; min-height:100vh;
    }
    .header {
      background: linear-gradient(90deg, #ff6b35 0%, #f7931e 100%);
      color:#fff; text-align:center; padding:20px;
      box-shadow:0 4px 8px rgba(0,0,0,.2);
    }
    .header h1 { font-size:2.2em; margin-bottom:8px; text-shadow:2px 2px 4px rgba(0,0,0,.3) }
    .header p { opacity:.9 }
    .container { max-width:1200px; margin:0 auto; padding:20px }
    .tabs { display:flex; justify-content:center; gap:8px; margin:20px 0; background:rgba(255,255,255,.1); border-radius:10px; padding:5px; flex-wrap:wrap }
    .tab { background:transparent; border:none; padding:12px 20px; color:#fff; cursor:pointer; border-radius:8px; font-size:15px; transition:.2s; }
    .tab:hover { background:rgba(255,255,255,.2) }
    .tab.active { background: linear-gradient(90deg, #ff6b35, #f7931e); box-shadow:0 4px 8px rgba(0,0,0,.2) }
    .tab-content { display:none }
    .tab-content.active { display:block; animation:fadeIn .35s ease }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none} }
    .filter-section, .analysis-section, .chart-container, .data-table {
      background:rgba(255,255,255,.95); border-radius:15px; padding:20px; margin:20px 0; box-shadow:0 8px 16px rgba(0,0,0,.1);
    }
    .filter-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); gap:15px }
    .filter-item { display:flex; flex-direction:column }
    .filter-item label { font-weight:600; color:#333; margin-bottom:6px }
    select, input { padding:10px; border:2px solid #ddd; border-radius:8px; font-size:14px }
    select:focus, input:focus { outline:none; border-color:#ff6b35 }
    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(240px,1fr)); gap:18px; margin:20px 0 }
    .stat-card { background:linear-gradient(135deg, rgba(255,255,255,.95), rgba(255,255,255,.85)); border-radius:15px; padding:22px; text-align:center; box-shadow:0 8px 16px rgba(0,0,0,.1) }
    .stat-number { font-size:2.2em; font-weight:700; color:#ff6b35; margin-bottom:8px }
    .stat-label { color:#333; font-weight:500 }
    .chart-title { font-size:1.2em; font-weight:600; color:#333; text-align:center; margin-bottom:12px }
    .chart-wrapper { position:relative; height:380px; }
    .two-column { display:grid; grid-template-columns:1fr 1fr; gap:24px }
    .insight-box { background:linear-gradient(90deg, #00b894, #00cec9); color:#fff; padding:12px; border-radius:10px; margin:12px 0 }
    .loading { text-align:center; color:#fff; font-size:1.1em; padding:30px }
    .spinner { border:4px solid rgba(255,255,255,.3); border-top:4px solid #ff6b35; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:16px auto }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .footer { background:rgba(255,255,255,.1); color:#fff; text-align:center; padding:20px; margin-top:30px; border-radius:15px }
    table { width:100%; border-collapse:collapse }
    th, td { padding:12px; text-align:left; border-bottom:1px solid #ddd }
    th { background:#ff6b35; color:#fff; font-weight:600 }
    tr:hover { background:rgba(255,107,53,.1) }
    @media (max-width: 900px) { .two-column{ grid-template-columns:1fr } .header h1{ font-size:1.8em } }
  </style>
</head>
<body>
  <div class="header">
    <h1>🏈 NCAAF Betting Analysis Dashboard</h1>
    <p>Comprehensive Analysis of College Football Games & Betting Lines</p>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab active" data-tab="overview">📊 Overview</button>
      <button class="tab" data-tab="spreads">📈 Spread Analysis</button>
      <button class="tab" data-tab="totals">🎯 Over/Under Analysis</button>
      <button class="tab" data-tab="trends">📅 Historical Trends</button>
      <button class="tab" data-tab="conferences">🏟️ Conference Analysis</button>
      <button class="tab" data-tab="teams">🏈 Team Analysis</button>
      <button class="tab" data-tab="yearly">📅 Year-by-Year Analysis</button>
    </div>

    <div id="loading" class="loading">
      <h2>🏈 Loading NCAAF Data...</h2>
      <div class="spinner"></div>
      <p>Processing games and betting lines...</p>
    </div>

    <div id="overview" class="tab-content">
      <div class="filter-section">
        <h3>🎛️ Data Filters</h3>
        <div class="filter-grid">
          <div class="filter-item"><label for="seasonFilter">Season:</label><select id="seasonFilter" onchange="updateAnalysis()"><option value="all">All Seasons</option></select></div>
          <div class="filter-item"><label for="providerFilter">Sportsbook:</label><select id="providerFilter" onchange="updateAnalysis()"><option value="all">All Providers</option></select></div>
          <div class="filter-item"><label for="conferenceFilter">Conference:</label><select id="conferenceFilter" onchange="updateAnalysis()"><option value="all">All Conferences</option></select></div>
          <div class="filter-item"><label for="weekFilter">Week:</label><select id="weekFilter" onchange="updateAnalysis()"><option value="all">All Weeks</option></select></div>
          <div class="filter-item"><label for="teamFilter">Team:</label><select id="teamFilter" onchange="updateAnalysis()"><option value="all">All Teams</option></select></div>
          <div class="filter-item"><label for="conferenceYearFilter">Conference by Year:</label><select id="conferenceYearFilter" onchange="updateAnalysis()"><option value="all">All Conference-Years</option></select></div>
        </div>
      </div>
      <div id="overview-stats" class="stats-grid"></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">📈 Games by Season</div><div class="chart-wrapper"><canvas id="seasonChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">🏢 Sportsbook Coverage</div><div class="chart-wrapper"><canvas id="providerChart"></canvas></div></div>
      </div>
    </div>

    <div id="spreads" class="tab-content">
      <div class="analysis-section"><h2>📈 Point Spread Analysis</h2><div class="insight-box"><strong>Key Insights:</strong> Point spreads reflect the expected margin of victory. Analyzing spread performance helps identify betting value and market inefficiencies.</div></div>
      <div id="spread-stats" class="stats-grid"></div>
      <div class="chart-container"><div class="chart-title">📊 Spread Distribution</div><div class="chart-wrapper"><canvas id="spreadDistChart"></canvas></div></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">🏠 Home vs Away ATS Performance</div><div class="chart-wrapper"><canvas id="homeAwayATSChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">📈 ATS Performance by Season</div><div class="chart-wrapper"><canvas id="atsSeasonChart"></canvas></div></div>
      </div>
    </div>

    <div id="totals" class="tab-content">
      <div class="analysis-section"><h2>🎯 Over/Under Analysis</h2><div class="insight-box"><strong>Key Insights:</strong> Total points analysis reveals scoring trends and helps identify betting opportunities.</div></div>
      <div id="totals-stats" class="stats-grid"></div>
      <div class="chart-container"><div class="chart-title">📊 Total Points Distribution</div><div class="chart-wrapper"><canvas id="totalsDistChart"></canvas></div></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">⬆️ Over/Under Performance</div><div class="chart-wrapper"><canvas id="overUnderChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">📈 Scoring Trends by Season</div><div class="chart-wrapper"><canvas id="scoringTrendChart"></canvas></div></div>
      </div>
    </div>

    <div id="trends" class="tab-content">
      <div class="analysis-section"><h2>📅 Historical Trends</h2><div class="insight-box"><strong>Key Insights:</strong> Historical trends reveal how betting markets evolved over time.</div></div>
      <div class="chart-container"><div class="chart-title">📈 Average Spreads by Season</div><div class="chart-wrapper"><canvas id="avgSpreadTrendChart"></canvas></div></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">🎯 Average Totals Trend</div><div class="chart-wrapper"><canvas id="avgTotalsTrendChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">📊 Market Volume Trends</div><div class="chart-wrapper"><canvas id="volumeTrendChart"></canvas></div></div>
      </div>
    </div>

    <div id="conferences" class="tab-content">
      <div class="analysis-section"><h2>🏟️ Conference Analysis</h2><div class="insight-box"><strong>Key Insights:</strong> Conferences differ in scoring, competitiveness, and betting patterns.</div></div>
      <div id="conference-stats" class="stats-grid"></div>
      <div class="chart-container"><div class="chart-title">🏟️ Games by Conference</div><div class="chart-wrapper"><canvas id="conferenceGamesChart"></canvas></div></div>
      <div class="data-table"><h3>📊 Conference Performance Table</h3><div id="conferenceTable"></div></div>
    </div>

    <div id="teams" class="tab-content">
      <div class="analysis-section">
        <h2>🏈 Individual Team Analysis</h2>
        <div class="insight-box"><strong>Key Insights:</strong> Deep-dive into ATS, totals, home/away splits, and trends.</div>
        <div class="filter-grid" style="margin: 20px 0;">
          <div class="filter-item"><label for="teamSelectAnalysis">Select Team for Deep Analysis:</label><select id="teamSelectAnalysis" onchange="updateTeamAnalysis()"><option value="">Choose a Team...</option></select></div>
        </div>
      </div>
      <div id="team-stats" class="stats-grid"></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">🏠 Home vs Away Performance</div><div class="chart-wrapper"><canvas id="teamHomeAwayChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">📈 Season-by-Season ATS Record</div><div class="chart-wrapper"><canvas id="teamATSSeasonChart"></canvas></div></div>
      </div>
      <div class="chart-container"><div class="chart-title">⭐ Team Performance vs Spreads</div><div class="chart-wrapper"><canvas id="teamSpreadChart"></canvas></div></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">🎯 Over/Under Performance</div><div class="chart-wrapper"><canvas id="teamTotalsChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">📊 Points Per Game Trends</div><div class="chart-wrapper"><canvas id="teamScoringChart"></canvas></div></div>
      </div>
      <div class="data-table"><h3>🏈 Recent Games</h3><div id="teamGamesTable"></div></div>
    </div>

    <div id="yearly" class="tab-content">
      <div class="analysis-section">
        <h2>📅 Year-by-Year Analysis</h2>
        <div class="insight-box"><strong>Key Insights:</strong> Compare betting market performance across seasons.</div>
        <div class="filter-grid" style="margin: 20px 0;">
          <div class="filter-item"><label for="yearSelectAnalysis">Select Season for Deep Analysis:</label><select id="yearSelectAnalysis" onchange="updateYearAnalysis()"><option value="">Choose a Season...</option></select></div>
          <div class="filter-item"><label for="compareYearSelect">Compare with Season:</label><select id="compareYearSelect" onchange="updateYearAnalysis()"><option value="">No Comparison</option></select></div>
        </div>
      </div>
      <div id="year-stats" class="stats-grid"></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">📊 Monthly Game Distribution</div><div class="chart-wrapper"><canvas id="yearMonthlyChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">🏟️ Conference Breakdown</div><div class="chart-wrapper"><canvas id="yearConferenceChart"></canvas></div></div>
      </div>
      <div class="chart-container"><div class="chart-title">📈 Weekly Performance Trends</div><div class="chart-wrapper"><canvas id="yearWeeklyChart"></canvas></div></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">🎯 Spread Accuracy</div><div class="chart-wrapper"><canvas id="yearSpreadAccuracyChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">📊 Scoring Distribution</div><div class="chart-wrapper"><canvas id="yearScoringDistChart"></canvas></div></div>
      </div>
      <div class="data-table"><h3>📈 Season Comparison Table</h3><div id="yearComparisonTable"></div></div>
    </div>
  </div>

  <div class="footer">
    <p>🏈 NCAAF Betting Analysis Dashboard | Data covers multiple seasons</p>
    <p>Built with Chart.js | Optimized for mobile and desktop</p>
  </div>

  <script>
    // ====== Global state ======
    let allData = [];
    let filteredData = [];
    let charts = {};

    // ====== Tabs ======
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(tabName)?.classList.add('active');
      document.querySelector('[data-tab="'+tabName+'"]')?.classList.add('active');
    }
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', () => showTab(tab.getAttribute('data-tab'))));
      loadData();
    });

    // ====== Data load (JSON file in repo) ======
    async function loadData() {
      try {
        const resp = await fetch('data/ncaaf-games.json', { cache: 'no-store' });
        if (!resp.ok) throw new Error('data/ncaaf-games.json not found');
        const json = await resp.json();
        allData = json;
        filteredData = allData;

        initializeFilters();
        updateAnalysis();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('overview').classList.add('active');
      } catch (e) {
        showError('Failed to load data: ' + e.message + '<br><br>Make sure your JSON exists at <code>data/ncaaf-games.json</code>.');
      }
    }

    function showError(message) {
      const el = document.getElementById('loading');
      if (el) el.innerHTML = '<div class="error"><h2>❌ Error Loading Data</h2><p>'+message+'</p></div>';
    }

    // ====== Filters ======
    function initializeFilters() {
      // Seasons
      const seasons = [...new Set(allData.map(r => r.Season))].filter(Boolean).sort((a,b)=>a-b);
      const seasonSel = document.getElementById('seasonFilter');
      seasons.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; seasonSel.appendChild(o); });

      // Year analysis dropdowns
      const yearSel = document.getElementById('yearSelectAnalysis');
      const compareSel = document.getElementById('compareYearSelect');
      seasons.forEach(s => {
        const o1=document.createElement('option'); o1.value=s; o1.textContent=s; yearSel.appendChild(o1);
        const o2=document.createElement('option'); o2.value=s; o2.textContent=s; compareSel.appendChild(o2);
      });

      // Providers
      const providers = [...new Set(allData.map(r => r.LineProvider))].filter(Boolean).sort();
      const providerSel = document.getElementById('providerFilter');
      providers.forEach(p => { const o=document.createElement('option'); o.value=p; o.textContent=p; providerSel.appendChild(o); });

      // Conferences
      const conferences = [...new Set(allData.map(r => r.HomeConference))].filter(Boolean).sort();
      const confSel = document.getElementById('conferenceFilter');
      conferences.forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; confSel.appendChild(o); });

      // Weeks
      const weeks = [...new Set(allData.map(r => r.Week))].filter(Boolean).sort((a,b)=>a-b);
      const weekSel = document.getElementById('weekFilter');
      weeks.forEach(w => { const o=document.createElement('option'); o.value=w; o.textContent='Week '+w; weekSel.appendChild(o); });

      // Teams
      const teams = [...new Set([...allData.map(r=>r.HomeTeam_x), ...allData.map(r=>r.AwayTeam_x)])].filter(Boolean).sort();
      const teamSel = document.getElementById('teamFilter');
      const teamSelAnalysis = document.getElementById('teamSelectAnalysis');
      teams.forEach(t => {
        const o=document.createElement('option'); o.value=t; o.textContent=t; teamSel.appendChild(o);
        const o2=document.createElement('option'); o2.value=t; o2.textContent=t; teamSelAnalysis.appendChild(o2);
      });

      // Conference-Year
      const confYears = new Set();
      allData.forEach(r => {
        if (r.HomeConference && r.Season) confYears.add(r.HomeConference+' '+r.Season);
        if (r.AwayConference && r.Season) confYears.add(r.AwayConference+' '+r.Season);
      });
      const cySel = document.getElementById('conferenceYearFilter');
      [...confYears].sort().forEach(cy => { const o=document.createElement('option'); o.value=cy; o.textContent=cy; cySel.appendChild(o); });
    }

    function applyFilters() {
      const s = document.getElementById('seasonFilter')?.value || 'all';
      const p = document.getElementById('providerFilter')?.value || 'all';
      const c = document.getElementById('conferenceFilter')?.value || 'all';
      const w = document.getElementById('weekFilter')?.value || 'all';
      const t = document.getElementById('teamFilter')?.value || 'all';
      const cy = document.getElementById('conferenceYearFilter')?.value || 'all';

      filteredData = allData.filter(r => {
        if (s !== 'all' && r.Season != s) return false;
        if (p !== 'all' && r.LineProvider !== p) return false;
        if (c !== 'all' && r.HomeConference !== c && r.AwayConference !== c) return false;
        if (w !== 'all' && r.Week != w) return false;
        if (t !== 'all' && r.HomeTeam_x !== t && r.AwayTeam_x !== t) return false;
        if (cy !== 'all') {
          const [confName, confYear] = cy.split(' ');
          const homeOK = r.HomeConference === confName && r.Season == confYear;
          const awayOK = r.AwayConference === confName && r.Season == confYear;
          if (!homeOK && !awayOK) return false;
        }
        return true;
      });
    }

    // ====== Top-level update ======
    function updateAnalysis() {
      applyFilters();
      updateOverviewStats();
      updateCharts();
      updateSpreadAnalysis();
      updateTotalsAnalysis();
      updateConferenceAnalysis();
      updateHistoricalTrends();
    }

    // ====== Overview KPIs ======
    function updateOverviewStats() {
      const totalGames = filteredData.length;
      const withSpreads = filteredData.filter(r => r.Spread != null).length;
      const withTotals = filteredData.filter(r => r.OverUnder != null).length;
      const avgSpread = withSpreads ? filteredData.filter(r=>r.Spread!=null).reduce((s,r)=>s+Math.abs(r.Spread||0),0)/withSpreads : 0;
      const avgTotal = withTotals ? filteredData.filter(r=>r.OverUnder!=null).reduce((s,r)=>s+(r.OverUnder||0),0)/withTotals : 0;

      const html = `
        <div class="stat-card"><div class="stat-number">${totalGames.toLocaleString()}</div><div class="stat-label">Total Games</div></div>
        <div class="stat-card"><div class="stat-number">${totalGames?((withSpreads/totalGames)*100).toFixed(1):'0.0'}%</div><div class="stat-label">Spread Coverage</div></div>
        <div class="stat-card"><div class="stat-number">${avgSpread?avgSpread.toFixed(1):'N/A'}</div><div class="stat-label">Avg Spread</div></div>
        <div class="stat-card"><div class="stat-number">${avgTotal?avgTotal.toFixed(1):'N/A'}</div><div class="stat-label">Avg Total</div></div>`;
      document.getElementById('overview-stats').innerHTML = html;
    }

    // ====== Charts (Overview/Trends) ======
    function destroy(name){ if(charts[name]){ charts[name].destroy(); charts[name]=null; }}

    function updateCharts(){ updateSeasonChart(); updateProviderChart(); }
    function updateHistoricalTrends(){ updateAvgSpreadTrendChart(); updateAvgTotalsTrendChart(); updateVolumeTrendChart(); updateScoringTrendChart(); }

    function updateSeasonChart(){
      const counts={}; filteredData.forEach(r=>{ if(r.Season) counts[r.Season]=(counts[r.Season]||0)+1; });
      const ctx=document.getElementById('seasonChart'); if(!ctx) return; destroy('seasonChart');
      charts.seasonChart = new Chart(ctx.getContext('2d'), {
        type:'bar', data:{ labels:Object.keys(counts).sort(), datasets:[{ label:'Games', data:Object.values(counts), backgroundColor:'rgba(255,107,53,.8)', borderColor:'rgba(255,107,53,1)', borderWidth:2 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
      });
    }

    function updateProviderChart(){
      const counts={}; filteredData.forEach(r=>{ if(r.LineProvider) counts[r.LineProvider]=(counts[r.LineProvider]||0)+1; });
      const sorted=Object.entries(counts).sort(([,a],[,b])=>b-a).slice(0,8);
      const ctx=document.getElementById('providerChart'); if(!ctx) return; destroy('providerChart');
      charts.providerChart=new Chart(ctx.getContext('2d'),{
        type:'doughnut', data:{ labels:sorted.map(([n])=>n), datasets:[{ data:sorted.map(([,c])=>c), backgroundColor:['#ff6b35','#f7931e','#2a5298','#1e3c72','#00b894','#00cec9','#6c5ce7','#a29bfe']}]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
      });
    }

    function updateAvgSpreadTrendChart(){
      const bucket={}; filteredData.forEach(r=>{ if(r.Season && r.Spread!=null){ (bucket[r.Season] ||= []).push(Math.abs(r.Spread)); }});
      const data=Object.entries(bucket).sort(([a],[b])=>a-b).map(([s,arr])=>({s, v: arr.reduce((x,y)=>x+y,0)/arr.length }));
      const ctx=document.getElementById('avgSpreadTrendChart'); if(!ctx||!data.length) return; destroy('avgSpreadTrendChart');
      charts.avgSpreadTrendChart=new Chart(ctx.getContext('2d'),{ type:'line', data:{ labels:data.map(d=>d.s), datasets:[{ label:'Average Spread', data:data.map(d=>d.v), borderColor:'#ff6b35', backgroundColor:'rgba(255,107,53,.1)', borderWidth:3, fill:true }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, title:{display:true, text:'Average Spread'} }, x:{ title:{display:true, text:'Season'} } } } });
    }

    function updateAvgTotalsTrendChart(){
      const bucket={}; filteredData.forEach(r=>{ if(r.Season && r.OverUnder!=null){ (bucket[r.Season] ||= []).push(r.OverUnder); }});
      const data=Object.entries(bucket).sort(([a],[b])=>a-b).map(([s,arr])=>({s, v: arr.reduce((x,y)=>x+y,0)/arr.length }));
      const ctx=document.getElementById('avgTotalsTrendChart'); if(!ctx||!data.length) return; destroy('avgTotalsTrendChart');
      charts.avgTotalsTrendChart=new Chart(ctx.getContext('2d'),{ type:'line', data:{ labels:data.map(d=>d.s), datasets:[{ label:'Average Total', data:data.map(d=>d.v), borderColor:'#00cec9', backgroundColor:'rgba(0,206,201,.1)', borderWidth:3, fill:true }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, title:{display:true, text:'Average Total'} }, x:{ title:{display:true, text:'Season'} } } } });
    }

    function updateVolumeTrendChart(){
      const counts={}; filteredData.forEach(r=>{ if(r.Season) counts[r.Season]=(counts[r.Season]||0)+1; });
      const data=Object.entries(counts).sort(([a],[b])=>a-b);
      const ctx=document.getElementById('volumeTrendChart'); if(!ctx||!data.length) return; destroy('volumeTrendChart');
      charts.volumeTrendChart=new Chart(ctx.getContext('2d'),{ type:'bar', data:{ labels:data.map(([s])=>s), datasets:[{ label:'Games', data:data.map(([,c])=>c), backgroundColor:'rgba(108,92,231,.8)', borderColor:'rgba(108,92,231,1)', borderWidth:2 }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, title:{display:true, text:'Number of Games'} }, x:{ title:{display:true, text:'Season'} } } } });
    }

    function updateScoringTrendChart(){
      const bucket={}; filteredData.forEach(r=>{ if(r.Season && r.HomeScore!=null && r.AwayScore!=null){ (bucket[r.Season] ||= {sum:0,g:0}); bucket[r.Season].sum += r.HomeScore + r.AwayScore; bucket[r.Season].g++; }});
      const data=Object.entries(bucket).sort(([a],[b])=>a-b).map(([s,o])=>({s, v:o.sum/o.g}));
      const ctx=document.getElementById('scoringTrendChart'); if(!ctx||!data.length) return; destroy('scoringTrendChart');
      charts.scoringTrendChart=new Chart(ctx.getContext('2d'),{ type:'line', data:{ labels:data.map(d=>d.s), datasets:[{ label:'Average Points Per Game', data:data.map(d=>d.v), borderColor:'#e17055', backgroundColor:'rgba(225,112,85,.1)', borderWidth:3, fill:true }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, title:{display:true, text:'Average Total Points'} }, x:{ title:{display:true, text:'Season'} } } } });
    }

    // ====== Spread Analysis ======
    function updateSpreadAnalysis(){
      const data=filteredData.filter(r=>r.Spread!=null && r.HomeScore!=null && r.AwayScore!=null);
      if(!data.length){
        document.getElementById('spread-stats').innerHTML='<p style="text-align:center">No spread data for current filters</p>';
        destroy('spreadDistChart');
        destroy('homeAwayATSChart');
        destroy('atsSeasonChart');

        const spreadCanvas=document.getElementById('spreadDistChart');
        if(spreadCanvas){
          const ctx=spreadCanvas.getContext('2d');
          if(ctx) ctx.clearRect(0,0,spreadCanvas.width,spreadCanvas.height);
        }
        const homeAwayCanvas=document.getElementById('homeAwayATSChart');
        if(homeAwayCanvas){
          const ctx=homeAwayCanvas.getContext('2d');
          if(ctx) ctx.clearRect(0,0,homeAwayCanvas.width,homeAwayCanvas.height);
        }
        const atsSeasonCanvas=document.getElementById('atsSeasonChart');
        if(atsSeasonCanvas){
          const ctx=atsSeasonCanvas.getContext('2d');
          if(ctx) ctx.clearRect(0,0,atsSeasonCanvas.width,atsSeasonCanvas.height);
        }
        return;
      }

      let homeATS=0, awayATS=0, pushes=0;
      data.forEach(r=>{
        const margin=(r.HomeScore||0)-(r.AwayScore||0);
        const sm = margin + (r.Spread||0);
        if (Math.abs(sm) < 0.5) pushes++;
        else if (sm > 0) homeATS++;
        else awayATS++;
      });
      const total = homeATS+awayATS+pushes;
      const homePct = total ? (homeATS/total*100).toFixed(1) : '0.0';
      const awayPct = total ? (awayATS/total*100).toFixed(1) : '0.0';
      const avgSpread = data.reduce((s,r)=>s+Math.abs(r.Spread||0),0)/data.length;
      const avgMargin = data.reduce((s,r)=>s+Math.abs((r.HomeScore||0)-(r.AwayScore||0)),0)/data.length;
      document.getElementById('spread-stats').innerHTML = `
        <div class="stat-card"><div class="stat-number">${homePct}%</div><div class="stat-label">Home ATS Win Rate</div></div>
        <div class="stat-card"><div class="stat-number">${awayPct}%</div><div class="stat-label">Away ATS Win Rate</div></div>
        <div class="stat-card"><div class="stat-number">${avgSpread.toFixed(1)}</div><div class="stat-label">Average Spread</div></div>
        <div class="stat-card"><div class="stat-number">${avgMargin.toFixed(1)}</div><div class="stat-label">Average Margin</div></div>`;

      updateSpreadDistChart(data);
      updateHomeAwayATSChart(homeATS, awayATS, pushes);
      updateATSSeasonChart(data);
    }

    function updateSpreadDistChart(data){
      const ranges={'0-3':0,'3.5-7':0,'7.5-10':0,'10.5-14':0,'14.5-21':0,'21.5-28':0,'28.5+':0};
      data.forEach(r=>{ const s=Math.abs(r.Spread); if (s<=3) ranges['0-3']++; else if (s<=7) ranges['3.5-7']++; else if (s<=10) ranges['7.5-10']++; else if (s<=14) ranges['10.5-14']++; else if (s<=21) ranges['14.5-21']++; else if (s<=28) ranges['21.5-28']++; else ranges['28.5+']++; });
      const ctx=document.getElementById('spreadDistChart'); if(!ctx) return; destroy('spreadDistChart');
      charts.spreadDistChart=new Chart(ctx.getContext('2d'),{
        type:'bar', data:{ labels:Object.keys(ranges), datasets:[{ label:'Games', data:Object.values(ranges), backgroundColor:'rgba(42,82,152,.8)', borderColor:'rgba(42,82,152,1)', borderWidth:2 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
      });
    }

    function updateHomeAwayATSChart(homeATS, awayATS, pushes){
      const ctx=document.getElementById('homeAwayATSChart'); if(!ctx) return; destroy('homeAwayATSChart');
      charts.homeAwayATSChart=new Chart(ctx.getContext('2d'),{
        type:'pie', data:{ labels:['Home ATS Wins','Away ATS Wins','Pushes'], datasets:[{ data:[homeATS,awayATS,pushes], backgroundColor:['#ff6b35','#f7931e','#ccc'], borderColor:'#fff'}]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
      });
    }

    function updateATSSeasonChart(data){
      const bucket={}; data.forEach(r=>{ const s=r.Season; if(!s) return; const margin=(r.HomeScore||0)-(r.AwayScore||0); const sm = margin + (r.Spread||0); if (sm>0) (bucket[s] ||= {w:0, l:0, p:0}).w++; else if(sm<0) (bucket[s] ||= {w:0, l:0, p:0}).l++; else (bucket[s] ||= {w:0, l:0, p:0}).p++; });
      const labels=Object.keys(bucket).sort();
      const ctx=document.getElementById('atsSeasonChart'); if(!ctx||!labels.length) return; destroy('atsSeasonChart');
      charts.atsSeasonChart=new Chart(ctx.getContext('2d'),{
        type:'bar', data:{
          labels,
          datasets:[
            { label:'ATS Wins', data:labels.map(l=>bucket[l].w), backgroundColor:'rgba(4,180,45,.8)' },
            { label:'ATS Losses', data:labels.map(l=>bucket[l].l), backgroundColor:'rgba(220,53,69,.8)' },
            { label:'Pushes', data:labels.map(l=>bucket[l].p), backgroundColor:'rgba(108,117,125,.8)' },
          ]
        },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } } }
      });
    }

    // ====== Totals Analysis ======
    function updateTotalsAnalysis(){
      const data=filteredData.filter(r=>r.OverUnder!=null && r.HomeScore!=null && r.AwayScore!=null);
      if(!data.length){
        document.getElementById('totals-stats').innerHTML='<p style="text-align:center">No totals data for current filters</p>';
        destroy('totalsDistChart');
        destroy('overUnderChart');
        destroy('scoringTrendChart');
        return;
      }
      let overs=0, unders=0, pushes=0;
      data.forEach(r=>{ const total=(r.HomeScore||0)+(r.AwayScore||0); if (total>r.OverUnder) overs++; else if (total<r.OverUnder) unders++; else pushes++; });
      const total=overs+unders+pushes;
      const overPct=total?(overs/total*100).toFixed(1):'0.0';
      const underPct=total?(unders/total*100).toFixed(1):'0.0';
      const avgTotal=data.reduce((s,r)=>s+(r.OverUnder||0),0)/data.length;
      const avgScored=data.reduce((s,r)=>s+(r.HomeScore||0)+(r.AwayScore||0),0)/data.length;
      document.getElementById('totals-stats').innerHTML=`
        <div class="stat-card"><div class="stat-number">${overPct}%</div><div class="stat-label">Over Rate</div></div>
        <div class="stat-card"><div class="stat-number">${underPct}%</div><div class="stat-label">Under Rate</div></div>
        <div class="stat-card"><div class="stat-number">${avgTotal.toFixed(1)}</div><div class="stat-label">Avg Betting Total</div></div>
        <div class="stat-card"><div class="stat-number">${avgScored.toFixed(1)}</div><div class="stat-label">Avg Actual Total</div></div>`;
      updateTotalsDistChart(data);
      updateOverUnderChart(overs, unders, pushes);
      updateScoringTrendChart();
    }

    function updateTotalsDistChart(data){
      const ranges={'<35':0,'35-50':0,'50-65':0,'65-80':0,'>80':0};
      data.forEach(r=>{ const t=r.OverUnder; if(t<35) ranges['<35']++; else if (t<50) ranges['35-50']++; else if (t<65) ranges['50-65']++; else if (t<80) ranges['65-80']++; else ranges['>80']++; });
      const ctx=document.getElementById('totalsDistChart'); if(!ctx) return; destroy('totalsDistChart');
      charts.totalsDistChart=new Chart(ctx.getContext('2d'),{
        type:'bar', data:{ labels:Object.keys(ranges), datasets:[{ label:'Games', data:Object.values(ranges), backgroundColor:'rgba(0,184,148,.8)', borderColor:'rgba(0,184,148,1)', borderWidth:2 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
      });
    }

    function updateOverUnderChart(overs, unders, pushes){
      const ctx=document.getElementById('overUnderChart'); if(!ctx) return; destroy('overUnderChart');
      charts.overUnderChart=new Chart(ctx.getContext('2d'),{
        type:'pie', data:{ labels:['Overs','Unders','Pushes'], datasets:[{ data:[overs,unders,pushes], backgroundColor:['#ff6b35','#f7931e','#ccc'], borderColor:'#fff'}]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
      });
    }

    // ====== Conference Analysis ======
    function updateConferenceAnalysis(){
      const data=filteredData.filter(r=>r.HomeConference!=null && r.HomeScore!=null && r.AwayScore!=null);
      if(!data.length){
        document.getElementById('conference-stats').innerHTML='<p style="text-align:center">No conference data for current filters</p>';
        destroy('conferenceGamesChart');
        document.getElementById('conferenceTable').innerHTML='';
        return;
      }
      const confStats={};
      data.forEach(r=>{
        const conf=r.HomeConference;
        if (!confStats[conf]) confStats[conf]={games:0, atsWins:0, atsLosses:0, atsPushes:0, overs:0, unders:0, ouPushes:0, totalPoints:0, avgSpread:0, spreadSum:0, overunderSum:0};
        confStats[conf].games++;
        const margin=(r.HomeScore||0)-(r.AwayScore||0);
        const sm = margin + (r.Spread||0);
        if (sm>0) confStats[conf].atsWins++; else if (sm<0) confStats[conf].atsLosses++; else confStats[conf].atsPushes++;
        const total=(r.HomeScore||0)+(r.AwayScore||0);
        if (total>r.OverUnder) confStats[conf].overs++; else if (total<r.OverUnder) confStats[conf].unders++; else confStats[conf].ouPushes++;
        confStats[conf].totalPoints+=total;
        confStats[conf].spreadSum+=Math.abs(r.Spread||0);
      });
      const sortedConfs=Object.keys(confStats).sort((a,b)=>confStats[b].games-confStats[a].games);
      document.getElementById('conference-stats').innerHTML='';
      updateConferenceGamesChart(confStats);
      updateConferenceTable(confStats, sortedConfs);
    }

    function updateConferenceGamesChart(stats){
      const labels=Object.keys(stats);
      const data=labels.map(l=>stats[l].games);
      const ctx=document.getElementById('conferenceGamesChart'); if(!ctx) return; destroy('conferenceGamesChart');
      charts.conferenceGamesChart=new Chart(ctx.getContext('2d'),{
        type:'bar', data:{ labels, datasets:[{ label:'Games', data, backgroundColor:'rgba(255,107,53,.8)', borderColor:'rgba(255,107,53,1)', borderWidth:2 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
      });
    }

    function updateConferenceTable(stats, sortedConfs){
      const tableDiv=document.getElementById('conferenceTable');
      let tableHtml=`<table><thead><tr><th>Conference</th><th>Games</th><th>ATS Win %</th><th>Over %</th><th>Avg Total</th></tr></thead><tbody>`;
      sortedConfs.forEach(c=>{
        const s=stats[c];
        const totalATS=s.atsWins+s.atsLosses+s.atsPushes;
        const atsPct=totalATS? (s.atsWins/totalATS*100).toFixed(1) : '0.0';
        const totalOU=s.overs+s.unders+s.ouPushes;
        const overPct=totalOU?(s.overs/totalOU*100).toFixed(1) : '0.0';
        const avgTotal=(s.totalPoints/s.games).toFixed(1);
        tableHtml+=`<tr><td>${c}</td><td>${s.games}</td><td>${atsPct}%</td><td>${overPct}%</td><td>${avgTotal}</td></tr>`;
      });
      tableHtml+=`</tbody></table>`;
      tableDiv.innerHTML=tableHtml;
    }

    // ====== Team Analysis ======
    function updateTeamAnalysis(){
      const team = document.getElementById('teamSelectAnalysis').value;
      const data = allData.filter(r=>r.HomeTeam_x === team || r.AwayTeam_x === team);
      if(!team || !data.length){
        document.getElementById('team-stats').innerHTML='<p style="text-align:center">Please select a team</p>';
        destroy('teamHomeAwayChart');
        destroy('teamATSSeasonChart');
        destroy('teamSpreadChart');
        destroy('teamTotalsChart');
        destroy('teamScoringChart');
        document.getElementById('teamGamesTable').innerHTML='';
        return;
      }
      const teamStats={games:0, homeWins:0, awayWins:0, homeATS:0, awayATS:0, homeOvers:0, awayOvers:0, totalPointsScored:0, totalPointsAllowed:0};
      const seasonStats={};
      data.forEach(r=>{
        const isHome=r.HomeTeam_x === team;
        const season=r.Season;
        if (!seasonStats[season]) seasonStats[season]={atsWins:0, atsLosses:0, atsPushes:0, games:0};
        seasonStats[season].games++;
        teamStats.games++;
        const myScore=isHome?(r.HomeScore||0):(r.AwayScore||0);
        const oppScore=isHome?(r.AwayScore||0):(r.HomeScore||0);
        teamStats.totalPointsScored+=myScore;
        teamStats.totalPointsAllowed+=oppScore;
        if(myScore > oppScore){ isHome?teamStats.homeWins++:teamStats.awayWins++; }
        if (r.Spread!=null){
          const margin=myScore-oppScore;
          const spreadCover=isHome?margin-Math.abs(r.Spread):margin+Math.abs(r.Spread);
          const atsResult = spreadCover > 0 ? 'win' : spreadCover < 0 ? 'loss' : 'push';
          if(atsResult === 'win'){ isHome?teamStats.homeATS++:teamStats.awayATS++; seasonStats[season].atsWins++; }
          else if (atsResult === 'loss') { seasonStats[season].atsLosses++; }
          else { seasonStats[season].atsPushes++; }
        }
        if (r.OverUnder!=null){
          const total=myScore+oppScore;
          if (total>r.OverUnder){ isHome?teamStats.homeOvers++:teamStats.awayOvers++; }
        }
      });

      const homeGames=data.filter(r=>r.HomeTeam_x===team).length;
      const awayGames=data.filter(r=>r.AwayTeam_x===team).length;
      const homeATS_pct=homeGames? (teamStats.homeATS/homeGames*100).toFixed(1) : '0.0';
      const awayATS_pct=awayGames? (teamStats.awayATS/awayGames*100).toFixed(1) : '0.0';
      const totalATS_games = teamStats.homeATS+teamStats.awayATS+teamStats.games-data.filter(r=>r.Spread==null).length-data.filter(r=>r.Spread!=null && ((r.HomeScore-r.AwayScore)+(isHome?-1:1)*r.Spread==0)).length;
      const totalATS_wins = teamStats.homeATS+teamStats.awayATS;
      const totalATS_pct = totalATS_games ? (totalATS_wins/totalATS_games*100).toFixed(1) : '0.0';

      document.getElementById('team-stats').innerHTML=`
        <div class="stat-card"><div class="stat-number">${teamStats.games}</div><div class="stat-label">Total Games</div></div>
        <div class="stat-card"><div class="stat-number">${(teamStats.totalPointsScored/teamStats.games).toFixed(1)}</div><div class="stat-label">Avg Pts Scored</div></div>
        <div class="stat-card"><div class="stat-number">${totalATS_pct}%</div><div class="stat-label">Overall ATS Win %</div></div>
        <div class="stat-card"><div class="stat-number">${(teamStats.totalPointsScored/(teamStats.totalPointsScored+teamStats.totalPointsAllowed)*100).toFixed(1)}%</div><div class="stat-label">Scoring Share</div></div>`;
      updateTeamHomeAwayChart(teamStats.homeWins, homeGames-teamStats.homeWins, teamStats.awayWins, awayGames-teamStats.awayWins);
      updateTeamATSSeasonChart(seasonStats);
      updateTeamSpreadChart(data, team);
      updateTeamTotalsChart(data, team);
      updateTeamScoringChart(data, team);
      updateTeamGamesTable(data.sort((a,b)=>new Date(b.StartDate)-new Date(a.StartDate)).slice(0,20), team);
    }

    function updateTeamHomeAwayChart(homeWins, homeLosses, awayWins, awayLosses){
      const ctx=document.getElementById('teamHomeAwayChart'); if(!ctx) return; destroy('teamHomeAwayChart');
      charts.teamHomeAwayChart=new Chart(ctx.getContext('2d'),{
        type:'bar', data:{
          labels:['Home','Away'],
          datasets:[
            { label:'Wins', data:[homeWins,awayWins], backgroundColor:'rgba(4,180,45,.8)' },
            { label:'Losses', data:[homeLosses,awayLosses], backgroundColor:'rgba(220,53,69,.8)' }
          ]
        },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } } }
      });
    }

    function updateTeamATSSeasonChart(stats){
      const labels=Object.keys(stats).sort();
      const ctx=document.getElementById('teamATSSeasonChart'); if(!ctx) return; destroy('teamATSSeasonChart');
      charts.teamATSSeasonChart=new Chart(ctx.getContext('2d'),{
        type:'bar', data:{
          labels,
          datasets:[
            { label:'ATS Wins', data:labels.map(l=>stats[l].atsWins), backgroundColor:'rgba(4,180,45,.8)' },
            { label:'ATS Losses', data:labels.map(l=>stats[l].atsLosses), backgroundColor:'rgba(220,53,69,.8)' },
            { label:'Pushes', data:labels.map(l=>stats[l].atsPushes), backgroundColor:'rgba(108,117,125,.8)' }
          ]
        },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } } }
      });
    }

    function updateTeamSpreadChart(data, team){
      const games=data.filter(r=>r.Spread!=null && r.HomeScore!=null && r.AwayScore!=null);
      const labels=games.map(r=>new Date(r.StartDate).toLocaleDateString());
      const spreads=games.map(r=>r.Spread*(r.HomeTeam_x===team?-1:1));
      const margins=games.map(r=>(r.HomeScore-r.AwayScore)*(r.HomeTeam_x===team?1:-1));
      const ctx=document.getElementById('teamSpreadChart'); if(!ctx) return; destroy('teamSpreadChart');
      charts.teamSpreadChart=new Chart(ctx.getContext('2d'),{
        type:'line', data:{
          labels,
          datasets:[
            { label:'Point Spread', data:spreads, borderColor:'#00cec9', fill:false, tension:0.1 },
            { label:'Actual Margin', data:margins, borderColor:'#ff6b35', fill:false, tension:0.1 }
          ]
        },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:false } } }
      });
    }

    function updateTeamTotalsChart(data, team){
      const games=data.filter(r=>r.OverUnder!=null && r.HomeScore!=null && r.AwayScore!=null);
      const labels=games.map(r=>new Date(r.StartDate).toLocaleDateString());
      const overUnders=games.map(r=>r.OverUnder);
      const totals=games.map(r=>r.HomeScore+r.AwayScore);
      const ctx=document.getElementById('teamTotalsChart'); if(!ctx) return; destroy('teamTotalsChart');
      charts.teamTotalsChart=new Chart(ctx.getContext('2d'),{
        type:'line', data:{
          labels,
          datasets:[
            { label:'Over/Under Line', data:overUnders, borderColor:'#00cec9', fill:false, tension:0.1 },
            { label:'Actual Total', data:totals, borderColor:'#ff6b35', fill:false, tension:0.1 }
          ]
        },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:false } } }
      });
    }

    function updateTeamScoringChart(data, team){
      const games=data.filter(r=>r.HomeScore!=null && r.AwayScore!=null);
      const labels=games.map(r=>new Date(r.StartDate).toLocaleDateString());
      const scored=games.map(r=>(r.HomeTeam_x===team)?r.HomeScore:r.AwayScore);
      const allowed=games.map(r=>(r.HomeTeam_x===team)?r.AwayScore:r.HomeScore);
      const ctx=document.getElementById('teamScoringChart'); if(!ctx) return; destroy('teamScoringChart');
      charts.teamScoringChart=new Chart(ctx.getContext('2d'),{
        type:'bar', data:{
          labels,
          datasets:[
            { label:'Points Scored', data:scored, backgroundColor:'rgba(4,180,45,.8)' },
            { label:'Points Allowed', data:allowed, backgroundColor:'rgba(220,53,69,.8)' }
          ]
        },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } } }
      });
    }

    function updateTeamGamesTable(data, team){
      const tableDiv=document.getElementById('teamGamesTable');
      let tableHtml=`<table><thead><tr><th>Date</th><th>Opponent</th><th>Score</th><th>Spread</th><th>Result</th></tr></thead><tbody>`;
      data.forEach(r=>{
        const isHome=r.HomeTeam_x===team;
        const opponent=isHome?r.AwayTeam_x:r.HomeTeam_x;
        const myScore=isHome?r.HomeScore:r.AwayScore;
        const oppScore=isHome?r.AwayScore:r.HomeScore;
        const spread=isHome?(r.Spread||0)*-1:r.Spread||0;
        const result=(myScore>oppScore)?'W':'L';
        const formattedScore=`${myScore} - ${oppScore}`;
        const formattedSpread=spread > 0 ? `+${spread}` : spread;
        tableHtml+=`<tr><td>${new Date(r.StartDate).toLocaleDateString()}</td><td>@${opponent}</td><td>${formattedScore}</td><td>${formattedSpread}</td><td>${result}</td></tr>`;
      });
      tableHtml+=`</tbody></table>`;
      tableDiv.innerHTML=tableHtml;
    }

    // ====== Yearly Analysis ======
    function updateYearAnalysis(){
      const year=document.getElementById('yearSelectAnalysis').value;
      const compareYear=document.getElementById('compareYearSelect').value;
      const yearData=allData.filter(r=>r.Season==year);
      const compareData=compareYear?allData.filter(r=>r.Season==compareYear):[];
      if(!year){
        document.getElementById('year-stats').innerHTML='<p style="text-align:center">Please select a year</p>';
        destroy('yearMonthlyChart');
        destroy('yearConferenceChart');
        destroy('yearWeeklyChart');
        destroy('yearSpreadAccuracyChart');
        destroy('yearScoringDistChart');
        document.getElementById('yearComparisonTable').innerHTML='';
        return;
      }
      const stats=getYearlyStats(yearData);
      document.getElementById('year-stats').innerHTML=`
        <div class="stat-card"><div class="stat-number">${stats.games}</div><div class="stat-label">Total Games</div></div>
        <div class="stat-card"><div class="stat-number">${stats.spreadCoverage}%</div><div class="stat-label">Spread Coverage</div></div>
        <div class="stat-card"><div class="stat-number">${stats.overCoverage}%</div><div class="stat-label">Over/Under Coverage</div></div>
        <div class="stat-card"><div class="stat-number">${stats.atsPct}%</div><div class="stat-label">ATS Win Rate</div></div>
        <div class="stat-card"><div class="stat-number">${stats.overPct}%</div><div class="stat-label">Over Rate</div></div>`;
      updateYearMonthlyChart(year, yearData);
      updateYearConferenceChart(year, yearData);
      updateYearWeeklyChart(year, yearData);
      updateYearSpreadAccuracyChart(year, yearData);
      updateYearScoringDistChart(year, yearData);
      updateYearComparisonTable(year, yearData, compareYear, compareData);
    }

    function getYearlyStats(data){
      const totalGames=data.length;
      const withSpreads=data.filter(r=>r.Spread!=null && r.HomeScore!=null && r.AwayScore!=null);
      const withTotals=data.filter(r=>r.OverUnder!=null && r.HomeScore!=null && r.AwayScore!=null);
      let atsWins=0, atsLosses=0;
      withSpreads.forEach(r=>{ const sm=(r.HomeScore||0)-(r.AwayScore||0)+(r.Spread||0); if(sm>0) atsWins++; else if (sm<0) atsLosses++; });
      let overs=0, unders=0;
      withTotals.forEach(r=>{ const tot=(r.HomeScore||0)+(r.AwayScore||0); if(tot>r.OverUnder) overs++; else if (tot<r.OverUnder) unders++; });
      const atsPct=withSpreads.length? (atsWins/withSpreads.length*100).toFixed(1) : '0.0';
      const overPct=withTotals.length? (overs/withTotals.length*100).toFixed(1) : '0.0';
      return {
        games:totalGames,
        spreadCoverage: totalGames?((withSpreads.length/totalGames)*100).toFixed(1):'0.0',
        overCoverage: totalGames?((withTotals.length/totalGames)*100).toFixed(1):'0.0',
        atsPct,
        overPct
      };
    }

    function updateYearMonthlyChart(year, yearData){
      const months={'Sep':0,'Oct':0,'Nov':0,'Dec':0,'Jan':0};
      yearData.forEach(r=>{ const d=new Date(r.StartDate); const m=d.toLocaleString('default',{month:'short'}); if(months[m]!=null) months[m]++; });
      const ctx=document.getElementById('yearMonthlyChart'); if(!ctx) return; destroy('yearMonthlyChart');
      charts.yearMonthlyChart=new Chart(ctx.getContext('2d'),{
        type:'bar', data:{ labels:Object.keys(months), datasets:[{ label:'Games', data:Object.values(months), backgroundColor:'rgba(42,82,152,.8)', borderColor:'rgba(42,82,152,1)', borderWidth:2 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
      });
    }

    function updateYearConferenceChart(year, yearData){
      const counts={}; yearData.forEach(r=>{ if(r.HomeConference) counts[r.HomeConference]=(counts[r.HomeConference]||0)+1; });
      const labels=Object.keys(counts); const data=Object.values(counts);
      const ctx=document.getElementById('yearConferenceChart'); if(!ctx) return; destroy('yearConferenceChart');
      charts.yearConferenceChart=new Chart(ctx.getContext('2d'),{
        type:'doughnut', data:{ labels, datasets:[{ data, backgroundColor:['#ff6b35','#f7931e','#2a5298','#1e3c72','#00b894','#00cec9','#6c5ce7','#a29bfe']}]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
      });
    }

    function updateYearWeeklyChart(year, yearData){
      const counts={}; yearData.forEach(r=>{ if(r.Week) counts[r.Week]=(counts[r.Week]||0)+1; });
      const labels=Object.keys(counts).sort((a,b)=>a-b);
      const data=labels.map(l=>counts[l]);
      const ctx=document.getElementById('yearWeeklyChart'); if(!ctx) return; destroy('yearWeeklyChart');
      charts.yearWeeklyChart=new Chart(ctx.getContext('2d'),{
        type:'line', data:{ labels, datasets:[{ label:'Games', data, borderColor:'#ff6b35', fill:false, tension:0.1 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, title:{display:true,text:'Number of Games'} }, x:{ title:{display:true, text:'Week'} } } }
      });
    }

    function updateYearSpreadAccuracyChart(year, yearData){
      const games=yearData.filter(r=>r.Spread!=null && r.HomeScore!=null && r.AwayScore!=null);
      const offsets=games.map(r=>Math.abs((r.HomeScore-r.AwayScore) - r.Spread));
      const avgOffset=offsets.length?offsets.reduce((s,o)=>s+o,0)/offsets.length:0;
      const html=`<p style="font-size:1.5em;text-align:center;">Avg Spread Error: <strong>${avgOffset.toFixed(2)}</strong> points</p><div style="text-align:center;font-size:0.9em;color:#555;">Measures how close the spread was to the actual margin of victory. Lower is better.</div>`;
      const chartContainer=document.getElementById('yearSpreadAccuracyChart').parentNode;
      chartContainer.innerHTML=html+'<div class="chart-wrapper"><canvas id="yearSpreadAccuracyChart"></canvas></div>';
      const ctx=document.getElementById('yearSpreadAccuracyChart'); if(!ctx) return; destroy('yearSpreadAccuracyChart');
      const buckets={'<5':0,'5-10':0,'10-15':0,'15-20':0,'20+':0};
      offsets.forEach(o=>{ if(o<5) buckets['<5']++; else if(o<=10) buckets['5-10']++; else if(o<=15) buckets['10-15']++; else if(o<=20) buckets['15-20']++; else buckets['20+']++; });
      charts.yearSpreadAccuracyChart=new Chart(ctx.getContext('2d'),{
        type:'pie', data:{ labels:Object.keys(buckets), datasets:[{ data:Object.values(buckets), backgroundColor:['#ff6b35','#f7931e','#2a5298','#1e3c72','#00b894']}]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
      });
    }

    function updateYearScoringDistChart(year, yearData){
      const buckets={'<35':0,'35-50':0,'50-65':0,'65-80':0,'>80':0};
      yearData.forEach(r=>{ if(r.HomeScore!=null && r.AwayScore!=null){ const tot=r.HomeScore+r.AwayScore; if(tot<35) buckets['<35']++; else if (tot<50) buckets['35-50']++; else if (tot<65) buckets['50-65']++; else if (tot<80) buckets['65-80']++; else buckets['>80']++; } });
      const ctx=document.getElementById('yearScoringDistChart'); if(!ctx) return; destroy('yearScoringDistChart');
      charts.yearScoringDistChart=new Chart(ctx.getContext('2d'),{
        type:'bar', data:{ labels:Object.keys(buckets), datasets:[{ label:'Games', data:Object.values(buckets), backgroundColor:'rgba(0,206,201,.8)', borderColor:'rgba(0,206,201,1)', borderWidth:2 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true }, x:{ title:{ display:true, text:'Total Points' } } } }
      });
    }

    function updateYearComparisonTable(year, yearData, compareYear, compareData){
      const table = `<table><thead><tr><th>Metric</th><th>${year}</th>${compareYear? `<th>${compareYear}</th><th>Difference</th>`:''}</tr></thead><tbody>
        <tr><td>Games Analyzed</td><td>${yearData.length}</td>${compareYear? `<td>${compareData.length}</td><td>${yearData.length-compareData.length}</td>`:''}</tr>
        <tr><td>Avg Spread</td><td>${getStatsMetric(yearData, 'Spread').toFixed(2)}</td>${compareYear? `<td>${getStatsMetric(compareData, 'Spread').toFixed(2)}</td><td>${(getStatsMetric(yearData, 'Spread')-getStatsMetric(compareData, 'Spread')).toFixed(2)}</td>`:''}</tr>
        <tr><td>Avg Total</td><td>${getStatsMetric(yearData, 'OverUnder').toFixed(2)}</td>${compareYear? `<td>${getStatsMetric(compareData, 'OverUnder').toFixed(2)}</td><td>${(getStatsMetric(yearData, 'OverUnder')-getStatsMetric(compareData, 'OverUnder')).toFixed(2)}</td>`:''}</tr>
        <tr><td>Avg Points Per Game</td><td>${getStatsMetric(yearData, 'Points').toFixed(2)}</td>${compareYear? `<td>${getStatsMetric(compareData, 'Points').toFixed(2)}</td><td>${(getStatsMetric(yearData, 'Points')-getStatsMetric(compareData, 'Points')).toFixed(2)}</td>`:''}</tr>
        <tr><td>ATS Win Rate</td><td>${getStatsMetric(yearData, 'ATS').toFixed(1)}%</td>${compareYear? `<td>${getStatsMetric(compareData, 'ATS').toFixed(1)}%</td><td>${(getStatsMetric(yearData, 'ATS')-getStatsMetric(compareData, 'ATS')).toFixed(1)}%</td>`:''}</tr>
        <tr><td>Over Rate</td><td>${getStatsMetric(yearData, 'Over').toFixed(1)}%</td>${compareYear? `<td>${getStatsMetric(compareData, 'Over').toFixed(1)}%</td><td>${(getStatsMetric(yearData, 'Over')-getStatsMetric(compareData, 'Over')).toFixed(1)}%</td>`:''}</tr>
        </tbody></table>`;
      document.getElementById('yearComparisonTable').innerHTML = table;
    }

    function getStatsMetric(data, metric){
      const validData=data.filter(r=>r.HomeScore!=null && r.AwayScore!=null);
      if(!validData.length) return 0;
      if(metric==='Spread'){
        const spreads=validData.filter(r=>r.Spread!=null).map(r=>Math.abs(r.Spread||0));
        return spreads.length?spreads.reduce((s,v)=>s+v,0)/spreads.length:0;
      }
      if(metric==='OverUnder'){
        const totals=validData.filter(r=>r.OverUnder!=null).map(r=>r.OverUnder||0);
        return totals.length?totals.reduce((s,v)=>s+v,0)/totals.length:0;
      }
      if(metric==='Points'){
        const points=validData.map(r=>(r.HomeScore||0)+(r.AwayScore||0));
        return points.reduce((s,v)=>s+v,0)/points.length;
      }
      if(metric==='ATS'){
        const games=validData.filter(r=>r.Spread!=null);
        if(!games.length) return 0;
        const wins=games.filter(r=>((r.HomeScore-r.AwayScore)+(r.Spread||0))>0).length;
        const pushes=games.filter(r=>((r.HomeScore-r.AwayScore)+(r.Spread||0))==0).length;
        return (wins/(games.length-pushes))*100;
      }
      if(metric==='Over'){
        const games=validData.filter(r=>r.OverUnder!=null);
        if(!games.length) return 0;
        const overs=games.filter(r=>((r.HomeScore||0)+(r.AwayScore||0))>r.OverUnder).length;
        const pushes=games.filter(r=>((r.HomeScore||0)+(r.AwayScore||0))==r.OverUnder).length;
        return (overs/(games.length-pushes))*100;
      }
    }
  </script>
</body>
</html>
