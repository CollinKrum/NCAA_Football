<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸˆ NCAAF Betting Analysis Dashboard</title>
  <meta name="description" content="Comprehensive analysis of college football games and betting lines. Interactive charts, spread analysis, and conference breakdowns.">
  <meta property="og:title" content="NCAAF Betting Analysis Dashboard">
  <meta property="og:description" content="Interactive analysis of NCAAF betting lines and results.">
  <meta property="og:type" content="website">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color:#333; min-height:100vh;
    }
    .header {
      background: linear-gradient(90deg, #ff6b35 0%, #f7931e 100%);
      color:#fff; text-align:center; padding:20px;
      box-shadow:0 4px 8px rgba(0,0,0,.2);
    }
    .header h1 { font-size:2.2em; margin-bottom:8px; text-shadow:2px 2px 4px rgba(0,0,0,.3) }
    .header p { opacity:.9 }
    .container { max-width:1200px; margin:0 auto; padding:20px }
    .tabs { display:flex; justify-content:center; gap:8px; margin:20px 0; background:rgba(255,255,255,.1); border-radius:10px; padding:5px; flex-wrap:wrap }
    .tab { background:transparent; border:none; padding:12px 20px; color:#fff; cursor:pointer; border-radius:8px; font-size:15px; transition:.2s; }
    .tab:hover { background:rgba(255,255,255,.2) }
    .tab.active { background: linear-gradient(90deg, #ff6b35, #f7931e); box-shadow:0 4px 8px rgba(0,0,0,.2) }
    .tab-content { display:none }
    .tab-content.active { display:block; animation:fadeIn .35s ease }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none} }
    .filter-section, .analysis-section, .chart-container, .data-table {
      background:rgba(255,255,255,.95); border-radius:15px; padding:20px; margin:20px 0; box-shadow:0 8px 16px rgba(0,0,0,.1);
    }
    .filter-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); gap:15px }
    .filter-item { display:flex; flex-direction:column }
    .filter-item label { font-weight:600; color:#333; margin-bottom:6px }
    select, input { padding:10px; border:2px solid #ddd; border-radius:8px; font-size:14px }
    select:focus, input:focus { outline:none; border-color:#ff6b35 }
    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(240px,1fr)); gap:18px; margin:20px 0 }
    .stat-card { background:linear-gradient(135deg, rgba(255,255,255,.95), rgba(255,255,255,.85)); border-radius:15px; padding:22px; text-align:center; box-shadow:0 8px 16px rgba(0,0,0,.1) }
    .stat-number { font-size:2.2em; font-weight:700; color:#ff6b35; margin-bottom:8px }
    .stat-label { color:#333; font-weight:500 }
    .chart-title { font-size:1.2em; font-weight:600; color:#333; text-align:center; margin-bottom:12px }
    .chart-wrapper { position:relative; height:380px; }
    .two-column { display:grid; grid-template-columns:1fr 1fr; gap:24px }
    .insight-box { background:linear-gradient(90deg, #00b894, #00cec9); color:#fff; padding:12px; border-radius:10px; margin:12px 0 }
    .loading { text-align:center; color:#fff; font-size:1.1em; padding:30px }
    .spinner { border:4px solid rgba(255,255,255,.3); border-top:4px solid #ff6b35; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:16px auto }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .footer { background:rgba(255,255,255,.1); color:#fff; text-align:center; padding:20px; margin-top:30px; border-radius:15px }
    table { width:100%; border-collapse:collapse }
    th, td { padding:12px; text-align:left; border-bottom:1px solid #ddd }
    th { background:#ff6b35; color:#fff; font-weight:600 }
    tr:hover { background:rgba(255,107,53,.1) }
    @media (max-width: 900px) { .two-column{ grid-template-columns:1fr } .header h1{ font-size:1.8em } }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸˆ NCAAF Betting Analysis Dashboard</h1>
    <p>Comprehensive Analysis of College Football Games & Betting Lines</p>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab active" data-tab="overview">ğŸ“Š Overview</button>
      <button class="tab" data-tab="spreads">ğŸ“ˆ Spread Analysis</button>
      <button class="tab" data-tab="totals">ğŸ¯ Over/Under Analysis</button>
      <button class="tab" data-tab="trends">ğŸ“… Historical Trends</button>
      <button class="tab" data-tab="conferences">ğŸŸï¸ Conference Analysis</button>
      <button class="tab" data-tab="teams">ğŸˆ Team Analysis</button>
      <button class="tab" data-tab="yearly">ğŸ“… Year-by-Year Analysis</button>
    </div>

    <div id="loading" class="loading">
      <h2>ğŸˆ Loading NCAAF Data...</h2>
      <div class="spinner"></div>
      <p>Processing games and betting lines...</p>
    </div>

    <div id="overview" class="tab-content">
      <div class="filter-section">
        <h3>ğŸ›ï¸ Data Filters</h3>
        <div class="filter-grid">
          <div class="filter-item"><label for="seasonFilter">Season:</label><select id="seasonFilter" onchange="updateAnalysis()"><option value="all">All Seasons</option></select></div>
          <div class="filter-item"><label for="providerFilter">Sportsbook:</label><select id="providerFilter" onchange="updateAnalysis()"><option value="all">All Providers</option></select></div>
          <div class="filter-item"><label for="conferenceFilter">Conference:</label><select id="conferenceFilter" onchange="updateAnalysis()"><option value="all">All Conferences</option></select></div>
          <div class="filter-item"><label for="weekFilter">Week:</label><select id="weekFilter" onchange="updateAnalysis()"><option value="all">All Weeks</option></select></div>
          <div class="filter-item"><label for="teamFilter">Team:</label><select id="teamFilter" onchange="updateAnalysis()"><option value="all">All Teams</option></select></div>
          <div class="filter-item"><label for="conferenceYearFilter">Conference by Year:</label><select id="conferenceYearFilter" onchange="updateAnalysis()"><option value="all">All Conference-Years</option></select></div>
        </div>
      </div>
      <div id="overview-stats" class="stats-grid"></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">ğŸ“ˆ Games by Season</div><div class="chart-wrapper"><canvas id="seasonChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">ğŸ¢ Sportsbook Coverage</div><div class="chart-wrapper"><canvas id="providerChart"></canvas></div></div>
      </div>
    </div>

    <div id="spreads" class="tab-content">
      <div class="analysis-section"><h2>ğŸ“ˆ Point Spread Analysis</h2><div class="insight-box"><strong>Key Insights:</strong> Point spreads reflect the expected margin of victory. Analyzing spread performance helps identify betting value and market inefficiencies.</div></div>
      <div id="spread-stats" class="stats-grid"></div>
      <div class="chart-container"><div class="chart-title">ğŸ“Š Spread Distribution</div><div class="chart-wrapper"><canvas id="spreadDistChart"></canvas></div></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">ğŸ  Home vs Away ATS Performance</div><div class="chart-wrapper"><canvas id="homeAwayATSChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">ğŸ“ˆ ATS Performance by Season</div><div class="chart-wrapper"><canvas id="atsSeasonChart"></canvas></div></div>
      </div>
    </div>

    <div id="totals" class="tab-content">
      <div class="analysis-section"><h2>ğŸ¯ Over/Under Analysis</h2><div class="insight-box"><strong>Key Insights:</strong> Total points analysis reveals scoring trends and helps identify betting opportunities.</div></div>
      <div id="totals-stats" class="stats-grid"></div>
      <div class="chart-container"><div class="chart-title">ğŸ“Š Total Points Distribution</div><div class="chart-wrapper"><canvas id="totalsDistChart"></canvas></div></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">â¬†ï¸ Over/Under Performance</div><div class="chart-wrapper"><canvas id="overUnderChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">ğŸ“ˆ Scoring Trends by Season</div><div class="chart-wrapper"><canvas id="scoringTrendChart"></canvas></div></div>
      </div>
    </div>

    <div id="trends" class="tab-content">
      <div class="analysis-section"><h2>ğŸ“… Historical Trends</h2><div class="insight-box"><strong>Key Insights:</strong> Historical trends reveal how betting markets evolved over time.</div></div>
      <div class="chart-container"><div class="chart-title">ğŸ“ˆ Average Spreads by Season</div><div class="chart-wrapper"><canvas id="avgSpreadTrendChart"></canvas></div></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">ğŸ¯ Average Totals Trend</div><div class="chart-wrapper"><canvas id="avgTotalsTrendChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">ğŸ“Š Market Volume Trends</div><div class="chart-wrapper"><canvas id="volumeTrendChart"></canvas></div></div>
      </div>
    </div>

    <div id="conferences" class="tab-content">
      <div class="analysis-section"><h2>ğŸŸï¸ Conference Analysis</h2><div class="insight-box"><strong>Key Insights:</strong> Conferences differ in scoring, competitiveness, and betting patterns.</div></div>
      <div id="conference-stats" class="stats-grid"></div>
      <div class="chart-container"><div class="chart-title">ğŸŸï¸ Games by Conference</div><div class="chart-wrapper"><canvas id="conferenceGamesChart"></canvas></div></div>
      <div class="data-table"><h3>ğŸ“Š Conference Performance Table</h3><div id="conferenceTable"></div></div>
    </div>

    <div id="teams" class="tab-content">
      <div class="analysis-section">
        <h2>ğŸˆ Individual Team Analysis</h2>
        <div class="insight-box"><strong>Key Insights:</strong> Deep-dive into ATS, totals, home/away splits, and trends.</div>
        <div class="filter-grid" style="margin: 20px 0;">
          <div class="filter-item"><label for="teamSelectAnalysis">Select Team for Deep Analysis:</label><select id="teamSelectAnalysis" onchange="updateTeamAnalysis()"><option value="">Choose a Team...</option></select></div>
        </div>
      </div>
      <div id="team-stats" class="stats-grid"></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">ğŸ  Home vs Away Performance</div><div class="chart-wrapper"><canvas id="teamHomeAwayChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">ğŸ“ˆ Season-by-Season ATS Record</div><div class="chart-wrapper"><canvas id="teamATSSeasonChart"></canvas></div></div>
      </div>
      <div class="chart-container"><div class="chart-title">â­ Team Performance vs Spreads</div><div class="chart-wrapper"><canvas id="teamSpreadChart"></canvas></div></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">ğŸ¯ Over/Under Performance</div><div class="chart-wrapper"><canvas id="teamTotalsChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">ğŸ“Š Points Per Game Trends</div><div class="chart-wrapper"><canvas id="teamScoringChart"></canvas></div></div>
      </div>
      <div class="data-table"><h3>ğŸˆ Recent Games</h3><div id="teamGamesTable"></div></div>
    </div>

    <div id="yearly" class="tab-content">
      <div class="analysis-section">
        <h2>ğŸ“… Year-by-Year Analysis</h2>
        <div class="insight-box"><strong>Key Insights:</strong> Compare betting market performance across seasons.</div>
        <div class="filter-grid" style="margin: 20px 0;">
          <div class="filter-item"><label for="yearSelectAnalysis">Select Season for Deep Analysis:</label><select id="yearSelectAnalysis" onchange="updateYearAnalysis()"><option value="">Choose a Season...</option></select></div>
          <div class="filter-item"><label for="compareYearSelect">Compare with Season:</label><select id="compareYearSelect" onchange="updateYearAnalysis()"><option value="">No Comparison</option></select></div>
        </div>
      </div>
      <div id="year-stats" class="stats-grid"></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">ğŸ“Š Monthly Game Distribution</div><div class="chart-wrapper"><canvas id="yearMonthlyChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">ğŸŸï¸ Conference Breakdown</div><div class="chart-wrapper"><canvas id="yearConferenceChart"></canvas></div></div>
      </div>
      <div class="chart-container"><div class="chart-title">ğŸ“ˆ Weekly Performance Trends</div><div class="chart-wrapper"><canvas id="yearWeeklyChart"></canvas></div></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">ğŸ¯ Spread Accuracy</div><div class="chart-wrapper"><canvas id="yearSpreadAccuracyChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">ğŸ“Š Scoring Distribution</div><div class="chart-wrapper"><canvas id="yearScoringDistChart"></canvas></div></div>
      </div>
      <div class="data-table"><h3>ğŸ“ˆ Season Comparison Table</h3><div id="yearComparisonTable"></div></div>
    </div>
  </div>

  <div class="footer">
    <p>ğŸˆ NCAAF Betting Analysis Dashboard | Data covers multiple seasons</p>
    <p>Built with Chart.js | Optimized for mobile and desktop</p>
  </div>

  <script>
    // ====== Global state ======
    let allData = [];
    let filteredData = [];
    let charts = {};

    // ====== Tabs ======
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(tabName)?.classList.add('active');
      document.querySelector('[data-tab="'+tabName+'"]')?.classList.add('active');
    }
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', () => showTab(tab.getAttribute('data-tab'))));
      loadData();
    });

    // ====== Data load (JSON file in repo) ======
    async function loadData() {
      try {
        const resp = await fetch('data/ncaaf-games.json', { cache: 'no-store' });
        if (!resp.ok) throw new Error('data/ncaaf-games.json not found');
        const json = await resp.json();
        allData = json;
        filteredData = allData;

        initializeFilters();
        updateAnalysis();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('overview').classList.add('active');
      } catch (e) {
        showError('Failed to load data: ' + e.message + '<br><br>Make sure your JSON exists at <code>data/ncaaf-games.json</code>.');
      }
    }

    function showError(message) {
      const el = document.getElementById('loading');
      if (el) el.innerHTML = '<div class="error"><h2>âŒ Error Loading Data</h2><p>'+message+'</p></div>';
    }

    // ====== Filters ======
    function initializeFilters() {
      // Seasons
      const seasons = [...new Set(allData.map(r => r.Season))].filter(Boolean).sort((a,b)=>a-b);
      const seasonSel = document.getElementById('seasonFilter');
      seasons.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; seasonSel.appendChild(o); });

      // Year analysis dropdowns
      const yearSel = document.getElementById('yearSelectAnalysis');
      const compareSel = document.getElementById('compareYearSelect');
      seasons.forEach(s => {
        const o1=document.createElement('option'); o1.value=s; o1.textContent=s; yearSel.appendChild(o1);
        const o2=document.createElement('option'); o2.value=s; o2.textContent=s; compareSel.appendChild(o2);
      });

      // Providers
      const providers = [...new Set(allData.map(r => r.LineProvider))].filter(Boolean).sort();
      const providerSel = document.getElementById('providerFilter');
      providers.forEach(p => { const o=document.createElement('option'); o.value=p; o.textContent=p; providerSel.appendChild(o); });

      // Conferences
      const conferences = [...new Set(allData.map(r => r.HomeConference))].filter(Boolean).sort();
      const confSel = document.getElementById('conferenceFilter');
      conferences.forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; confSel.appendChild(o); });

      // Weeks
      const weeks = [...new Set(allData.map(r => r.Week))].filter(Boolean).sort((a,b)=>a-b);
      const weekSel = document.getElementById('weekFilter');
      weeks.forEach(w => { const o=document.createElement('option'); o.value=w; o.textContent='Week '+w; weekSel.appendChild(o); });

      // Teams
      const teams = [...new Set([...allData.map(r=>r.HomeTeam_x), ...allData.map(r=>r.AwayTeam_x)])].filter(Boolean).sort();
      const teamSel = document.getElementById('teamFilter');
      const teamSelAnalysis = document.getElementById('teamSelectAnalysis');
      teams.forEach(t => {
        const o=document.createElement('option'); o.value=t; o.textContent=t; teamSel.appendChild(o);
        const o2=document.createElement('option'); o2.value=t; o2.textContent=t; teamSelAnalysis.appendChild(o2);
      });

      // Conference-Year
      const confYears = new Set();
      allData.forEach(r => {
        if (r.HomeConference && r.Season) confYears.add(r.HomeConference+' '+r.Season);
        if (r.AwayConference && r.Season) confYears.add(r.AwayConference+' '+r.Season);
      });
      const cySel = document.getElementById('conferenceYearFilter');
      [...confYears].sort().forEach(cy => { const o=document.createElement('option'); o.value=cy; o.textContent=cy; cySel.appendChild(o); });
    }

    function applyFilters() {
      const s = document.getElementById('seasonFilter')?.value || 'all';
      const p = document.getElementById('providerFilter')?.value || 'all';
      const c = document.getElementById('conferenceFilter')?.value || 'all';
      const w = document.getElementById('weekFilter')?.value || 'all';
      const t = document.getElementById('teamFilter')?.value || 'all';
      const cy = document.getElementById('conferenceYearFilter')?.value || 'all';

      filteredData = allData.filter(r => {
        if (s !== 'all' && r.Season != s) return false;
        if (p !== 'all' && r.LineProvider !== p) return false;
        if (c !== 'all' && r.HomeConference !== c && r.AwayConference !== c) return false;
        if (w !== 'all' && r.Week != w) return false;
        if (t !== 'all' && r.HomeTeam_x !== t && r.AwayTeam_x !== t) return false;
        if (cy !== 'all') {
          const [confName, confYear] = cy.split(' ');
          const homeOK = r.HomeConference === confName && r.Season == confYear;
          const awayOK = r.AwayConference === confName && r.Season == confYear;
          if (!homeOK && !awayOK) return false;
        }
        return true;
      });
    }

    // ====== Top-level update ======
    function updateAnalysis() {
      applyFilters();
      updateOverviewStats();
      updateCharts();
      updateSpreadAnalysis();
      updateTotalsAnalysis();
      updateConferenceAnalysis();
      updateHistoricalTrends();
    }

    // ====== Overview KPIs ======
    function updateOverviewStats() {
      const totalGames = filteredData.length;
      const withSpreads = filteredData.filter(r => r.Spread != null).length;
      const withTotals = filteredData.filter(r => r.OverUnder != null).length;
      const avgSpread = withSpreads ? filteredData.filter(r=>r.Spread!=null).reduce((s,r)=>s+Math.abs(r.Spread||0),0)/withSpreads : 0;
      const avgTotal = withTotals ? filteredData.filter(r=>r.OverUnder!=null).reduce((s,r)=>s+(r.OverUnder||0),0)/withTotals : 0;

      const html = `
        <div class="stat-card"><div class="stat-number">${totalGames.toLocaleString()}</div><div class="stat-label">Total Games</div></div>
        <div class="stat-card"><div class="stat-number">${totalGames?((withSpreads/totalGames)*100).toFixed(1):'0.0'}%</div><div class="stat-label">Spread Coverage</div></div>
        <div class="stat-card"><div class="stat-number">${avgSpread?avgSpread.toFixed(1):'N/A'}</div><div class="stat-label">Avg Spread</div></div>
        <div class="stat-card"><div class="stat-number">${avgTotal?avgTotal.toFixed(1):'N/A'}</div><div class="stat-label">Avg Total</div></div>`;
      document.getElementById('overview-stats').innerHTML = html;
    }

    // ====== Charts (Overview/Trends) ======
    function destroy(name){ if(charts[name]){ charts[name].destroy(); charts[name]=null; }}

    function updateCharts(){ updateSeasonChart(); updateProviderChart(); }
    function updateHistoricalTrends(){ updateAvgSpreadTrendChart(); updateAvgTotalsTrendChart(); updateVolumeTrendChart(); updateScoringTrendChart(); }

    function updateSeasonChart(){
      const counts={}; filteredData.forEach(r=>{ if(r.Season) counts[r.Season]=(counts[r.Season]||0)+1; });
      const ctx=document.getElementById('seasonChart'); if(!ctx) return; destroy('seasonChart');
      charts.seasonChart = new Chart(ctx.getContext('2d'), {
        type:'bar', data:{ labels:Object.keys(counts).sort(), datasets:[{ label:'Games', data:Object.values(counts), backgroundColor:'rgba(255,107,53,.8)', borderColor:'rgba(255,107,53,1)', borderWidth:2 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
      });
    }

    function updateProviderChart(){
      const counts={}; filteredData.forEach(r=>{ if(r.LineProvider) counts[r.LineProvider]=(counts[r.LineProvider]||0)+1; });
      const sorted=Object.entries(counts).sort(([,a],[,b])=>b-a).slice(0,8);
      const ctx=document.getElementById('providerChart'); if(!ctx) return; destroy('providerChart');
      charts.providerChart=new Chart(ctx.getContext('2d'),{
        type:'doughnut', data:{ labels:sorted.map(([n])=>n), datasets:[{ data:sorted.map(([,c])=>c), backgroundColor:['#ff6b35','#f7931e','#2a5298','#1e3c72','#00b894','#00cec9','#6c5ce7','#a29bfe']}]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
      });
    }

    function updateAvgSpreadTrendChart(){
      const bucket={}; filteredData.forEach(r=>{ if(r.Season && r.Spread!=null){ (bucket[r.Season] ||= []).push(Math.abs(r.Spread)); }});
      const data=Object.entries(bucket).sort(([a],[b])=>a-b).map(([s,arr])=>({s, v: arr.reduce((x,y)=>x+y,0)/arr.length }));
      const ctx=document.getElementById('avgSpreadTrendChart'); if(!ctx||!data.length) return; destroy('avgSpreadTrendChart');
      charts.avgSpreadTrendChart=new Chart(ctx.getContext('2d'),{ type:'line', data:{ labels:data.map(d=>d.s), datasets:[{ label:'Average Spread', data:data.map(d=>d.v), borderColor:'#ff6b35', backgroundColor:'rgba(255,107,53,.1)', borderWidth:3, fill:true }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, title:{display:true, text:'Average Spread'} }, x:{ title:{display:true, text:'Season'} } } } });
    }

    function updateAvgTotalsTrendChart(){
      const bucket={}; filteredData.forEach(r=>{ if(r.Season && r.OverUnder!=null){ (bucket[r.Season] ||= []).push(r.OverUnder); }});
      const data=Object.entries(bucket).sort(([a],[b])=>a-b).map(([s,arr])=>({s, v: arr.reduce((x,y)=>x+y,0)/arr.length }));
      const ctx=document.getElementById('avgTotalsTrendChart'); if(!ctx||!data.length) return; destroy('avgTotalsTrendChart');
      charts.avgTotalsTrendChart=new Chart(ctx.getContext('2d'),{ type:'line', data:{ labels:data.map(d=>d.s), datasets:[{ label:'Average Total', data:data.map(d=>d.v), borderColor:'#00cec9', backgroundColor:'rgba(0,206,201,.1)', borderWidth:3, fill:true }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, title:{display:true, text:'Average Total'} }, x:{ title:{display:true, text:'Season'} } } } });
    }

    function updateVolumeTrendChart(){
      const counts={}; filteredData.forEach(r=>{ if(r.Season) counts[r.Season]=(counts[r.Season]||0)+1; });
      const data=Object.entries(counts).sort(([a],[b])=>a-b);
      const ctx=document.getElementById('volumeTrendChart'); if(!ctx||!data.length) return; destroy('volumeTrendChart');
      charts.volumeTrendChart=new Chart(ctx.getContext('2d'),{ type:'bar', data:{ labels:data.map(([s])=>s), datasets:[{ label:'Games', data:data.map(([,c])=>c), backgroundColor:'rgba(108,92,231,.8)', borderColor:'rgba(108,92,231,1)', borderWidth:2 }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, title:{display:true, text:'Number of Games'} }, x:{ title:{display:true, text:'Season'} } } } });
    }

    function updateScoringTrendChart(){
      const bucket={}; filteredData.forEach(r=>{ if(r.Season && r.HomeScore!=null && r.AwayScore!=null){ (bucket[r.Season] ||= {sum:0,g:0}); bucket[r.Season].sum += r.HomeScore + r.AwayScore; bucket[r.Season].g++; }});
      const data=Object.entries(bucket).sort(([a],[b])=>a-b).map(([s,o])=>({s, v:o.sum/o.g}));
      const ctx=document.getElementById('scoringTrendChart'); if(!ctx||!data.length) return; destroy('scoringTrendChart');
      charts.scoringTrendChart=new Chart(ctx.getContext('2d'),{ type:'line', data:{ labels:data.map(d=>d.s), datasets:[{ label:'Average Points Per Game', data:data.map(d=>d.v), borderColor:'#e17055', backgroundColor:'rgba(225,112,85,.1)', borderWidth:3, fill:true }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, title:{display:true, text:'Average Total Points'} }, x:{ title:{display:true, text:'Season'} } } } });
    }

    // ====== Spread Analysis ======
    function updateSpreadAnalysis(){
      const data=filteredData.filter(r=>r.Spread!=null && r.HomeScore!=null && r.AwayScore!=null);
      if(!data.length){
        document.getElementById('spread-stats').innerHTML='<p style="text-align:center">No spread data for current filters</p>';
        destroy('spreadDistChart');
        destroy('homeAwayATSChart');
        destroy('atsSeasonChart');

        const spreadCanvas=document.getElementById('spreadDistChart');
        if(spreadCanvas){
          const ctx=spreadCanvas.getContext('2d');
          if(ctx) ctx.clearRect(0,0,spreadCanvas.width,spreadCanvas.height);
        }
        const homeAwayCanvas=document.getElementById('homeAwayATSChart');
        if(homeAwayCanvas){
          const ctx=homeAwayCanvas.getContext('2d');
          if(ctx) ctx.clearRect(0,0,homeAwayCanvas.width,homeAwayCanvas.height);
        }
        const atsSeasonCanvas=document.getElementById('atsSeasonChart');
        if(atsSeasonCanvas){
          const ctx=atsSeasonCanvas.getContext('2d');
          if(ctx) ctx.clearRect(0,0,atsSeasonCanvas.width,atsSeasonCanvas.height);
        }
        return;
      }

      let homeATS=0, awayATS=0, pushes=0;
      data.forEach(r=>{
        const margin=(r.HomeScore||0)-(r.AwayScore||0);
        const sm = margin + (r.Spread||0);
        if (Math.abs(sm) < 0.5) pushes++;
        else if (sm > 0) homeATS++;
        else awayATS++;
      });
      const total = homeATS+awayATS+pushes;
      const homePct = total ? (homeATS/total*100).toFixed(1) : '0.0';
      const awayPct = total ? (awayATS/total*100).toFixed(1) : '0.0';
      const avgSpread = data.reduce((s,r)=>s+Math.abs(r.Spread||0),0)/data.length;
      const avgMargin = data.reduce((s,r)=>s+Math.abs((r.HomeScore||0)-(r.AwayScore||0)),0)/data.length;
      document.getElementById('spread-stats').innerHTML = `
        <div class="stat-card"><div class="stat-number">${homePct}%</div><div class="stat-label">Home ATS Win Rate</div></div>
        <div class="stat-card"><div class="stat-number">${awayPct}%</div><div class="stat-label">Away ATS Win Rate</div></div>
        <div class="stat-card"><div class="stat-number">${avgSpread.toFixed(1)}</div><div class="stat-label">Average Spread</div></div>
        <div class="stat-card"><div class="stat-number">${avgMargin.toFixed(1)}</div><div class="stat-label">Average Margin</div></div>`;
      updateSpreadDistChart(data);
      updateHomeAwayATSChart(homeATS, awayATS, pushes);
      updateATSSeasonChart(data);
    }

    function updateSpreadDistChart(data){
      const ranges={'0-3':0,'3.5-7':0,'7.5-10':0,'10.5-14':0,'14.5-21':0,'21.5-28':0,'28.5+':0};
      data.forEach(r=>{ const s=Math.abs(r.Spread); if (s<=3) ranges['0-3']++; else if (s<=7) ranges['3.5-7']++; else if (s<=10) ranges['7.5-10']++; else if (s<=14) ranges['10.5-14']++; else if (s<=21) ranges['14.5-21']++; else if (s<=28) ranges['21.5-28']++; else ranges['28.5+']++; });
      const ctx=document.getElementById('spreadDistChart'); if(!ctx) return; destroy('spreadDistChart');
      charts.spreadDistChart=new Chart(ctx.getContext('2d'),{
        type:'bar', data:{ labels:Object.keys(ranges), datasets:[{ label:'Games', data:Object.values(ranges), backgroundColor:'rgba(42,82,152,.8)', borderColor:'rgba(42,82,152,1)', borderWidth:2 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
      });
    }

    function updateHomeAwayATSChart(homeATS, awayATS, pushes){
      const ctx=document.getElementById('homeAwayATSChart'); if(!ctx) return; destroy('homeAwayATSChart');
      charts.homeAwayATSChart=new Chart(ctx.getContext('2d'),{
        type:'pie', data:{ labels:['Home ATS Wins','Away ATS Wins','Pushes'], datasets:[{ data:[homeATS,awayATS,pushes], backgroundColor:['#00b894','#ff6b35','#ddd'] }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
      });
    }

    function updateATSSeasonChart(data){
      const seasonData={}; data.forEach(r=>{ const season=r.Season; if(!seasonData[season]){ seasonData[season]={home:0,away:0,pushes:0,total:0}; } const margin=(r.HomeScore||0)-(r.AwayScore||0); const sm=margin+(r.Spread||0); if(Math.abs(sm)<0.5) seasonData[season].pushes++; else if(sm>0) seasonData[season].home++; else seasonData[season].away++; seasonData[season].total++; });
      const seasons=Object.keys(seasonData).sort(); const homePercs=seasons.map(s=> (seasonData[s].home/seasonData[s].total*100).toFixed(1) ); const awayPercs=seasons.map(s=> (seasonData[s].away/seasonData[s].total*100).toFixed(1) );
      const ctx=document.getElementById('atsSeasonChart'); if(!ctx) return; destroy('atsSeasonChart');
      charts.atsSeasonChart=new Chart(ctx.getContext('2d'),{
        type:'line', data:{ labels:seasons, datasets:[{ label:'Home ATS %', data:homePercs, borderColor:'#00b894', backgroundColor:'rgba(0,184,148,.2)', fill:false }, { label:'Away ATS %', data:awayPercs, borderColor:'#ff6b35', backgroundColor:'rgba(255,107,53,.2)', fill:false }]},
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, max:100 } } }
      });
    }

    // ====== Over/Under Analysis ======
    function updateTotalsAnalysis(){
      const data=filteredData.filter(r=>r.OverUnder!=null && r.HomeScore!=null && r.AwayScore!=null);
      if(!data.length){
        document.getElementById('totals-stats').innerHTML='<p style="text-align:center">No totals data for current filters</p>';
        destroy('totalsDistChart');
        destroy('overUnderChart');
        return;
      }
      let overs=0, unders=0, pushes=0;
      data.forEach(r=>{
        const total=r.HomeScore+r.AwayScore;
        const overUnder=r.OverUnder;
        if(total>overUnder) overs++;
        else if(total<overUnder) unders++;
        else pushes++;
      });
      const totalGames=overs+unders+pushes;
      const overPct=totalGames?(overs/totalGames*100).toFixed(1):'0.0';
      const underPct=totalGames?(unders/totalGames*100).toFixed(1):'0.0';
      const avgTotal=data.reduce((s,r)=>s+(r.OverUnder||0),0)/data.length;
      const avgScore=data.reduce((s,r)=>s+(r.HomeScore+r.AwayScore),0)/data.length;
      document.getElementById('totals-stats').innerHTML=`
        <div class="stat-card"><div class="stat-number">${overPct}%</div><div class="stat-label">Over Rate</div></div>
        <div class="stat-card"><div class="stat-number">${underPct}%</div><div class="stat-label">Under Rate</div></div>
        <div class="stat-card"><div class="stat-number">${avgTotal.toFixed(1)}</div><div class="stat-label">Avg Line</div></div>
        <div class="stat-card"><div class="stat-number">${avgScore.toFixed(1)}</div><div class="stat-label">Avg Total Score</div></div>`;
      updateTotalsDistChart(data);
      updateOverUnderChart(overs, unders, pushes);
    }
    function updateTotalsDistChart(data){
      const ranges={'<35':0,'35-50':0,'50-65':0,'65-80':0,'>80':0};
      data.forEach(r=>{ const tot=r.OverUnder; if(tot<35) ranges['<35']++; else if (tot<50) ranges['35-50']++; else if (tot<65) ranges['50-65']++; else if (tot<80) ranges['65-80']++; else ranges['>80']++; });
      const ctx=document.getElementById('totalsDistChart'); if(!ctx) return; destroy('totalsDistChart');
      charts.totalsDistChart=new Chart(ctx.getContext('2d'),{
        type:'bar', data:{ labels:Object.keys(ranges), datasets:[{ label:'Games', data:Object.values(ranges), backgroundColor:'rgba(255,107,53,.8)', borderColor:'rgba(255,107,53,1)', borderWidth:2 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
      });
    }
    function updateOverUnderChart(overs, unders, pushes){
      const ctx=document.getElementById('overUnderChart'); if(!ctx) return; destroy('overUnderChart');
      charts.overUnderChart=new Chart(ctx.getContext('2d'),{
        type:'pie', data:{ labels:['Overs','Unders','Pushes'], datasets:[{ data:[overs,unders,pushes], backgroundColor:['#f7931e','#1e3c72','#ddd'] }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
      });
    }

    // ====== Conference Analysis ======
    function updateConferenceAnalysis(){
      const confStats={};
      filteredData.forEach(r=>{
        const hConf=r.HomeConference; const aConf=r.AwayConference;
        if(hConf) { if(!confStats[hConf]) confStats[hConf]={games:0,wins:0,losses:0,spreads:[],totals:[]}; confStats[hConf].games++; }
        if(aConf) { if(!confStats[aConf]) confStats[aConf]={games:0,wins:0,losses:0,spreads:[],totals:[]}; confStats[aConf].games++; }
        if(r.HomeScore!=null && r.AwayScore!=null){
          if(r.HomeScore>r.AwayScore) { if(hConf) confStats[hConf].wins++; if(aConf) confStats[aConf].losses++; }
          else if(r.HomeScore<r.AwayScore) { if(hConf) confStats[hConf].losses++; if(aConf) confStats[aConf].wins++; }
        }
        if(r.Spread!=null){
          const margin=(r.HomeScore||0)-(r.AwayScore||0);
          const sm = margin+(r.Spread||0);
          if(sm>0) { if(hConf) confStats[hConf].spreads.push(1); if(aConf) confStats[aConf].spreads.push(0); }
          else if(sm<0) { if(hConf) confStats[hConf].spreads.push(0); if(aConf) confStats[aConf].spreads.push(1); }
          else { if(hConf) confStats[hConf].spreads.push(0.5); if(aConf) confStats[aConf].spreads.push(0.5); }
        }
        if(r.OverUnder!=null){
          const total=r.HomeScore+r.AwayScore;
          if(total > r.OverUnder) { if(hConf) confStats[hConf].totals.push(1); if(aConf) confStats[aConf].totals.push(1); }
          else if(total < r.OverUnder) { if(hConf) confStats[hConf].totals.push(0); if(aConf) confStats[aConf].totals.push(0); }
          else { if(hConf) confStats[hConf].totals.push(0.5); if(aConf) confStats[aConf].totals.push(0.5); }
        }
      });

      const confTableData=Object.entries(confStats).map(([conf,data])=>({
        conference:conf, games:data.games,
        winPct: (data.wins/(data.wins+data.losses)*100).toFixed(1),
        atsPct: (data.spreads.reduce((a,b)=>a+b,0)/data.spreads.length*100).toFixed(1),
        overPct: (data.totals.reduce((a,b)=>a+b,0)/data.totals.length*100).toFixed(1)
      })).filter(c=>!isNaN(c.winPct)).sort((a,b)=>b.games-a.games);

      let tableHTML='<table><thead><tr><th>Conference</th><th>Games</th><th>Win %</th><th>ATS %</th><th>Over %</th></tr></thead><tbody>';
      confTableData.forEach(d=>tableHTML+=`<tr><td>${d.conference}</td><td>${d.games}</td><td>${d.winPct}%</td><td>${d.atsPct}%</td><td>${d.overPct}%</td></tr>`);
      tableHTML+='</tbody></table>';
      document.getElementById('conferenceTable').innerHTML=tableHTML;
      updateConferenceCharts(confTableData);
    }
    function updateConferenceCharts(data){
      const sorted=data.sort((a,b)=>b.games-a.games).slice(0,10);
      const ctx=document.getElementById('conferenceGamesChart'); if(!ctx) return; destroy('conferenceGamesChart');
      charts.conferenceGamesChart=new Chart(ctx.getContext('2d'),{
        type:'bar', data:{ labels:sorted.map(d=>d.conference), datasets:[{ label:'Games', data:sorted.map(d=>d.games), backgroundColor:'rgba(42,82,152,.8)', borderColor:'rgba(42,82,152,1)', borderWidth:2 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, title:{ display:true, text:'Games' } }, x:{ title:{ display:true, text:'Conference' } } } }
      });
    }

    // ====== Team Analysis ======
    function updateTeamAnalysis(){
      const team=document.getElementById('teamSelectAnalysis').value;
      if(!team){ document.getElementById('team-stats').innerHTML='<p style="text-align:center">Please select a team</p>'; return; }
      const teamGames=allData.filter(r=>r.HomeTeam_x===team || r.AwayTeam_x===team);
      if(!teamGames.length){ document.getElementById('team-stats').innerHTML='<p style="text-align:center">No data for this team</p>'; return; }

      let homeWins=0, awayWins=0, homeATS=0, awayATS=0, homeTotals=0, awayTotals=0;
      let homeGames=0, awayGames=0, totalPoints=0, totalGames=0;
      teamGames.forEach(r=>{
        const isHome=r.HomeTeam_x===team;
        if(isHome) homeGames++; else awayGames++;
        if(r.HomeScore!=null && r.AwayScore!=null){
          totalGames++;
          totalPoints+=r.HomeScore+r.AwayScore;
          if((isHome && r.HomeScore>r.AwayScore) || (!isHome && r.AwayScore>r.HomeScore)) { if(isHome) homeWins++; else awayWins++; }
          if(r.Spread!=null){
            const sm=(r.HomeScore-r.AwayScore)+(r.Spread||0);
            if((isHome && sm>0) || (!isHome && sm<0)) { if(isHome) homeATS++; else awayATS++; }
          }
          if(r.OverUnder!=null){
            const total=r.HomeScore+r.AwayScore;
            if(total>r.OverUnder) { if(isHome) homeTotals+=1; else awayTotals+=1; }
          }
        }
      });
      const homeWinPct=homeGames?(homeWins/homeGames*100).toFixed(1):'0.0';
      const awayWinPct=awayGames?(awayWins/awayGames*100).toFixed(1):'0.0';
      const homeATSPct=(homeATS/homeGames*100).toFixed(1);
      const awayATSPct=(awayATS/awayGames*100).toFixed(1);
      const overPct=(homeTotals+awayTotals)/(homeGames+awayGames)*100;
      const avgPoints=totalGames? (totalPoints/totalGames).toFixed(1) : 'N/A';

      document.getElementById('team-stats').innerHTML=`
        <div class="stat-card"><div class="stat-number">${homeWinPct}%</div><div class="stat-label">Home Win %</div></div>
        <div class="stat-card"><div class="stat-number">${awayWinPct}%</div><div class="stat-label">Away Win %</div></div>
        <div class="stat-card"><div class="stat-number">${homeATSPct}%</div><div class="stat-label">Home ATS %</div></div>
        <div class="stat-card"><div class="stat-number">${awayATSPct}%</div><div class="stat-label">Away ATS %</div></div>
        <div class="stat-card"><div class="stat-number">${overPct.toFixed(1)}%</div><div class="stat-label">Over Rate</div></div>
        <div class="stat-card"><div class="stat-number">${avgPoints}</div><div class="stat-label">Avg Points/Game</div></div>`;

      updateTeamCharts(teamGames, team);
    }
    function updateTeamCharts(teamGames, teamName){
      updateTeamHomeAwayChart(teamGames, teamName);
      updateTeamATSSeasonChart(teamGames, teamName);
      updateTeamSpreadChart(teamGames, teamName);
      updateTeamTotalsChart(teamGames, teamName);
      updateTeamScoringChart(teamGames, teamName);
      updateTeamGamesTable(teamGames, teamName);
    }
    function updateTeamHomeAwayChart(data, teamName){
      const homeGames=data.filter(r=>r.HomeTeam_x===teamName);
      const awayGames=data.filter(r=>r.AwayTeam_x===teamName);
      const homeWins=homeGames.filter(r=>r.HomeScore>r.AwayScore).length;
      const awayWins=awayGames.filter(r=>r.AwayScore>r.HomeScore).length;
      const ctx=document.getElementById('teamHomeAwayChart'); if(!ctx) return; destroy('teamHomeAwayChart');
      charts.teamHomeAwayChart=new Chart(ctx.getContext('2d'),{ type:'pie', data:{ labels:['Home Wins','Away Wins','Home Losses','Away Losses'], datasets:[{ data:[homeWins,awayWins,homeGames.length-homeWins,awayGames.length-awayWins], backgroundColor:['#00b894','#ff6b35','#2a5298','#1e3c72']}]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } } });
    }
    function updateTeamATSSeasonChart(data, teamName){
      const seasonStats={};
      data.forEach(r=>{
        const season=r.Season; if(!season) return; if(!seasonStats[season]) seasonStats[season]={atsWins:0,total:0};
        const isHome=r.HomeTeam_x===teamName;
        const margin=(r.HomeScore||0)-(r.AwayScore||0); const sm=margin+(r.Spread||0);
        if(Math.abs(sm)>0.5){ seasonStats[season].total++; if((isHome&&sm>0)||(!isHome&&sm<0)) seasonStats[season].atsWins++; }
      });
      const seasons=Object.keys(seasonStats).sort();
      const percs=seasons.map(s=> (seasonStats[s].atsWins/seasonStats[s].total*100).toFixed(1));
      const ctx=document.getElementById('teamATSSeasonChart'); if(!ctx) return; destroy('teamATSSeasonChart');
      charts.teamATSSeasonChart=new Chart(ctx.getContext('2d'),{ type:'line', data:{ labels:seasons, datasets:[{ label:'ATS %', data:percs, borderColor:'#6c5ce7', backgroundColor:'rgba(108,92,231,.2)', fill:false }]}, options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, max:100 } } } });
    }
    function updateTeamSpreadChart(data, teamName){
      const spreads=data.filter(r=>r.Spread!=null).map(r=>{ const isHome=r.HomeTeam_x===teamName; const margin=(r.HomeScore||0)-(r.AwayScore||0); const spread=r.Spread*(isHome?1:-1); const vsSpread=margin-spread; return { spread: -spread, vsSpread }; });
      const ctx=document.getElementById('teamSpreadChart'); if(!ctx) return; destroy('teamSpreadChart');
      charts.teamSpreadChart=new Chart(ctx.getContext('2d'),{ type:'scatter', data:{ datasets:[{ label:'Spread Performance', data:spreads.map(s=>({ x:s.spread, y:s.vsSpread })), backgroundColor:'#ff6b35'}]}, options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{ title:{display:true, text:'Spread'}, ticks:{ callback:v=>v>0?'-'+v:v } }, y:{ title:{display:true, text:'Margin vs Spread'}, beginAtZero:true } } } });
    }
    function updateTeamTotalsChart(data, teamName){
      const totals=data.filter(r=>r.OverUnder!=null);
      const over=totals.filter(r=>r.HomeScore+r.AwayScore>r.OverUnder).length;
      const under=totals.filter(r=>r.HomeScore+r.AwayScore<r.OverUnder).length;
      const push=totals.filter(r=>r.HomeScore+r.AwayScore===r.OverUnder).length;
      const ctx=document.getElementById('teamTotalsChart'); if(!ctx) return; destroy('teamTotalsChart');
      charts.teamTotalsChart=new Chart(ctx.getContext('2d'),{ type:'pie', data:{ labels:['Overs','Unders','Pushes'], datasets:[{ data:[over,under,push], backgroundColor:['#f7931e','#1e3c72','#ddd'] }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } } });
    }
    function updateTeamScoringChart(data, teamName){
      const weeklyScores={}; data.forEach(r=>{ if(r.Season&&r.Week&&r.HomeScore!=null&&r.AwayScore!=null){ const key=r.Season+' Week '+r.Week; const score=r.HomeTeam_x===teamName?r.HomeScore:r.AwayScore; if(!weeklyScores[key]) weeklyScores[key]=[]; weeklyScores[key].push(score); } });
      const labels=Object.keys(weeklyScores).sort((a,b)=>{ const [s1,w1]=a.split(' Week '); const [s2,w2]=b.split(' Week '); if(s1!==s2) return s1-s2; return w1-w2; });
      const avgScores=labels.map(l=>weeklyScores[l].reduce((a,b)=>a+b,0)/weeklyScores[l].length);
      const ctx=document.getElementById('teamScoringChart'); if(!ctx) return; destroy('teamScoringChart');
      charts.teamScoringChart=new Chart(ctx.getContext('2d'),{ type:'line', data:{ labels:labels, datasets:[{ label:'Avg Points', data:avgScores, borderColor:'#00cec9', backgroundColor:'rgba(0,206,201,.2)', fill:false }]}, options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{ ticks:{ maxRotation:90, autoSkip:true } }, y:{ beginAtZero:true } } } });
    }
    function updateTeamGamesTable(data, teamName){
      let tableHTML='<table><thead><tr><th>Date</th><th>Opponent</th><th>Score</th><th>Spread</th><th>Result</th></tr></thead><tbody>';
      data.slice(-20).reverse().forEach(r=>{
        const isHome=r.HomeTeam_x===teamName;
        const opponent=isHome?r.AwayTeam_x:r.HomeTeam_x;
        const score=`${r.HomeScore||'?'}-${r.AwayScore||'?'}`;
        const spread=r.Spread?`${isHome?'':'@ '}${r.FormattedSpread}`:'N/A';
        const result=r.HomeScore!=null && r.AwayScore!=null ? ((isHome && r.HomeScore>r.AwayScore) || (!isHome && r.AwayScore>r.HomeScore) ? 'W' : 'L') : 'N/A';
        tableHTML+=`<tr><td>${r.StartDate?.substring(0,10)}</td><td>${opponent}</td><td>${score}</td><td>${spread}</td><td>${result}</td></tr>`;
      });
      tableHTML+='</tbody></table>';
      document.getElementById('teamGamesTable').innerHTML=tableHTML;
    }

    // ====== Yearly Analysis ======
    function updateYearAnalysis(){
      const year=document.getElementById('yearSelectAnalysis').value;
      const compareYear=document.getElementById('compareYearSelect').value;
      if(!year) return;
      const yearData=allData.filter(r=>r.Season==year);
      const compareData=compareYear?allData.filter(r=>r.Season==compareYear):[];
      
      const stats = calculateYearStats(yearData);
      const compareStats = compareData.length?calculateYearStats(compareData):null;
      
      let html=`
        <div class="stat-card"><div class="stat-number">${stats.games}</div><div class="stat-label">Games</div></div>
        <div class="stat-card"><div class="stat-number">${stats.avgSpread.toFixed(1)}</div><div class="stat-label">Avg Spread</div></div>
        <div class="stat-card"><div class="stat-number">${stats.atsPct.toFixed(1)}%</div><div class="stat-label">ATS Win Rate</div></div>
        <div class="stat-card"><div class="stat-number">${stats.overPct.toFixed(1)}%</div><div class="stat-label">Over Rate</div></div>
        <div class="stat-card"><div class="stat-number">${stats.avgScore.toFixed(1)}</div><div class="stat-label">Avg Points</div></div>
      `;
      document.getElementById('year-stats').innerHTML=html;
      
      updateYearCharts(year, yearData);
      updateYearComparisonTable(year, yearData, compareYear, compareData);
    }
    function calculateYearStats(data){
      const games=data.length;
      const withSpreads=data.filter(r=>r.Spread!=null);
      const withTotals=data.filter(r=>r.OverUnder!=null);
      const withScores=data.filter(r=>r.HomeScore!=null&&r.AwayScore!=null);
      const avgSpread=withSpreads.reduce((s,r)=>s+Math.abs(r.Spread||0),0)/withSpreads.length;
      let atsWins=0, atsTotal=0; withSpreads.forEach(r=>{ const sm=(r.HomeScore-r.AwayScore)+(r.Spread||0); if(Math.abs(sm)<0.5) atsTotal+=0.5; else if(sm>0) atsWins++; atsTotal++; });
      let overs=0, totalsGames=0; withTotals.forEach(r=>{ const tot=r.HomeScore+r.AwayScore; if(tot>r.OverUnder) overs++; if(Math.abs(tot-r.OverUnder)>0) totalsGames++; });
      const avgScore=withScores.reduce((s,r)=>s+r.HomeScore+r.AwayScore,0)/withScores.length;
      return { games, avgSpread, atsPct: (atsWins/withSpreads.length*100), overPct:(overs/totalsGames*100), avgScore };
    }

    function updateYearCharts(year, yearData){
      updateYearMonthlyChart(year, yearData);
      updateYearConferenceChart(year, yearData);
      updateYearWeeklyChart(year, yearData);
      updateYearSpreadAccuracyChart(year, yearData);
      updateYearScoringDistChart(year, yearData);
    }
    function updateYearMonthlyChart(year, yearData){
      const buckets={'Aug':0,'Sep':0,'Oct':0,'Nov':0,'Dec':0,'Jan':0};
      yearData.forEach(r=>{ const d=new Date(r.StartDate); const m=d.toLocaleString('default',{month:'short'}); buckets[m]++; });
      const ctx=document.getElementById('yearMonthlyChart'); if(!ctx) return; destroy('yearMonthlyChart');
      charts.yearMonthlyChart=new Chart(ctx.getContext('2d'),{ type:'bar', data:{ labels:Object.keys(buckets), datasets:[{ label:'Games', data:Object.values(buckets), backgroundColor:'rgba(255,107,53,.8)', borderColor:'rgba(255,107,53,1)', borderWidth:2 }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true }, x:{ title:{display:true, text:'Month'} } } } });
    }
    function updateYearConferenceChart(year, yearData){
      const buckets={}; yearData.forEach(r=>{ if(r.HomeConference) buckets[r.HomeConference]=(buckets[r.HomeConference]||0)+1; });
      const sorted=Object.entries(buckets).sort(([,a],[,b])=>b-a);
      const ctx=document.getElementById('yearConferenceChart'); if(!ctx) return; destroy('yearConferenceChart');
      charts.yearConferenceChart=new Chart(ctx.getContext('2d'),{ type:'doughnut', data:{ labels:sorted.map(([n])=>n), datasets:[{ data:sorted.map(([,c])=>c), backgroundColor:['#ff6b35','#f7931e','#2a5298','#1e3c72','#00b894','#00cec9','#6c5ce7','#a29bfe']}]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } } });
    }
    function updateYearWeeklyChart(year, yearData){
      const buckets={}; yearData.forEach(r=>{ if(r.Week){ buckets[r.Week]=(buckets[r.Week]||0)+1; } });
      const ctx=document.getElementById('yearWeeklyChart'); if(!ctx) return; destroy('yearWeeklyChart');
      charts.yearWeeklyChart=new Chart(ctx.getContext('2d'),{ type:'line', data:{ labels:Object.keys(buckets).sort((a,b)=>a-b), datasets:[{ label:'Games', data:Object.values(buckets), borderColor:'#e17055', backgroundColor:'rgba(225,112,85,.1)', borderWidth:3, fill:true }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, title:{display:true, text:'Number of Games'} }, x:{ title:{display:true, text:'Week'} } } } });
    }
    function updateYearSpreadAccuracyChart(year, yearData){
      const data=yearData.filter(r=>r.Spread!=null && r.HomeScore!=null && r.AwayScore!=null);
      const vsSpread=data.map(r=>Math.abs((r.HomeScore||0)-(r.AwayScore||0)-Math.abs(r.Spread||0)));
      const ctx=document.getElementById('yearSpreadAccuracyChart'); if(!ctx) return; destroy('yearSpreadAccuracyChart');
      charts.yearSpreadAccuracyChart=new Chart(ctx.getContext('2d'),{ type:'scatter', data:{ datasets:[{ label:'Vs Spread Error', data:vsSpread.map((y,i)=>({ x:i, y:y })), backgroundColor:'#2a5298'}]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, title:{display:true, text:'Error (Margin-Spread)'} }, x:{ title:{display:true, text:'Game Index'} } } } });
    }
    function updateYearScoringDistChart(year, yearData){
      const buckets={'<35':0,'35-50':0,'50-65':0,'65-80':0,'>80':0};
      yearData.forEach(r=>{ if(r.HomeScore!=null && r.AwayScore!=null){ const tot=r.HomeScore+r.AwayScore; if(tot<35) buckets['<35']++; else if (tot<50) buckets['35-50']++; else if (tot<65) buckets['50-65']++; else if (tot<80) buckets['65-80']++; else buckets['>80']++; } });
      const ctx=document.getElementById('yearScoringDistChart'); if(!ctx) return; destroy('yearScoringDistChart');
      charts.yearScoringDistChart=new Chart(ctx.getContext('2d'),{ type:'bar', data:{ labels:Object.keys(buckets), datasets:[{ label:'Games', data:Object.values(buckets), backgroundColor:'rgba(0,206,201,.8)', borderColor:'rgba(0,206,201,1)', borderWidth:2 }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true }, x:{ title:{ display:true, text:'Total Points' } } } } });
    }

    function updateYearComparisonTable(year, yearData, compareYear, compareData){
      const table = `<table><thead><tr><th>Metric</th><th>${year}</th>${compareYear? `<th>${compareYear}</th><th>Difference</th>`:''}</tr></thead><tbody>
        <tr><td>Games</td><td>${yearData.length}</td>${compareYear? `<td>${compareData.length}</td><td>${yearData.length-compareData.length}</td>`:''}</tr>
        <tr><td>Avg Spread</td><td>${calculateAvg(yearData, 'Spread').toFixed(1)}</td>${compareYear? `<td>${calculateAvg(compareData, 'Spread').toFixed(1)}</td><td>${(calculateAvg(yearData,'Spread')-calculateAvg(compareData,'Spread')).toFixed(1)}</td>`:''}</tr>
        <tr><td>ATS Win Rate</td><td>${calculateATS(yearData).toFixed(1)}%</td>${compareYear? `<td>${calculateATS(compareData).toFixed(1)}%</td><td>${(calculateATS(yearData)-calculateATS(compareData)).toFixed(1)}%</td>`:''}</tr>
        <tr><td>Avg Total</td><td>${calculateAvg(yearData, 'OverUnder').toFixed(1)}</td>${compareYear? `<td>${calculateAvg(compareData, 'OverUnder').toFixed(1)}</td><td>${(calculateAvg(yearData,'OverUnder')-calculateAvg(compareData,'OverUnder')).toFixed(1)}</td>`:''}</tr>
        <tr><td>Over Rate</td><td>${calculateOver(yearData).toFixed(1)}%</td>${compareYear? `<td>${calculateOver(compareData).toFixed(1)}%</td><td>${(calculateOver(yearData)-calculateOver(compareData)).toFixed(1)}%</td>`:''}</tr>
        <tr><td>Avg Pts/Game</td><td>${calculateAvgPoints(yearData).toFixed(1)}</td>${compareYear? `<td>${calculateAvgPoints(compareData).toFixed(1)}</td><td>${(calculateAvgPoints(yearData)-calculateAvgPoints(compareData)).toFixed(1)}</td>`:''}</tr>
      </tbody></table>`;
      document.getElementById('yearComparisonTable').innerHTML=table;
    }

    function calculateAvg(data, key){
      const filtered=data.filter(r=>r[key]!=null); if(!filtered.length) return 0;
      return filtered.reduce((s,r)=>s+(key==='Spread'?Math.abs(r[key]):r[key]||0),0)/filtered.length;
    }
    function calculateATS(data){
      const filtered=data.filter(r=>r.Spread!=null && r.HomeScore!=null && r.AwayScore!=null); if(!filtered.length) return 0;
      let atsWins=0; filtered.forEach(r=>{ const margin=(r.HomeScore||0)-(r.AwayScore||0); const sm=margin+(r.Spread||0); if(Math.abs(sm)>0.5) atsWins++; });
      return atsWins/filtered.length*100;
    }
    function calculateOver(data){
      const filtered=data.filter(r=>r.OverUnder!=null && r.HomeScore!=null && r.AwayScore!=null); if(!filtered.length) return 0;
      let overs=0; filtered.forEach(r=>{ const total=r.HomeScore+r.AwayScore; if(total>r.OverUnder) overs++; });
      return overs/filtered.length*100;
    }
    function calculateAvgPoints(data){
      const filtered=data.filter(r=>r.HomeScore!=null && r.AwayScore!=null); if(!filtered.length) return 0;
      return filtered.reduce((s,r)=>s+r.HomeScore+r.AwayScore,0)/filtered.length;
    }
  </script>
</body>
</html>
