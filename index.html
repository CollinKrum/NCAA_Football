<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NCAAF Betting Analysis Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body{margin:0;background:#0f2c4d;color:#f6fbff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:14px}
    h1{font-size:22px;margin:0 0 8px}
    .kpi{display:flex;gap:6px;align-items:baseline}
    .kpi .num{font-weight:800;font-size:24px}
    .muted{color:#cfe2ff;font-size:12px}
    .g3{grid-column:span 3}.g6{grid-column:span 6}.g12{grid-column:span 12}
    canvas{width:100%!important;height:320px!important}
    @media(max-width:1000px){.g3,.g6{grid-column:span 12}canvas{height:260px!important}}
    .err{display:none;margin-top:10px;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.4);padding:10px;border-radius:10px;color:#ffd5d5}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>NCAAF Betting Analysis Dashboard</h1>
    <div class="muted" id="sourceInfo"></div>

    <!-- KPIs (IDs kept to match your original expectations) -->
    <section class="row" style="margin-top:10px">
      <div class="card g3"><div class="kpi"><span class="num" id="totalGames">0</span><span>Total Games</span></div><div class="muted" id="homeAwaySplit"></div></div>
      <div class="card g3"><div class="kpi"><span class="num" id="homeATSPct">0%</span><span>Home ATS</span></div><div class="muted" id="spreadRange"></div></div>
      <div class="card g3"><div class="kpi"><span class="num" id="oversPct">0%</span><span>Overs Hit</span></div><div class="muted" id="avgTotal">Totals with result</div></div>
      <div class="card g3"><div class="kpi"><span class="num" id="avgScore">0.0</span><span>Avg Score</span></div><div class="muted">Points per game</div></div>
    </section>

    <!-- Charts -->
    <section class="row" style="margin-top:10px">
      <div class="card g6"><h3 style="margin:0 0 8px">Spread Distribution</h3><canvas id="spreadChart"></canvas></div>
      <div class="card g6"><h3 style="margin:0 0 8px">Monthly Game Counts</h3><canvas id="monthlyChart"></canvas></div>
      <div class="card g12">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <h3 style="margin:0">Team Scoring by Season</h3>
          <div>
            <input id="teamQ" placeholder="Team name (e.g., Alabama)" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:#fff">
            <button id="teamBtn" style="padding:8px 12px;border:none;border-radius:8px;background:#f37024;color:#041625;font-weight:700">Update</button>
          </div>
        </div>
        <canvas id="teamScoringChart"></canvas>
      </div>
    </section>

    <div class="err" id="errBox">Error loading data.</div>
  </div>

  <script>
    // ---- Auto-detect CSV on GitHub Pages (no manual upload) ----
    // We try a list of common relative paths; you already have it in your repo.
    const CANDIDATE_PATHS = [
      'master_NCAAF_Data.csv',
      'data/master_NCAAF_Data.csv',
      'csv/master_NCAAF_Data.csv',
      'ncaaf_master.csv',
      'data/ncaaf_master.csv'
    ];

    const state = { raw: [], rows: [], charts:{ } };

    const toNum = (v) => (v === null || v === undefined || v === '' ? NaN : Number(v));
    function normalizeRow(row) {
      const m = {}; for (const k in row) m[k.toLowerCase().trim()] = row[k];
      return {
        season: (m.season || '').toString().trim(),
        month: (m.month || '').toString().trim(),
        date: (m.date || '').toString().trim(),
        home: (m.home || m.home_team || '').toString().trim(),
        away: (m.away || m.away_team || '').toString().trim(),
        home_score: toNum(m.home_score ?? m.homepoints ?? m.home_pts),
        away_score: toNum(m.away_score ?? m.awaypoints ?? m.away_pts),
        spread: toNum(m.spread ?? m.close_spread),
        total: toNum(m.total ?? m.close_total),
        book: (m.book || m.bookmaker || '').toString().trim(),
        resultats: (m.resultats || m.home_ats || '').toString().trim(),
        resultou: (m.resultou || m.total_result || '').toString().trim(),
      };
    }

    async function parseCSV(text) {
      return new Promise((resolve) => {
        Papa.parse(text, { header: true, dynamicTyping: false, skipEmptyLines: true,
          complete: res => resolve(res.data.map(normalizeRow)) });
      });
    }

    async function fetchFirstWorking() {
      // Prefer same-folder first
      for (const rel of CANDIDATE_PATHS) {
        try {
          const url = new URL(rel, window.location.href).toString();
          const resp = await fetch(url, { cache: 'no-store' });
          if (resp.ok) {
            const text = await resp.text();
            const rows = await parseCSV(text);
            if (rows.length) return { rows, source: url };
          }
        } catch (_) {}
      }
      // Try "raw" path if served from GitHub Pages and user pushed CSV to repo root
      try {
        const { host, pathname } = window.location;
        // e.g. user.github.io/repo/ => owner/repo
        const parts = pathname.split('/').filter(Boolean);
        if (host.endsWith('github.io') && parts.length >= 1) {
          const owner = host.replace('.github.io','');
          const repo = parts[0];
          for (const rel of CANDIDATE_PATHS) {
            const raw = `https://raw.githubusercontent.com/${owner}/${repo}/main/${rel}`;
            const r = await fetch(raw, { cache: 'no-store' });
            if (r.ok) {
              const text = await r.text();
              const rows = await parseCSV(text);
              if (rows.length) return { rows, source: raw };
            }
          }
        }
      } catch (_) {}
      return null;
    }

    function showErr(msg){ const b=document.getElementById('errBox'); b.textContent=msg; b.style.display='block'; }
    function hideErr(){ document.getElementById('errBox').style.display='none'; }

    function updateKPIs() {
      const rows = state.rows;
      const total = rows.length;
      let homeWins=0, awayWins=0, homeATSWins=0, homeATSTotal=0, overs=0, totals=0, pointsSum=0;

      rows.forEach(r => {
        const hs=r.home_score, as=r.away_score;
        if (!Number.isNaN(hs) && !Number.isNaN(as)) {
          pointsSum += (hs+as);
          if (hs>as) homeWins++; else if (as>hs) awayWins++;
        }
        if (r.resultats){ homeATSTotal++; if (r.resultats.toLowerCase().includes('home')) homeATSWins++; }
        if (r.resultou){ totals++; if (r.resultou.toLowerCase().includes('over')) overs++; }
      });

      const avgScore = total ? (pointsSum/total) : 0;
      const homeATSPct = homeATSTotal ? (homeATSWins/homeATSTotal*100) : 0;
      const oversPct = totals ? (overs/totals*100) : 0;

      document.getElementById('totalGames').textContent = total.toLocaleString();
      document.getElementById('homeATSPct').textContent = homeATSPct.toFixed(1)+'%';
      document.getElementById('oversPct').textContent = oversPct.toFixed(1)+'%';
      document.getElementById('avgScore').textContent = avgScore.toFixed(1);
      document.getElementById('homeAwaySplit').textContent = `Home ${homeWins} • Away ${awayWins}`;

      const spreads = rows.map(r=>r.spread).filter(v=>!Number.isNaN(v));
      const min = spreads.length? Math.min(...spreads).toFixed(1):'—';
      const max = spreads.length? Math.max(...spreads).toFixed(1):'—';
      document.getElementById('spreadRange').textContent = `Spread range ${min} to ${max}`;
      document.getElementById('avgTotal').textContent = `${totals} games with totals result`;
    }

    function destroy(name){ if(state.charts[name]){ state.charts[name].destroy(); state.charts[name]=null; }}

    function updateSpreadChart(){
      const el=document.getElementById('spreadChart'); if(!el)return;
      const spreads = state.rows.map(r=>r.spread).filter(v=>!Number.isNaN(v));
      const buckets = new Map();
      spreads.forEach(s=>{ const k=Math.round(s/3)*3; buckets.set(k,(buckets.get(k)||0)+1); });
      const labels = Array.from(buckets.keys()).sort((a,b)=>a-b).map(x=> (x>=0?'+':'')+x);
      const data = labels.map(l=> buckets.get(Number(l))||0);
      destroy('spread');
      state.charts.spread = new Chart(el.getContext('2d'), {
        type:'bar', data:{labels, datasets:[{label:'Games', data, borderWidth:1}]},
        options:{ responsive:true, maintainAspectRatio:false, scales:{x:{grid:{display:false}}, y:{beginAtZero:true}}}
      });
    }

    function updateMonthlyChart(){
      const el=document.getElementById('monthlyChart'); if(!el)return;
      const map=new Map();
      state.rows.forEach(r=>{ if(r.month) map.set(r.month,(map.get(r.month)||0)+1); });
      const labels = Array.from(map.keys()).sort((a,b)=>a.localeCompare(b,undefined,{numeric:true}));
      const data = labels.map(l=>map.get(l));
      destroy('monthly');
      state.charts.monthly = new Chart(el.getContext('2d'), {
        type:'line', data:{labels, datasets:[{label:'Games per month', data, borderWidth:3, tension:.25}]},
        options:{ responsive:true, maintainAspectRatio:false }
      });
    }

    function updateTeamScoringChart(teamName){
      const el=document.getElementById('teamScoringChart'); if(!el)return;
      const q=(teamName||'').trim().toLowerCase(); if(!q){ destroy('team'); return; }
      const bySeason={};
      state.rows.forEach(r=>{
        const isTeam = r.home?.toLowerCase().includes(q) || r.away?.toLowerCase().includes(q);
        if(!isTeam) return;
        const s=r.season||'Unknown'; bySeason[s] ||= {for:0, against:0, g:0};
        if(!Number.isNaN(r.home_score) && !Number.isNaN(r.away_score)){
          if(r.home?.toLowerCase().includes(q)){ bySeason[s].for+=r.home_score; bySeason[s].against+=r.away_score; }
          else { bySeason[s].for+=r.away_score; bySeason[s].against+=r.home_score; }
          bySeason[s].g++;
        }
      });
      const rows = Object.entries(bySeason).sort(([a],[b])=>Number(a)-Number(b))
        .map(([s,v])=>({s, for:v.g? v.for/v.g:0, against:v.g? v.against/v.g:0}));
      destroy('team');
      if(!rows.length) return;
      state.charts.team = new Chart(el.getContext('2d'), {
        type:'line',
        data:{ labels:rows.map(r=>r.s), datasets:[
          {label:'Points For', data:rows.map(r=>r.for), borderWidth:3, tension:.25},
          {label:'Points Against', data:rows.map(r=>r.against), borderWidth:3, tension:.25},
        ]},
        options:{ responsive:true, maintainAspectRatio:false }
      });
    }

    function refresh(){
      updateKPIs();
      updateSpreadChart();
      updateMonthlyChart();
      const q=document.getElementById('teamQ').value;
      updateTeamScoringChart(q);
    }

    document.getElementById('teamBtn').addEventListener('click', ()=>{
      updateTeamScoringChart(document.getElementById('teamQ').value);
    });

    (async function init(){
      hideErr();
      const found = await fetchFirstWorking();
      if(!found){ showErr('Could not find master_NCAAF_Data.csv in this site. Place it in the same folder or /data or /csv.'); return; }
      document.getElementById('sourceInfo').textContent = 'Loaded: ' + found.source;
      state.raw = found.rows;
      state.rows = state.raw.slice(); // no extra filters yet
      refresh();
    })();
  </script>
</body>
</html>
