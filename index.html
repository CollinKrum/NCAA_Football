<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NCAAF Betting Analysis Dashboard</title>

  <!-- Chart.js & PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg: #153a66;
      --bg-2: #0f2c4d;
      --accent: #f37024;
      --muted: #e6edf5;
      --text: #f6fbff;
      --text-dim: #cfe2ff;
      --ok: #23c55e;
      --warn: #fbbf24;
      --bad: #ef4444;
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
      min-height: 100%;
    }
    header {
      position: sticky; top: 0; z-index: 10;
      background: linear-gradient(180deg, rgba(15,44,77,.95), rgba(21,58,102,.95));
      border-bottom: 2px solid rgba(243,112,36,.35);
      backdrop-filter: blur(6px);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px }
    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06);
    }
    h1 { margin: 0; font-size: 22px; letter-spacing: .5px }
    .subtle { color: var(--text-dim); font-size: 13px }
    .badge {
      background: var(--accent); color: #041625; padding: 6px 10px;
      border-radius: 999px; font-weight: 700; letter-spacing: .3px; font-size: 12px;
    }
    .kpi {
      display: flex; align-items: baseline; gap: 8px;
    }
    .kpi .value { font-size: 24px; font-weight: 800 }
    .kpi .label { font-size: 12px; color: var(--text-dim) }
    .chip { background: rgba(243,112,36,.15); color: var(--text); padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(243,112,36,.35); }
    .controls { display:flex; flex-wrap: wrap; gap: 8px }
    select, input[type="file"] {
      background: rgba(255,255,255,.06); color: var(--text); border: 1px solid rgba(255,255,255,.15);
      padding: 8px 10px; border-radius: 8px; outline: none;
    }
    .btn {
      background: var(--accent); color: #041625; border: none; padding: 8px 12px; border-radius: 10px; font-weight: 700;
      cursor: pointer;
    }
    .btn:disabled { opacity: .6; cursor: not-allowed }
    .grid-3 { grid-column: span 4 }
    .grid-4 { grid-column: span 4 }
    .grid-6 { grid-column: span 6 }
    .grid-12 { grid-column: span 12 }
    canvas { width: 100% !important; height: 320px !important }
    .footer { margin-top: 30px; text-align: center; color: var(--text-dim); font-size: 12px }
    .error { color: #ffd5d5; background: rgba(239,68,68,.15); border: 1px solid rgba(239,68,68,.35); padding: 10px 12px; border-radius: 10px }
    @media (max-width: 1000px) {
      .grid-3, .grid-4, .grid-6 { grid-column: span 12 }
      canvas { height: 260px !important }
    }
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap: 12px">
      <div style="display:flex; align-items:center; gap: 10px">
        <span class="badge">NCAAF</span>
        <div>
          <h1>Betting Analysis Dashboard</h1>
          <div class="subtle">Load your <b>master_NCAAF_Data.csv</b> or let the page try to fetch it from this folder.</div>
        </div>
      </div>
      <div class="controls">
        <input id="fileInput" type="file" accept=".csv" />
        <select id="seasonSelect"></select>
        <select id="bookSelect"></select>
        <button class="btn" id="resetBtn">Reset</button>
      </div>
    </div>
  </header>

  <main class="container" id="app">
    <section class="row" id="kpis">
      <div class="card grid-3">
        <div class="kpi"><span class="value" id="kpiTotalGames">0</span><span class="label">Total Games</span></div>
        <div class="subtle" id="kpiHomeAway"></div>
      </div>
      <div class="card grid-3">
        <div class="kpi"><span class="value" id="kpiHomeATS">0%</span><span class="label">Home ATS</span></div>
        <div class="subtle" id="kpiSpread"></div>
      </div>
      <div class="card grid-3">
        <div class="kpi"><span class="value" id="kpiOvers">0%</span><span class="label">Overs Hit</span></div>
        <div class="subtle" id="kpiAvgTotal"></div>
      </div>
      <div class="card grid-3">
        <div class="kpi"><span class="value" id="kpiAvgScore">0.0</span><span class="label">Avg Score</span></div>
        <div class="subtle">Points per game (both teams)</div>
      </div>
    </section>

    <section class="row" style="margin-top:10px">
      <div class="card grid-6">
        <div style="display:flex; align-items:center; justify-content:space-between">
          <h3 style="margin:0">Spread Distribution</h3>
          <span class="chip" id="spreadSample">0 games</span>
        </div>
        <canvas id="spreadChart"></canvas>
      </div>
      <div class="card grid-6">
        <div style="display:flex; align-items:center; justify-content:space-between">
          <h3 style="margin:0">Monthly Totals</h3>
          <span class="chip" id="monthlySample">0 months</span>
        </div>
        <canvas id="monthlyChart"></canvas>
      </div>
      <div class="card grid-12">
        <div style="display:flex; align-items:center; justify-content:space-between">
          <h3 style="margin:0">Team Scoring By Season</h3>
          <div class="controls">
            <input id="teamSearch" placeholder="Team (e.g. Alabama)" style="min-width: 220px"/>
            <button class="btn" id="teamBtn">Update</button>
          </div>
        </div>
        <canvas id="teamScoringChart"></canvas>
      </div>
    </section>

    <section id="errorBox" class="container" style="padding: 0; margin-top: 14px; display:none">
      <div class="error" id="errorText">Error loading data.</div>
    </section>

    <div class="footer">Built for GitHub Pagesâ€”single file, no bundler. Paste in your CSV and go.</div>
  </main>

  <script>
    /*** App State ***/
    const state = {
      raw: [],    // full parsed rows
      rows: [],   // filtered rows for current view
      charts: {}, // chart instances
      seasons: [],
      books: [],
    };

    /************ Utilities ************/
    function showError(msg) {
      const box = document.getElementById('errorBox');
      const text = document.getElementById('errorText');
      text.textContent = msg;
      box.style.display = 'block';
      console.error(msg);
    }
    function hideError() { document.getElementById('errorBox').style.display = 'none'; }

    // Robust number coercion
    const toNum = (v) => (v === null || v === undefined || v === '' ? NaN : Number(v));

    // Expect columns (case-insensitive): season, month, date, home, away, home_score, away_score, spread, total, book, resultATS, resultOU
    function normalizeRow(row) {
      const map = {};
      for (const k in row) map[k.toLowerCase().trim()] = row[k];

      return {
        season: (map.season || '').toString().trim(),
        month: (map.month || '').toString().trim(),
        date: (map.date || '').toString().trim(),
        home: (map.home || map.home_team || '').toString().trim(),
        away: (map.away || map.away_team || '').toString().trim(),
        home_score: toNum(map.home_score ?? map.homepoints ?? map.home_pts),
        away_score: toNum(map.away_score ?? map.awaypoints ?? map.away_pts),
        spread: toNum(map.spread ?? map.close_spread),
        total: toNum(map.total ?? map.close_total),
        book: (map.book || map.bookmaker || '').toString().trim(),
        resultats: (map.resultats || map.home_ats || '').toString().trim(),
        resultou: (map.resultou || map.total_result || '').toString().trim(),
      };
    }

    function computeSeasonsAndBooks(rows) {
      const seasons = new Set();
      const books = new Set();
      rows.forEach(r => {
        if (r.season) seasons.add(r.season);
        if (r.book) books.add(r.book);
      });
      state.seasons = Array.from(seasons).sort((a,b)=>Number(a)-Number(b));
      state.books = ['All Books', ...Array.from(books).sort()];
      fillSelects();
    }

    function fillSelects() {
      const seasonSel = document.getElementById('seasonSelect');
      const bookSel = document.getElementById('bookSelect');
      seasonSel.innerHTML = '<option value="all">All Seasons</option>' +
        state.seasons.map(s => `<option value="${s}">${s}</option>`).join('');
      bookSel.innerHTML = state.books.map(b => `<option value="${b}">${b}</option>`).join('');
    }

    function applyFilters() {
      const season = document.getElementById('seasonSelect').value;
      const book = document.getElementById('bookSelect').value;

      state.rows = state.raw.filter(r => {
        const okSeason = (season === 'all') || (r.season === season);
        const okBook = (book === 'All Books') || (r.book === book);
        return okSeason && okBook;
      });
    }

    /************ KPIs ************/
    function updateKPIs() {
      const rows = state.rows;
      const totalGames = rows.length;
      let homeWins = 0, awayWins = 0;
      let homeATSWins = 0, homeATSTotal = 0;
      let overs = 0, totals = 0;
      let pointsSum = 0;

      rows.forEach(r => {
        const hs = r.home_score, as = r.away_score;
        if (!Number.isNaN(hs) && !Number.isNaN(as)) {
          pointsSum += (hs + as);
          if (hs > as) homeWins++; else if (as > hs) awayWins++;
        }
        if (r.resultats) {
          homeATSTotal++;
          if (r.resultats.toLowerCase().includes('home')) homeATSWins++;
        }
        if (r.resultou) {
          totals++;
          if (r.resultou.toLowerCase().includes('over')) overs++;
        }
      });

      const avgScore = totalGames ? (pointsSum / totalGames) : 0;
      const homeATSPct = homeATSTotal ? (homeATSWins / homeATSTotal * 100) : 0;
      const oversPct = totals ? (overs / totals * 100) : 0;

      document.getElementById('kpiTotalGames').textContent = totalGames.toLocaleString();
      document.getElementById('kpiHomeAway').textContent = `Home ${homeWins} â€¢ Away ${awayWins}`;
      document.getElementById('kpiHomeATS').textContent = homeATSPct.toFixed(1) + '%';
      document.getElementById('kpiSpread').textContent = `From ${minSpread(rows)} to ${maxSpread(rows)} spread`;
      document.getElementById('kpiOvers').textContent = oversPct.toFixed(1) + '%';
      document.getElementById('kpiAvgTotal').textContent = `${totals} games with total`;
      document.getElementById('kpiAvgScore').textContent = avgScore.toFixed(1);
    }

    function minSpread(rows) {
      const arr = rows.map(r => r.spread).filter(v => !Number.isNaN(v));
      return arr.length ? Math.min(...arr).toFixed(1) : 'â€”';
    }
    function maxSpread(rows) {
      const arr = rows.map(r => r.spread).filter(v => !Number.isNaN(v));
      return arr.length ? Math.max(...arr).toFixed(1) : 'â€”';
    }

    /************ Charts ************/
    function destroyChart(name) {
      if (state.charts[name]) {
        state.charts[name].destroy();
        state.charts[name] = null;
      }
    }

    function updateSpreadChart() {
      const ctxEl = document.getElementById('spreadChart');
      if (!ctxEl) return;
      const spreads = state.rows.map(r => r.spread).filter(v => !Number.isNaN(v));
      document.getElementById('spreadSample').textContent = spreads.length + ' games';

      // Histogram buckets every 3 points
      const buckets = new Map();
      spreads.forEach(s => {
        const key = (Math.round(s / 3) * 3);
        buckets.set(key, (buckets.get(key) || 0) + 1);
      });

      const labels = Array.from(buckets.keys()).sort((a,b)=>a-b).map(x => (x>=0?'+':'') + x);
      const data = labels.map(l => buckets.get(Number(l)) || 0);

      destroyChart('spread');
      state.charts.spread = new Chart(ctxEl.getContext('2d'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Games', data, borderWidth: 1 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { x: { grid: { display: false }}, y: { beginAtZero: true } }
        }
      });
    }

    function updateMonthlyChart() {
      const ctxEl = document.getElementById('monthlyChart');
      if (!ctxEl) return;
      const map = new Map();
      state.rows.forEach(r => {
        if (!r.month) return;
        map.set(r.month, (map.get(r.month) || 0) + 1);
      });
      const labels = Array.from(map.keys()).sort((a,b)=>a.localeCompare(b, undefined, {numeric:true}));
      const data = labels.map(l => map.get(l));

      document.getElementById('monthlySample').textContent = labels.length + ' months';

      destroyChart('monthly');
      state.charts.monthly = new Chart(ctxEl.getContext('2d'), {
        type: 'line',
        data: { labels, datasets: [{ label: 'Games per month', data, borderWidth: 3, tension: .25 }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    function updateTeamScoringChart(teamName) {
      const ctxEl = document.getElementById('teamScoringChart');
      if (!ctxEl) return;

      const seasonData = {};
      state.rows.forEach(r => {
        if (!teamName) return;
        const isTeam = (r.home?.toLowerCase().includes(teamName) || r.away?.toLowerCase().includes(teamName));
        if (!isTeam) return;
        const s = r.season || 'Unknown';
        seasonData[s] ||= { for: 0, against: 0, games: 0 };

        if (!Number.isNaN(r.home_score) && !Number.isNaN(r.away_score)) {
          if (r.home?.toLowerCase().includes(teamName)) {
            seasonData[s].for += r.home_score; seasonData[s].against += r.away_score;
          } else {
            seasonData[s].for += r.away_score; seasonData[s].against += r.home_score;
          }
          seasonData[s].games++;
        }
      });

      const rows = Object.entries(seasonData)
        .sort(([a],[b]) => Number(a) - Number(b))
        .map(([s, v]) => ({ season: s, avgFor: v.games ? v.for/v.games : 0, avgAgainst: v.games ? v.against/v.games : 0 }));

      destroyChart('teamScoring');
      if (!rows.length) { return; }

      state.charts.teamScoring = new Chart(ctxEl.getContext('2d'), {
        type: 'line',
        data: {
          labels: rows.map(r => r.season),
          datasets: [
            { label: 'Points For', data: rows.map(r => r.avgFor), borderWidth: 3, tension: .25 },
            { label: 'Points Against', data: rows.map(r => r.avgAgainst), borderWidth: 3, tension: .25 }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    /************ Data Loading ************/
    async function parseCSVText(text) {
      return new Promise((resolve) => {
        Papa.parse(text, {
          header: true,
          dynamicTyping: false,
          skipEmptyLines: true,
          complete: (res) => resolve(res.data.map(normalizeRow))
        });
      });
    }

    async function loadFromFile(file) {
      try {
        hideError();
        const text = await file.text();
        const rows = await parseCSVText(text);
        if (!rows.length) return showError('CSV parsed but contains 0 rows.');
        state.raw = rows;
        computeSeasonsAndBooks(rows);
        applyFilters();
        updateAll();
      } catch (e) {
        showError('Failed to load CSV file: ' + e.message);
      }
    }

    async function tryFetchDefault() {
      try {
        const resp = await fetch('./master_NCAAF_Data.csv', { cache: 'no-store' });
        if (!resp.ok) return;
        const text = await resp.text();
        const rows = await parseCSVText(text);
        if (rows.length) {
          state.raw = rows;
          computeSeasonsAndBooks(rows);
          applyFilters();
          updateAll();
        }
      } catch (e) {
        // Silent: okay to start empty
      }
    }

    function updateAll() {
      updateKPIs();
      updateSpreadChart();
      updateMonthlyChart();
      const q = document.getElementById('teamSearch').value.trim().toLowerCase();
      if (q) updateTeamScoringChart(q);
    }

    /************ Event Wiring ************/
    document.getElementById('fileInput').addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (f) loadFromFile(f);
    });
    document.getElementById('seasonSelect').addEventListener('change', () => { applyFilters(); updateAll(); });
    document.getElementById('bookSelect').addEventListener('change', () => { applyFilters(); updateAll(); });
    document.getElementById('resetBtn').addEventListener('click', () => {
      document.getElementById('seasonSelect').value = 'all';
      document.getElementById('bookSelect').selectedIndex = 0;
      applyFilters(); updateAll();
    });
    document.getElementById('teamBtn').addEventListener('click', () => {
      const q = document.getElementById('teamSearch').value.trim().toLowerCase();
      updateTeamScoringChart(q);
    });

    // Boot
    (async function init() {
      await tryFetchDefault(); // if file exists in repo
    })();
  </script>
</body>
</html>
