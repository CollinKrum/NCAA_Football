<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🏈 NCAAF Betting Analysis Dashboard</title>
  <meta name="description" content="Comprehensive analysis of college football games and betting lines. Interactive charts, spread analysis, and conference breakdowns.">
  <meta property="og:title" content="NCAAF Betting Analysis Dashboard">
  <meta property="og:description" content="Interactive analysis of NCAAF betting lines and results.">
  <meta property="og:type" content="website">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color:#333; min-height:100vh;
    }
    .header {
      background: linear-gradient(90deg, #ff6b35 0%, #f7931e 100%);
      color:#fff; text-align:center; padding:20px;
      box-shadow:0 4px 8px rgba(0,0,0,.2);
    }
    .header h1 { font-size:2.2em; margin-bottom:8px; text-shadow:2px 2px 4px rgba(0,0,0,.3) }
    .header p { opacity:.9 }
    .container { max-width:1200px; margin:0 auto; padding:20px }
    .tabs { display:flex; justify-content:center; gap:8px; margin:20px 0; background:rgba(255,255,255,.1); border-radius:10px; padding:5px; flex-wrap:wrap }
    .tab { background:transparent; border:none; padding:12px 20px; color:#fff; cursor:pointer; border-radius:8px; font-size:15px; transition:.2s; }
    .tab:hover { background:rgba(255,255,255,.2) }
    .tab.active { background: linear-gradient(90deg, #ff6b35, #f7931e); box-shadow:0 4px 8px rgba(0,0,0,.2) }
    .tab-content { display:none }
    .tab-content.active { display:block; animation:fadeIn .35s ease }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none} }
    .filter-section, .analysis-section, .chart-container, .data-table {
      background:rgba(255,255,255,.95); border-radius:15px; padding:20px; margin:20px 0; box-shadow:0 8px 16px rgba(0,0,0,.1);
    }
    .filter-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); gap:15px }
    .filter-item { display:flex; flex-direction:column }
    .filter-item label { font-weight:600; color:#333; margin-bottom:6px }
    select, input { padding:10px; border:2px solid #ddd; border-radius:8px; font-size:14px }
    select:focus, input:focus { outline:none; border-color:#ff6b35 }
    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(240px,1fr)); gap:18px; margin:20px 0 }
    .stat-card { background:linear-gradient(135deg, rgba(255,255,255,.95), rgba(255,255,255,.85)); border-radius:15px; padding:22px; text-align:center; box-shadow:0 8px 16px rgba(0,0,0,.1) }
    .stat-number { font-size:2.2em; font-weight:700; color:#ff6b35; margin-bottom:8px }
    .stat-label { color:#333; font-weight:500 }
    .chart-title { font-size:1.2em; font-weight:600; color:#333; text-align:center; margin-bottom:12px }
    .chart-wrapper { position:relative; height:380px; }
    .two-column { display:grid; grid-template-columns:1fr 1fr; gap:24px }
    .insight-box { background:linear-gradient(90deg, #00b894, #00cec9); color:#fff; padding:12px; border-radius:10px; margin:12px 0 }
    .loading { text-align:center; color:#fff; font-size:1.1em; padding:30px }
    .spinner { border:4px solid rgba(255,255,255,.3); border-top:4px solid #ff6b35; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:16px auto }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .footer { background:rgba(255,255,255,.1); color:#fff; text-align:center; padding:20px; margin-top:30px; border-radius:15px }
    table { width:100%; border-collapse:collapse }
    th, td { padding:12px; text-align:left; border-bottom:1px solid #ddd }
    th { background:#ff6b35; color:#fff; font-weight:600 }
    tr:hover { background:rgba(255,107,53,.1) }
    @media (max-width: 900px) { .two-column{ grid-template-columns:1fr } .header h1{ font-size:1.8em } }
  </style>
</head>
<body>
  <div class="header">
    <h1>🏈 NCAAF Betting Analysis Dashboard</h1>
    <p>Comprehensive Analysis of College Football Games & Betting Lines</p>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab active" data-tab="overview">📊 Overview</button>
      <button class="tab" data-tab="spreads">📈 Spread Analysis</button>
      <button class="tab" data-tab="totals">🎯 Over/Under Analysis</button>
      <button class="tab" data-tab="moneyline">💰 Moneyline Analysis</button>
      <button class="tab" data-tab="game-type">🏟️ Game Type Analysis</button>
      <button class="tab" data-tab="line-movement">📉 Line Movement</button>
      <button class="tab" data-tab="trends">📅 Historical Trends</button>
      <button class="tab" data-tab="conferences">🏟️ Conference Analysis</button>
      <button class="tab" data-tab="teams">🏈 Team Analysis</button>
      <button class="tab" data-tab="yearly">📅 Year-by-Year Analysis</button>
    </div>

    <div id="loading" class="loading">
      <h2>🏈 Loading NCAAF Data...</h2>
      <div class="spinner"></div>
      <p>Processing games and betting lines...</p>
    </div>

    <div id="overview" class="tab-content">
      <div class="filter-section">
        <h3>🎛️ Data Filters</h3>
        <div class="filter-grid">
          <div class="filter-item"><label for="seasonFilter">Season:</label><select id="seasonFilter" onchange="updateAnalysis()"><option value="all">All Seasons</option></select></div>
          <div class="filter-item"><label for="providerFilter">Sportsbook:</label><select id="providerFilter" onchange="updateAnalysis()"><option value="all">All Providers</option></select></div>
          <div class="filter-item"><label for="conferenceFilter">Conference:</label><select id="conferenceFilter" onchange="updateAnalysis()"><option value="all">All Conferences</option></select></div>
          <div class="filter-item"><label for="weekFilter">Week:</label><select id="weekFilter" onchange="updateAnalysis()"><option value="all">All Weeks</option></select></div>
          <div class="filter-item"><label for="teamFilter">Team:</label><select id="teamFilter" onchange="updateAnalysis()"><option value="all">All Teams</option></select></div>
          <div class="filter-item"><label for="seasonTypeFilter">Season Type:</label><select id="seasonTypeFilter" onchange="updateAnalysis()"><option value="all">All Types</option></select></div>
        </div>
      </div>
      <div id="overview-stats" class="stats-grid"></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">📈 Games by Season</div><div class="chart-wrapper"><canvas id="seasonChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">🏢 Sportsbook Coverage</div><div class="chart-wrapper"><canvas id="providerChart"></canvas></div></div>
      </div>
    </div>

    <div id="spreads" class="tab-content">
      <div class="analysis-section"><h2>📈 Point Spread Analysis</h2><div class="insight-box"><strong>Key Insights:</strong> Point spreads reflect the expected margin of victory. Analyzing spread performance helps identify betting value and market inefficiencies.</div></div>
      <div id="spread-stats" class="stats-grid"></div>
      <div class="chart-container"><div class="chart-title">📊 Spread Distribution</div><div class="chart-wrapper"><canvas id="spreadDistChart"></canvas></div></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">🏠 Home vs Away ATS Performance</div><div class="chart-wrapper"><canvas id="homeAwayATSChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">📈 ATS Performance by Season</div><div class="chart-wrapper"><canvas id="atsSeasonChart"></canvas></div></div>
      </div>
    </div>

    <div id="totals" class="tab-content">
      <div class="analysis-section"><h2>🎯 Over/Under Analysis</h2><div class="insight-box"><strong>Key Insights:</strong> Total points analysis reveals scoring trends and helps identify betting opportunities.</div></div>
      <div id="totals-stats" class="stats-grid"></div>
      <div class="chart-container"><div class="chart-title">📊 Total Points Distribution</div><div class="chart-wrapper"><canvas id="totalsDistChart"></canvas></div></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">⬆️ Over/Under Performance</div><div class="chart-wrapper"><canvas id="overUnderChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">📈 Scoring Trends by Season</div><div class="chart-wrapper"><canvas id="scoringTrendChart"></canvas></div></div>
      </div>
    </div>

    <div id="moneyline" class="tab-content">
      <div class="analysis-section"><h2>💰 Moneyline Analysis</h2><div class="insight-box"><strong>Key Insights:</strong> Moneyline odds reveal the implied probability of a team winning, allowing for a deeper look at profitability and upset potential.</div></div>
      <div id="moneyline-stats" class="stats-grid"></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">📈 Moneyline Winners by Odds Range</div><div class="chart-wrapper"><canvas id="moneylineWinChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">🏆 Upset Performance (ROI on Underdogs)</div><div class="chart-wrapper"><canvas id="upsetROIChart"></canvas></div></div>
      </div>
    </div>

    <div id="game-type" class="tab-content">
      <div class="analysis-section"><h2>🏟️ Game Type Analysis</h2><div class="insight-box"><strong>Key Insights:</strong> Different types of games (e.g., neutral site, conference) can have unique betting patterns and outcomes.</div></div>
      <div id="game-type-stats" class="stats-grid"></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">📊 Neutral Site Game Performance</div><div class="chart-wrapper"><canvas id="neutralSiteChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">🤝 Conference Game ATS Performance</div><div class="chart-wrapper"><canvas id="conferenceGameChart"></canvas></div></div>
      </div>
    </div>

    <div id="line-movement" class="tab-content">
      <div class="analysis-section"><h2>📉 Line Movement Analysis</h2><div class="insight-box"><strong>Key Insights:</strong> Significant changes between opening and closing lines can indicate "sharp money" or new information affecting the market.</div></div>
      <div id="line-movement-stats" class="stats-grid"></div>
      <div class="chart-container"><div class="chart-title">📊 Opening vs. Closing Spread Difference</div><div class="chart-wrapper"><canvas id="spreadMovementChart"></canvas></div></div>
      <div class="chart-container"><div class="chart-title">📈 Line Movement vs. Betting Outcome</div><div class="chart-wrapper"><canvas id="movementVsOutcomeChart"></canvas></div></div>
    </div>

    <div id="trends" class="tab-content">
      <div class="analysis-section"><h2>📅 Historical Trends</h2><div class="insight-box"><strong>Key Insights:</strong> Historical trends reveal how betting markets evolved over time.</div></div>
      <div class="chart-container"><div class="chart-title">📈 Average Spreads by Season</div><div class="chart-wrapper"><canvas id="avgSpreadTrendChart"></canvas></div></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">🎯 Average Totals Trend</div><div class="chart-wrapper"><canvas id="avgTotalsTrendChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">📊 Market Volume Trends</div><div class="chart-wrapper"><canvas id="volumeTrendChart"></canvas></div></div>
      </div>
    </div>

    <div id="conferences" class="tab-content">
      <div class="analysis-section"><h2>🏟️ Conference Analysis</h2><div class="insight-box"><strong>Key Insights:</strong> Conferences differ in scoring, competitiveness, and betting patterns.</div></div>
      <div id="conference-stats" class="stats-grid"></div>
      <div class="chart-container"><div class="chart-title">🏟️ Games by Conference</div><div class="chart-wrapper"><canvas id="conferenceGamesChart"></canvas></div></div>
      <div class="data-table"><h3>📊 Conference Performance Table</h3><div id="conferenceTable"></div></div>
    </div>

    <div id="teams" class="tab-content">
      <div class="analysis-section">
        <h2>🏈 Individual Team Analysis</h2>
        <div class="insight-box"><strong>Key Insights:</strong> Deep-dive into ATS, totals, home/away splits, and trends.</div>
        <div class="filter-grid" style="margin: 20px 0;">
          <div class="filter-item"><label for="teamSelectAnalysis">Select Team for Deep Analysis:</label><select id="teamSelectAnalysis" onchange="updateTeamAnalysis()"><option value="">Choose a Team...</option></select></div>
        </div>
      </div>
      <div id="team-stats" class="stats-grid"></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">🏠 Home vs Away Performance</div><div class="chart-wrapper"><canvas id="teamHomeAwayChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">📈 Season-by-Season ATS Record</div><div class="chart-wrapper"><canvas id="teamATSSeasonChart"></canvas></div></div>
      </div>
      <div class="chart-container"><div class="chart-title">⭐ Team Performance vs Spreads</div><div class="chart-wrapper"><canvas id="teamSpreadChart"></canvas></div></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">🎯 Over/Under Performance</div><div class="chart-wrapper"><canvas id="teamTotalsChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">📊 Points Per Game Trends</div><div class="chart-wrapper"><canvas id="teamScoringChart"></canvas></div></div>
      </div>
      <div class="data-table"><h3>🏈 Recent Games</h3><div id="teamGamesTable"></div></div>
    </div>

    <div id="yearly" class="tab-content">
      <div class="analysis-section">
        <h2>📅 Year-by-Year Analysis</h2>
        <div class="insight-box"><strong>Key Insights:</strong> Compare betting market performance across seasons.</div>
        <div class="filter-grid" style="margin: 20px 0;">
          <div class="filter-item"><label for="yearSelectAnalysis">Select Season for Deep Analysis:</label><select id="yearSelectAnalysis" onchange="updateYearAnalysis()"><option value="">Choose a Season...</option></select></div>
          <div class="filter-item"><label for="compareYearSelect">Compare with Season:</label><select id="compareYearSelect" onchange="updateYearAnalysis()"><option value="">No Comparison</option></select></div>
        </div>
      </div>
      <div id="year-stats" class="stats-grid"></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">📊 Monthly Game Distribution</div><div class="chart-wrapper"><canvas id="yearMonthlyChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">🏟️ Conference Breakdown</div><div class="chart-wrapper"><canvas id="yearConferenceChart"></canvas></div></div>
      </div>
      <div class="chart-container"><div class="chart-title">📈 Weekly Performance Trends</div><div class="chart-wrapper"><canvas id="yearWeeklyChart"></canvas></div></div>
      <div class="two-column">
        <div class="chart-container"><div class="chart-title">🎯 Spread Accuracy</div><div class="chart-wrapper"><canvas id="yearSpreadAccuracyChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">📊 Scoring Distribution</div><div class="chart-wrapper"><canvas id="yearScoringDistChart"></canvas></div></div>
      </div>
      <div class="data-table"><h3>📈 Season Comparison Table</h3><div id="yearComparisonTable"></div></div>
    </div>
  </div>

  <div class="footer">
    <p>🏈 NCAAF Betting Analysis Dashboard | Data covers multiple seasons</p>
    <p>Built with Chart.js | Optimized for mobile and desktop</p>
  </div>

  <script>
    // ====== Global state ======
    let allData = [];
    let filteredData = [];
    let charts = {};

    // ====== Tabs ======
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(tabName)?.classList.add('active');
      document.querySelector('[data-tab="'+tabName+'"]')?.classList.add('active');
      // If a new tab is shown, ensure its specific charts/analysis are updated
      if (tabName === 'moneyline') updateMoneylineAnalysis();
      if (tabName === 'game-type') updateGameTypeAnalysis();
      if (tabName === 'line-movement') updateLineMovementAnalysis();
    }
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', () => showTab(tab.getAttribute('data-tab'))));
      loadData();
    });

    // ====== Data load (JSON file in repo) ======
    async function loadData() {
      try {
        const resp = await fetch('data/ncaaf-games.json', { cache: 'no-store' });
        if (!resp.ok) throw new Error('data/ncaaf-games.json not found');
        const json = await resp.json();
        allData = json;
        filteredData = allData;

        initializeFilters();
        updateAnalysis();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('overview').classList.add('active');
      } catch (e) {
        showError('Failed to load data: ' + e.message + '<br><br>Make sure your JSON exists at <code>data/ncaaf-games.json</code>.');
      }
    }

    function showError(message) {
      const el = document.getElementById('loading');
      if (el) el.innerHTML = '<div class="error"><h2>❌ Error Loading Data</h2><p>'+message+'</p></div>';
    }

    // ====== Filters ======
    function initializeFilters() {
      // Seasons
      const seasons = [...new Set(allData.map(r => r.Season))].filter(Boolean).sort((a,b)=>a-b);
      const seasonSel = document.getElementById('seasonFilter');
      seasons.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; seasonSel.appendChild(o); });

      // Year analysis dropdowns
      const yearSel = document.getElementById('yearSelectAnalysis');
      const compareSel = document.getElementById('compareYearSelect');
      seasons.forEach(s => {
        const o1=document.createElement('option'); o1.value=s; o1.textContent=s; yearSel.appendChild(o1);
        const o2=document.createElement('option'); o2.value=s; o2.textContent=s; compareSel.appendChild(o2);
      });

      // Providers
      const providers = [...new Set(allData.map(r => r.LineProvider))].filter(Boolean).sort();
      const providerSel = document.getElementById('providerFilter');
      providers.forEach(p => { const o=document.createElement('option'); o.value=p; o.textContent=p; providerSel.appendChild(o); });

      // Conferences
      const conferences = [...new Set(allData.map(r => r.HomeConference))].filter(Boolean).sort();
      const confSel = document.getElementById('conferenceFilter');
      conferences.forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; confSel.appendChild(o); });

      // Weeks
      const weeks = [...new Set(allData.map(r => r.Week))].filter(Boolean).sort((a,b)=>a-b);
      const weekSel = document.getElementById('weekFilter');
      weeks.forEach(w => { const o=document.createElement('option'); o.value=w; o.textContent='Week '+w; weekSel.appendChild(o); });

      // Teams
      const teams = [...new Set([...allData.map(r=>r.HomeTeam_x), ...allData.map(r=>r.AwayTeam_x)])].filter(Boolean).sort();
      const teamSel = document.getElementById('teamFilter');
      const teamSelAnalysis = document.getElementById('teamSelectAnalysis');
      teams.forEach(t => {
        const o=document.createElement('option'); o.value=t; o.textContent=t; teamSel.appendChild(o);
        const o2=document.createElement('option'); o2.value=t; o2.textContent=t; teamSelAnalysis.appendChild(o2);
      });

      // Season Type
      const seasonTypes = [...new Set(allData.map(r => r.SeasonType))].filter(Boolean).sort();
      const seasonTypeSel = document.getElementById('seasonTypeFilter');
      seasonTypes.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s.charAt(0).toUpperCase() + s.slice(1); seasonTypeSel.appendChild(o); });
    }

    function applyFilters() {
      const s = document.getElementById('seasonFilter')?.value || 'all';
      const p = document.getElementById('providerFilter')?.value || 'all';
      const c = document.getElementById('conferenceFilter')?.value || 'all';
      const w = document.getElementById('weekFilter')?.value || 'all';
      const t = document.getElementById('teamFilter')?.value || 'all';
      const st = document.getElementById('seasonTypeFilter')?.value || 'all';

      filteredData = allData.filter(r => {
        if (s !== 'all' && r.Season != s) return false;
        if (p !== 'all' && r.LineProvider !== p) return false;
        if (c !== 'all' && r.HomeConference !== c && r.AwayConference !== c) return false;
        if (w !== 'all' && r.Week != w) return false;
        if (t !== 'all' && r.HomeTeam_x !== t && r.AwayTeam_x !== t) return false;
        if (st !== 'all' && r.SeasonType !== st) return false;
        return true;
      });
    }

    // ====== Top-level update ======
    function updateAnalysis() {
      applyFilters();
      updateOverviewStats();
      updateCharts();
      updateSpreadAnalysis();
      updateTotalsAnalysis();
      updateMoneylineAnalysis();
      updateGameTypeAnalysis();
      updateLineMovementAnalysis();
      updateHistoricalTrends();
      updateConferenceAnalysis();
    }

    // ====== Helper Functions ======
    function destroy(name){ if(charts[name]){ charts[name].destroy(); charts[name]=null; }}

    // Convert American odds to decimal odds
    function toDecimal(odds) {
      if (!odds) return null;
      if (odds > 0) return (odds / 100) + 1;
      return (100 / Math.abs(odds)) + 1;
    }

    // Calculate profitability
    function getProfitability(data, homeOddsCol, awayOddsCol, homeScoreCol, awayScoreCol) {
      let totalBet = 0;
      let totalReturn = 0;
      let winningBets = 0;
      let totalBets = 0;

      data.forEach(game => {
        const homeOdds = game[homeOddsCol];
        const awayOdds = game[awayOddsCol];
        const homeScore = game[homeScoreCol];
        const awayScore = game[awayScoreCol];

        if (homeOdds && awayOdds && homeScore != null && awayScore != null) {
          totalBets++;
          const winner = homeScore > awayScore ? 'home' : 'away';

          if (homeOdds < 0) { // Home is favorite
            totalBet += 100;
            if (winner === 'home') {
              totalReturn += 100 * toDecimal(homeOdds);
              winningBets++;
            }
          } else { // Home is underdog
            totalBet += 100;
            if (winner === 'home') {
              totalReturn += 100 * toDecimal(homeOdds);
              winningBets++;
            }
          }

          if (awayOdds < 0) { // Away is favorite
            totalBet += 100;
            if (winner === 'away') {
              totalReturn += 100 * toDecimal(awayOdds);
              winningBets++;
            }
          } else { // Away is underdog
            totalBet += 100;
            if (winner === 'away') {
              totalReturn += 100 * toDecimal(awayOdds);
              winningBets++;
            }
          }
        }
      });
      const roi = totalBet > 0 ? ((totalReturn - totalBet) / totalBet) * 100 : 0;
      const winRate = totalBets > 0 ? (winningBets / totalBets) * 100 : 0;
      return { totalBets: totalBets/2, totalReturn: totalReturn/2, totalBet: totalBet/2, roi, winRate };
    }

    function getUpsetProfitability(data) {
      let totalBet = 0;
      let totalReturn = 0;
      let winningBets = 0;
      let totalUpsetOpportunities = 0;

      data.forEach(game => {
        const homeOdds = game.HomeMoneyline;
        const awayOdds = game.AwayMoneyline;
        const homeScore = game.HomeScore;
        const awayScore = game.AwayScore;

        if (homeOdds && awayOdds && homeScore != null && awayScore != null) {
          if (homeOdds > 0) { // Home is underdog
            totalUpsetOpportunities++;
            totalBet += 100;
            if (homeScore > awayScore) {
              totalReturn += 100 * toDecimal(homeOdds);
              winningBets++;
            }
          }
          if (awayOdds > 0) { // Away is underdog
            totalUpsetOpportunities++;
            totalBet += 100;
            if (awayScore > homeScore) {
              totalReturn += 100 * toDecimal(awayOdds);
              winningBets++;
            }
          }
        }
      });
      const roi = totalBet > 0 ? ((totalReturn - totalBet) / totalBet) * 100 : 0;
      const winRate = totalUpsetOpportunities > 0 ? (winningBets / totalUpsetOpportunities) * 100 : 0;
      return { totalUpsetOpportunities, totalReturn, roi, winRate };
    }


    // ====== Tab-specific analysis updates ======

    // Overview
    function updateOverviewStats() {
      const totalGames = filteredData.length;
      const completedGames = filteredData.filter(r => r.Completed).length;
      const withSpreads = filteredData.filter(r => r.Spread != null).length;
      const withTotals = filteredData.filter(r => r.OverUnder != null).length;
      const avgSpread = withSpreads ? filteredData.filter(r=>r.Spread!=null).reduce((s,r)=>s+Math.abs(r.Spread||0),0)/withSpreads : 0;
      const avgTotal = withTotals ? filteredData.filter(r=>r.OverUnder!=null).reduce((s,r)=>s+(r.OverUnder||0),0)/withTotals : 0;

      const html = `
        <div class="stat-card"><div class="stat-number">${totalGames.toLocaleString()}</div><div class="stat-label">Total Games</div></div>
        <div class="stat-card"><div class="stat-number">${completedGames.toLocaleString()}</div><div class="stat-label">Completed Games</div></div>
        <div class="stat-card"><div class="stat-number">${avgSpread?avgSpread.toFixed(1):'N/A'}</div><div class="stat-label">Avg Spread</div></div>
        <div class="stat-card"><div class="stat-number">${avgTotal?avgTotal.toFixed(1):'N/A'}</div><div class="stat-label">Avg Total</div></div>`;
      document.getElementById('overview-stats').innerHTML = html;
    }

    // Spread Analysis
    function updateSpreadAnalysis() {
      const spreadGames = filteredData.filter(r => r.Spread != null && r.Completed);
      const atsData = spreadGames.map(r => ({
        spread: r.Spread,
        homeATS: r.HomeScore + r.Spread > r.AwayScore,
        awayATS: r.AwayScore - r.Spread > r.HomeScore,
        push: Math.abs(r.HomeScore - r.AwayScore) === Math.abs(r.Spread),
        homeTeam: r.HomeTeam_x,
        awayTeam: r.AwayTeam_x,
      })).filter(r => !r.push);

      const homeATS = atsData.filter(r => r.homeATS).length;
      const awayATS = atsData.filter(r => r.awayATS).length;
      const totalATS = homeATS + awayATS;
      const homeATS_perc = totalATS ? (homeATS / totalATS * 100).toFixed(1) : 0;
      const awayATS_perc = totalATS ? (awayATS / totalATS * 100).toFixed(1) : 0;
      const pushes = spreadGames.length - totalATS;

      const html = `
        <div class="stat-card"><div class="stat-number">${totalATS.toLocaleString()}</div><div class="stat-label">ATS Results</div></div>
        <div class="stat-card"><div class="stat-number">${homeATS_perc}%</div><div class="stat-label">Home Team ATS Win %</div></div>
        <div class="stat-card"><div class="stat-number">${awayATS_perc}%</div><div class="stat-label">Away Team ATS Win %</div></div>
        <div class="stat-card"><div class="stat-number">${pushes}</div><div class="stat-label">Pushes</div></div>
      `;
      document.getElementById('spread-stats').innerHTML = html;

      updateSpreadDistChart(spreadGames);
      updateHomeAwayATSChart(atsData);
      updateAtsSeasonChart(spreadGames);
    }

    function updateSpreadDistChart(data) {
      const buckets = {'-30+':0,'-20 to -29':0,'-10 to -19':0,'-1 to -9':0,'1 to 9':0,'10 to 19':0,'20 to 29':0,'30+':0};
      data.forEach(r => {
        if(r.Spread!=null){
          if(r.Spread < -29) buckets['-30+']++;
          else if(r.Spread < -19) buckets['-20 to -29']++;
          else if(r.Spread < -9) buckets['-10 to -19']++;
          else if(r.Spread < 0) buckets['-1 to -9']++;
          else if(r.Spread > 29) buckets['30+']++;
          else if(r.Spread > 19) buckets['20 to 29']++;
          else if(r.Spread > 9) buckets['10 to 19']++;
          else if(r.Spread > 0) buckets['1 to 9']++;
        }
      });
      const ctx=document.getElementById('spreadDistChart'); if(!ctx) return; destroy('spreadDistChart');
      charts.spreadDistChart = new Chart(ctx.getContext('2d'), {
        type:'bar', data:{ labels:Object.keys(buckets), datasets:[{ label:'Games', data:Object.values(buckets), backgroundColor:'rgba(255,107,53,.8)', borderColor:'rgba(255,107,53,1)', borderWidth:2 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true }, x:{ title:{display:true, text:'Spread Ranges'} } } }
      });
    }

    function updateHomeAwayATSChart(data){
      const homeWins = data.filter(r => r.homeATS).length;
      const awayWins = data.filter(r => r.awayATS).length;
      const homeLosses = data.filter(r => r.awayATS).length;
      const awayLosses = data.filter(r => r.homeATS).length;
      const ctx = document.getElementById('homeAwayATSChart'); if (!ctx) return; destroy('homeAwayATSChart');
      charts.homeAwayATSChart = new Chart(ctx.getContext('2d'), {
        type: 'bar', data: { labels: ['Home ATS', 'Away ATS'], datasets: [ { label: 'Wins', data: [homeWins, awayWins], backgroundColor: '#2a5298' }, { label: 'Losses', data: [homeLosses, awayLosses], backgroundColor: '#ff6b35' } ] },
        options: { responsive:true, maintainAspectRatio:false, scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } } }
      });
    }

    function updateAtsSeasonChart(data){
      const seasons = [...new Set(data.map(r=>r.Season))].sort();
      const atsWins = seasons.map(s => {
        const seasonData = data.filter(r => r.Season === s && r.Completed);
        const atsWins = seasonData.filter(r => (r.HomeScore + r.Spread > r.AwayScore) || (r.AwayScore - r.Spread > r.HomeScore)).length;
        const total = seasonData.filter(r => Math.abs(r.HomeScore - r.AwayScore) !== Math.abs(r.Spread)).length;
        return total ? (atsWins / total * 100) : 0;
      });
      const ctx=document.getElementById('atsSeasonChart'); if(!ctx) return; destroy('atsSeasonChart');
      charts.atsSeasonChart = new Chart(ctx.getContext('2d'), {
        type:'line', data:{ labels:seasons, datasets:[{ label:'ATS Win %', data:atsWins, borderColor:'#f7931e', backgroundColor:'rgba(247,147,30,.1)', fill:true }]},
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ min:40, max:60, title:{display:true, text:'ATS Win %'} }, x:{ title:{display:true, text:'Season'} } } }
      });
    }

    // Totals Analysis
    function updateTotalsAnalysis() {
      const totalsGames = filteredData.filter(r => r.OverUnder != null && r.Completed);
      const overGames = totalsGames.filter(r => (r.HomeScore + r.AwayScore) > r.OverUnder).length;
      const underGames = totalsGames.filter(r => (r.HomeScore + r.AwayScore) < r.OverUnder).length;
      const totalOutcomes = overGames + underGames;
      const overPerc = totalOutcomes ? (overGames / totalOutcomes * 100).toFixed(1) : 0;
      const underPerc = totalOutcomes ? (underGames / totalOutcomes * 100).toFixed(1) : 0;
      const pushes = totalsGames.length - totalOutcomes;

      const html = `
        <div class="stat-card"><div class="stat-number">${totalOutcomes.toLocaleString()}</div><div class="stat-label">O/U Results</div></div>
        <div class="stat-card"><div class="stat-number">${overPerc}%</div><div class="stat-label">Over Win %</div></div>
        <div class="stat-card"><div class="stat-number">${underPerc}%</div><div class="stat-label">Under Win %</div></div>
        <div class="stat-card"><div class="stat-number">${pushes}</div><div class="stat-label">Pushes</div></div>
      `;
      document.getElementById('totals-stats').innerHTML = html;

      updateTotalsDistChart(totalsGames);
      updateOverUnderChart(totalsGames);
      updateScoringTrendChart(totalsGames);
    }

    function updateTotalsDistChart(data) {
      const buckets = {'<35':0,'35-50':0,'50-65':0,'65-80':0,'>80':0};
      data.forEach(r=>{ if(r.OverUnder!=null) {
        if(r.OverUnder<35) buckets['<35']++;
        else if (r.OverUnder<50) buckets['35-50']++;
        else if (r.OverUnder<65) buckets['50-65']++;
        else if (r.OverUnder<80) buckets['65-80']++;
        else buckets['>80']++;
      }});
      const ctx=document.getElementById('totalsDistChart'); if(!ctx) return; destroy('totalsDistChart');
      charts.totalsDistChart = new Chart(ctx.getContext('2d'), {
        type:'bar', data:{ labels:Object.keys(buckets), datasets:[{ label:'Games', data:Object.values(buckets), backgroundColor:'rgba(0,184,148,.8)', borderColor:'rgba(0,184,148,1)', borderWidth:2 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true }, x:{ title:{display:true, text:'O/U Ranges'} } } }
      });
    }

    function updateOverUnderChart(data){
      const over = data.filter(r=>(r.HomeScore+r.AwayScore)>r.OverUnder).length;
      const under = data.filter(r=>(r.HomeScore+r.AwayScore)<r.OverUnder).length;
      const push = data.length - (over+under);
      const ctx = document.getElementById('overUnderChart'); if(!ctx) return; destroy('overUnderChart');
      charts.overUnderChart = new Chart(ctx.getContext('2d'), {
        type:'pie', data:{ labels:['Over', 'Under', 'Push'], datasets:[{ data:[over,under,push], backgroundColor:['#00cec9','#6c5ce7','#a29bfe']}]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'right' } } }
      });
    }

    function updateScoringTrendChart(data){
      const seasons = [...new Set(data.map(r=>r.Season))].sort();
      const avgTotals = seasons.map(s => {
        const seasonData = data.filter(r => r.Season === s && r.OverUnder!=null);
        return seasonData.reduce((sum, r) => sum + r.OverUnder, 0) / seasonData.length;
      });
      const avgScores = seasons.map(s => {
        const seasonData = data.filter(r => r.Season === s && r.HomeScore!=null);
        return seasonData.reduce((sum, r) => sum + r.HomeScore + r.AwayScore, 0) / seasonData.length;
      });
      const ctx=document.getElementById('scoringTrendChart'); if(!ctx) return; destroy('scoringTrendChart');
      charts.scoringTrendChart = new Chart(ctx.getContext('2d'), {
        type:'line', data:{ labels:seasons, datasets:[{ label:'Avg Closing Total', data:avgTotals, borderColor:'#00b894', backgroundColor:'rgba(0,184,148,.1)', fill:true }, { label:'Avg Game Score', data:avgScores, borderColor:'#ff6b35', backgroundColor:'rgba(255,107,53,.1)', fill:true }]},
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ title:{display:true, text:'Points'} }, x:{ title:{display:true, text:'Season'} } } }
      });
    }

    // Moneyline Analysis
    function updateMoneylineAnalysis() {
        const moneylineGames = filteredData.filter(r => r.HomeMoneyline != null && r.AwayMoneyline != null && r.Completed);
        const { totalBets, roi } = getProfitability(moneylineGames, 'HomeMoneyline', 'AwayMoneyline', 'HomeScore', 'AwayScore');
        const { totalUpsetOpportunities, roi: upsetRoi, winRate: upsetWinRate } = getUpsetProfitability(moneylineGames);
        
        const homeFavGames = moneylineGames.filter(r => r.HomeMoneyline < 0);
        const homeFavWins = homeFavGames.filter(r => r.HomeScore > r.AwayScore).length;
        const awayFavGames = moneylineGames.filter(r => r.AwayMoneyline < 0);
        const awayFavWins = awayFavGames.filter(r => r.AwayScore > r.HomeScore).length;
        
        const favWinRate = (homeFavWins + awayFavWins) / (homeFavGames.length + awayFavGames.length) * 100;
        
        const html = `
          <div class="stat-card"><div class="stat-number">${totalBets.toLocaleString()}</div><div class="stat-label">Total Moneyline Bets</div></div>
          <div class="stat-card"><div class="stat-number">${favWinRate.toFixed(1)}%</div><div class="stat-label">Favorite Win %</div></div>
          <div class="stat-card"><div class="stat-number">${upsetWinRate.toFixed(1)}%</div><div class="stat-label">Upset Win %</div></div>
          <div class="stat-card"><div class="stat-number">${upsetRoi.toFixed(2)}%</div><div class="stat-label">Underdog Betting ROI</div></div>
        `;
        document.getElementById('moneyline-stats').innerHTML = html;

        updateMoneylineWinChart(moneylineGames);
        updateUpsetROIChart(moneylineGames);
    }
    
    function updateMoneylineWinChart(data) {
        const oddsBuckets = { '< -500': { bets: 0, wins: 0 }, '-500 to -200': { bets: 0, wins: 0 }, '-199 to -101': { bets: 0, wins: 0 }, '+100 to +199': { bets: 0, wins: 0 }, '+200 to +499': { bets: 0, wins: 0 }, '> +500': { bets: 0, wins: 0 } };
        data.forEach(game => {
          const homeWin = game.HomeScore > game.AwayScore;
          const awayWin = game.AwayScore > game.HomeScore;
          if (game.HomeMoneyline != null) {
            let bucket;
            if (game.HomeMoneyline < -500) bucket = '< -500';
            else if (game.HomeMoneyline >= -500 && game.HomeMoneyline <= -200) bucket = '-500 to -200';
            else if (game.HomeMoneyline > -200 && game.HomeMoneyline < 0) bucket = '-199 to -101';
            else if (game.HomeMoneyline >= 100 && game.HomeMoneyline <= 199) bucket = '+100 to +199';
            else if (game.HomeMoneyline >= 200 && game.HomeMoneyline <= 499) bucket = '+200 to +499';
            else if (game.HomeMoneyline > 500) bucket = '> +500';
            
            if (bucket) {
              oddsBuckets[bucket].bets++;
              if (homeWin) oddsBuckets[bucket].wins++;
            }
          }
          if (game.AwayMoneyline != null) {
            let bucket;
            if (game.AwayMoneyline < -500) bucket = '< -500';
            else if (game.AwayMoneyline >= -500 && game.AwayMoneyline <= -200) bucket = '-500 to -200';
            else if (game.AwayMoneyline > -200 && game.AwayMoneyline < 0) bucket = '-199 to -101';
            else if (game.AwayMoneyline >= 100 && game.AwayMoneyline <= 199) bucket = '+100 to +199';
            else if (game.AwayMoneyline >= 200 && game.AwayMoneyline <= 499) bucket = '+200 to +499';
            else if (game.AwayMoneyline > 500) bucket = '> +500';
            
            if (bucket) {
              oddsBuckets[bucket].bets++;
              if (awayWin) oddsBuckets[bucket].wins++;
            }
          }
        });

        const labels = Object.keys(oddsBuckets);
        const winRates = labels.map(l => {
          const { bets, wins } = oddsBuckets[l];
          return bets > 0 ? (wins / bets) * 100 : 0;
        });

        const ctx = document.getElementById('moneylineWinChart'); if (!ctx) return; destroy('moneylineWinChart');
        charts.moneylineWinChart = new Chart(ctx.getContext('2d'), {
            type: 'bar', data: { labels, datasets: [{ label: 'Win %', data: winRates, backgroundColor: '#00cec9' }] },
            options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, title:{display:true, text:'Win %'}, max:100 }, x:{ title:{display:true, text:'Moneyline Odds Range'} } } }
        });
    }

    function updateUpsetROIChart(data) {
        const underdogGames = data.filter(game => game.HomeMoneyline > 0 || game.AwayMoneyline > 0);
        const seasons = [...new Set(underdogGames.map(r => r.Season))].sort();
        const roiBySeason = seasons.map(s => {
          const seasonGames = underdogGames.filter(r => r.Season === s);
          const { roi } = getUpsetProfitability(seasonGames);
          return roi;
        });
        
        const ctx = document.getElementById('upsetROIChart'); if (!ctx) return; destroy('upsetROIChart');
        charts.upsetROIChart = new Chart(ctx.getContext('2d'), {
            type: 'line', data: { labels: seasons, datasets: [{ label: 'Underdog Betting ROI %', data: roiBySeason, borderColor: '#f7931e', backgroundColor: 'rgba(247, 147, 30, 0.2)', fill: true }] },
            options: { responsive:true, maintainAspectRatio:false, scales: { y: { title: { display: true, text: 'ROI %' } }, x: { title: { display: true, text: 'Season' } } } }
        });
    }

    // Game Type Analysis
    function updateGameTypeAnalysis() {
        const completedGames = filteredData.filter(r => r.Completed);
        const neutralSiteGames = completedGames.filter(r => r.NeutralSite);
        const nonNeutralSiteGames = completedGames.filter(r => !r.NeutralSite);
        const conferenceGames = completedGames.filter(r => r.ConferenceGame);
        const nonConferenceGames = completedGames.filter(r => !r.ConferenceGame);

        const neutralSiteATS = neutralSiteGames.filter(g => (g.HomeScore+g.Spread > g.AwayScore && g.Spread < 0) || (g.AwayScore-g.Spread > g.HomeScore && g.Spread > 0)).length;
        const neutralSiteTotal = neutralSiteGames.filter(g => g.Spread != null && Math.abs(g.HomeScore - g.AwayScore) !== Math.abs(g.Spread)).length;
        const neutralSiteATS_perc = neutralSiteTotal ? (neutralSiteATS / neutralSiteTotal * 100).toFixed(1) : 0;

        const confATS = conferenceGames.filter(g => (g.HomeScore+g.Spread > g.AwayScore && g.Spread < 0) || (g.AwayScore-g.Spread > g.HomeScore && g.Spread > 0)).length;
        const confTotal = conferenceGames.filter(g => g.Spread != null && Math.abs(g.HomeScore - g.AwayScore) !== Math.abs(g.Spread)).length;
        const confATS_perc = confTotal ? (confATS / confTotal * 100).toFixed(1) : 0;
        
        const html = `
          <div class="stat-card"><div class="stat-number">${neutralSiteGames.length.toLocaleString()}</div><div class="stat-label">Neutral Site Games</div></div>
          <div class="stat-card"><div class="stat-number">${neutralSiteATS_perc}%</div><div class="stat-label">Neutral Site ATS Win %</div></div>
          <div class="stat-card"><div class="stat-number">${conferenceGames.length.toLocaleString()}</div><div class="stat-label">Conference Games</div></div>
          <div class="stat-card"><div class="stat-number">${confATS_perc}%</div><div class="stat-label">Conference Game ATS Win %</div></div>
        `;
        document.getElementById('game-type-stats').innerHTML = html;

        updateNeutralSiteChart(neutralSiteGames, nonNeutralSiteGames);
        updateConferenceGameChart(conferenceGames, nonConferenceGames);
    }
    
    function updateNeutralSiteChart(neutralData, nonNeutralData) {
        const neutralOver = neutralData.filter(r => r.HomeScore != null && r.OverUnder != null && (r.HomeScore + r.AwayScore) > r.OverUnder).length;
        const neutralUnder = neutralData.filter(r => r.HomeScore != null && r.OverUnder != null && (r.HomeScore + r.AwayScore) < r.OverUnder).length;
        const nonNeutralOver = nonNeutralData.filter(r => r.HomeScore != null && r.OverUnder != null && (r.HomeScore + r.AwayScore) > r.OverUnder).length;
        const nonNeutralUnder = nonNeutralData.filter(r => r.HomeScore != null && r.OverUnder != null && (r.HomeScore + r.AwayScore) < r.OverUnder).length;
        
        const neutralLabels = ['Over', 'Under'];
        const nonNeutralLabels = ['Over', 'Under'];
        
        const ctx = document.getElementById('neutralSiteChart'); if (!ctx) return; destroy('neutralSiteChart');
        charts.neutralSiteChart = new Chart(ctx.getContext('2d'), {
            type: 'doughnut', data: {
                labels: ['Neutral Site Over', 'Neutral Site Under', 'Non-Neutral Site Over', 'Non-Neutral Site Under'],
                datasets: [
                    { data: [neutralOver, neutralUnder, 0, 0], backgroundColor: ['#00b894', '#ff6b35'], label: 'Neutral Site' },
                    { data: [0, 0, nonNeutralOver, nonNeutralUnder], backgroundColor: ['#00cec9', '#f7931e'], label: 'Non-Neutral Site' }
                ]
            },
            options: { responsive:true, maintainAspectRatio:false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function updateConferenceGameChart(confData, nonConfData) {
        const confATS = confData.filter(g => (g.HomeScore+g.Spread > g.AwayScore && g.Spread < 0) || (g.AwayScore-g.Spread > g.HomeScore && g.Spread > 0)).length;
        const confNotATS = confData.filter(g => (g.HomeScore+g.Spread < g.AwayScore && g.Spread < 0) || (g.AwayScore-g.Spread < g.HomeScore && g.Spread > 0)).length;
        const nonConfATS = nonConfData.filter(g => (g.HomeScore+g.Spread > g.AwayScore && g.Spread < 0) || (g.AwayScore-g.Spread > g.HomeScore && g.Spread > 0)).length;
        const nonConfNotATS = nonConfData.filter(g => (g.HomeScore+g.Spread < g.AwayScore && g.Spread < 0) || (g.AwayScore-g.Spread < g.HomeScore && g.Spread > 0)).length;

        const ctx = document.getElementById('conferenceGameChart'); if (!ctx) return; destroy('conferenceGameChart');
        charts.conferenceGameChart = new Chart(ctx.getContext('2d'), {
            type: 'bar', data: {
                labels: ['Conference Games', 'Non-Conference Games'],
                datasets: [
                    { label: 'ATS Wins', data: [confATS, nonConfATS], backgroundColor: '#2a5298' },
                    { label: 'ATS Losses', data: [confNotATS, nonConfNotATS], backgroundColor: '#ff6b35' }
                ]
            },
            options: { responsive:true, maintainAspectRatio:false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
        });
    }

    // Line Movement Analysis
    function updateLineMovementAnalysis() {
        const gamesWithMovement = filteredData.filter(r => r.OpeningSpread != null && r.Spread != null && r.Completed);
        const spreadMovement = gamesWithMovement.map(g => g.Spread - g.OpeningSpread);
        const totalMovement = gamesWithMovement.map(g => g.OverUnder - g.OpeningOverUnder);
        
        const html = `
          <div class="stat-card"><div class="stat-number">${gamesWithMovement.length.toLocaleString()}</div><div class="stat-label">Games with Spread Movement</div></div>
          <div class="stat-card"><div class="stat-number">${(spreadMovement.filter(m => m > 0).length / gamesWithMovement.length * 100).toFixed(1)}%</div><div class="stat-label">Spread Moved Toward Favorite</div></div>
          <div class="stat-card"><div class="stat-number">${(totalMovement.filter(m => m > 0).length / gamesWithMovement.length * 100).toFixed(1)}%</div><div class="stat-label">Total Moved Up (Over)</div></div>
        `;
        document.getElementById('line-movement-stats').innerHTML = html;

        updateSpreadMovementChart(gamesWithMovement);
        updateMovementVsOutcomeChart(gamesWithMovement);
    }
    
    function updateSpreadMovementChart(data) {
        const buckets = { '<-3': 0, '-3 to -1': 0, '0': 0, '1 to 3': 0, '>3': 0 };
        data.forEach(g => {
            const movement = g.Spread - g.OpeningSpread;
            if (movement < -3) buckets['<-3']++;
            else if (movement >= -3 && movement < 0) buckets['-3 to -1']++;
            else if (movement === 0) buckets['0']++;
            else if (movement > 0 && movement <= 3) buckets['1 to 3']++;
            else if (movement > 3) buckets['>3']++;
        });

        const ctx = document.getElementById('spreadMovementChart'); if (!ctx) return; destroy('spreadMovementChart');
        charts.spreadMovementChart = new Chart(ctx.getContext('2d'), {
            type: 'bar', data: { labels: Object.keys(buckets), datasets: [{ label: 'Number of Games', data: Object.values(buckets), backgroundColor: '#6c5ce7' }] },
            options: { responsive:true, maintainAspectRatio:false, scales: { y: { beginAtZero: true }, x: { title: { display: true, text: 'Spread Movement (Points)' } } } }
        });
    }

    function updateMovementVsOutcomeChart(data) {
        const movedToFavoriteWins = data.filter(g => {
            if (g.OpeningSpread < g.Spread) { // Spread moved towards favorite
                return (g.HomeScore > g.AwayScore && g.Spread < 0) || (g.AwayScore > g.HomeScore && g.Spread > 0);
            }
            return false;
        }).length;
        
        const movedToUnderdogWins = data.filter(g => {
            if (g.OpeningSpread > g.Spread) { // Spread moved towards underdog
                return (g.HomeScore > g.AwayScore && g.Spread < 0) || (g.AwayScore > g.HomeScore && g.Spread > 0);
            }
            return false;
        }).length;
        
        const totalMoved = data.filter(g => g.OpeningSpread !== g.Spread).length;
        
        const ctx = document.getElementById('movementVsOutcomeChart'); if (!ctx) return; destroy('movementVsOutcomeChart');
        charts.movementVsOutcomeChart = new Chart(ctx.getContext('2d'), {
            type: 'pie', data: { labels: ['Moved to Favorite (Win)', 'Moved to Underdog (Win)'], datasets: [{ data: [movedToFavoriteWins, movedToUnderdogWins], backgroundColor: ['#2a5298', '#ff6b35'] }] },
            options: { responsive:true, maintainAspectRatio:false, plugins: { legend: { position: 'right' } } }
        });
    }


    // Historical Trends
    function updateHistoricalTrends(){ updateAvgSpreadTrendChart(); updateAvgTotalsTrendChart(); updateVolumeTrendChart(); }

    function updateAvgSpreadTrendChart(){
      const bucket={}; filteredData.forEach(r=>{ if(r.Season && r.Spread!=null){ (bucket[r.Season] ||= []).push(Math.abs(r.Spread)); }});
      const data=Object.entries(bucket).sort(([a],[b])=>a-b).map(([s,arr])=>({s, v: arr.reduce((x,y)=>x+y,0)/arr.length }));
      const ctx=document.getElementById('avgSpreadTrendChart'); if(!ctx||!data.length) return; destroy('avgSpreadTrendChart');
      charts.avgSpreadTrendChart=new Chart(ctx.getContext('2d'),{ type:'line', data:{ labels:data.map(d=>d.s), datasets:[{ label:'Average Spread', data:data.map(d=>d.v), borderColor:'#ff6b35', backgroundColor:'rgba(255,107,53,.1)', borderWidth:3, fill:true }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, title:{display:true, text:'Average Spread'} }, x:{ title:{display:true, text:'Season'} } } } });
    }

    function updateAvgTotalsTrendChart(){
      const bucket={}; filteredData.forEach(r=>{ if(r.Season && r.OverUnder!=null){ (bucket[r.Season] ||= []).push(r.OverUnder); }});
      const data=Object.entries(bucket).sort(([a],[b])=>a-b).map(([s,arr])=>({s, v: arr.reduce((x,y)=>x+y,0)/arr.length }));
      const ctx=document.getElementById('avgTotalsTrendChart'); if(!ctx||!data.length) return; destroy('avgTotalsTrendChart');
      charts.avgTotalsTrendChart=new Chart(ctx.getContext('2d'),{ type:'line', data:{ labels:data.map(d=>d.s), datasets:[{ label:'Average Total', data:data.map(d=>d.v), borderColor:'#00cec9', backgroundColor:'rgba(0,206,201,.1)', borderWidth:3, fill:true }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, title:{display:true, text:'Average Total'} }, x:{ title:{display:true, text:'Season'} } } } });
    }

    function updateVolumeTrendChart(){
      const counts={}; filteredData.forEach(r=>{ if(r.Season && r.OverUnder!=null) counts[r.Season]=(counts[r.Season]||0)+1; });
      const data=Object.entries(counts).sort(([a],[b])=>a-b).map(([s,c])=>({s, c}));
      const ctx=document.getElementById('volumeTrendChart'); if(!ctx||!data.length) return; destroy('volumeTrendChart');
      charts.volumeTrendChart=new Chart(ctx.getContext('2d'),{ type:'bar', data:{ labels:data.map(d=>d.s), datasets:[{ label:'Games with Totals', data:data.map(d=>d.c), backgroundColor:'rgba(108,92,231,.8)', borderColor:'rgba(108,92,231,1)', borderWidth:2 }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, title:{display:true, text:'Games with Totals'} }, x:{ title:{display:true, text:'Season'} } } } });
    }

    // Conference Analysis
    function updateConferenceAnalysis() {
      const confData = filteredData.filter(r => r.HomeConference && r.AwayConference && r.Completed);
      const conferences = [...new Set(confData.map(r => r.HomeConference))].sort();

      const stats = conferences.map(c => {
        const confGames = confData.filter(r => r.HomeConference === c || r.AwayConference === c);
        const homeWins = confGames.filter(r => r.HomeScore > r.AwayScore).length;
        const awayWins = confGames.filter(r => r.AwayScore > r.HomeScore).length;
        const totalGames = confGames.length;
        const winRate = totalGames ? (homeWins + awayWins) / totalGames * 100 : 0;
        const avgTotal = confGames.filter(r=>r.HomeScore!=null).reduce((s,r)=>s+r.HomeScore+r.AwayScore,0)/confGames.length;
        const avgSpread = confGames.filter(r=>r.Spread!=null).reduce((s,r)=>s+Math.abs(r.Spread||0),0)/confGames.length;
        return { name: c, games: totalGames, homeWins, awayWins, winRate, avgTotal, avgSpread };
      });

      const mostGamesConf = stats.reduce((prev, curr) => (prev.games > curr.games) ? prev : curr, { games: 0 });
      const highestScoringConf = stats.reduce((prev, curr) => (prev.avgTotal > curr.avgTotal) ? prev : curr, { avgTotal: 0 });
      const largestSpreadConf = stats.reduce((prev, curr) => (prev.avgSpread > curr.avgSpread) ? prev : curr, { avgSpread: 0 });

      const html = `
        <div class="stat-card"><div class="stat-number">${mostGamesConf.name || 'N/A'}</div><div class="stat-label">Most Games Analyzed</div></div>
        <div class="stat-card"><div class="stat-number">${highestScoringConf.name || 'N/A'}</div><div class="stat-label">Highest Avg Total</div></div>
        <div class="stat-card"><div class="stat-number">${largestSpreadConf.name || 'N/A'}</div><div class="stat-label">Largest Avg Spread</div></div>
        <div class="stat-card"><div class="stat-number">${stats.length}</div><div class="stat-label">Total Conferences</div></div>
      `;
      document.getElementById('conference-stats').innerHTML = html;

      updateConferenceGamesChart(stats);
      updateConferenceTable(stats);
    }

    function updateConferenceGamesChart(stats) {
      const sorted = stats.sort((a, b) => b.games - a.games).slice(0, 10);
      const ctx=document.getElementById('conferenceGamesChart'); if(!ctx) return; destroy('conferenceGamesChart');
      charts.conferenceGamesChart = new Chart(ctx.getContext('2d'), {
        type:'bar', data:{ labels:sorted.map(s => s.name), datasets:[{ label:'Games', data:sorted.map(s => s.games), backgroundColor:'#ff6b35' }]},
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
      });
    }

    function updateConferenceTable(stats) {
      const tableDiv = document.getElementById('conferenceTable');
      if (!tableDiv) return;
      let html = `<table><thead><tr><th>Conference</th><th>Games</th><th>Avg Total</th><th>Avg Spread</th></tr></thead><tbody>`;
      stats.sort((a, b) => b.games - a.games).forEach(s => {
        html += `<tr><td>${s.name}</td><td>${s.games}</td><td>${s.avgTotal.toFixed(1)}</td><td>${s.avgSpread.toFixed(1)}</td></tr>`;
      });
      html += `</tbody></table>`;
      tableDiv.innerHTML = html;
    }

    // Team Analysis
    function updateTeamAnalysis(){
      const team = document.getElementById('teamSelectAnalysis').value;
      if (!team) {
        document.getElementById('team-stats').innerHTML = '';
        return;
      }

      const teamGames = filteredData.filter(r => (r.HomeTeam_x === team || r.AwayTeam_x === team) && r.Completed);

      const homeGames = teamGames.filter(r => r.HomeTeam_x === team);
      const awayGames = teamGames.filter(r => r.AwayTeam_x === team);
      const totalGames = teamGames.length;

      const teamATS = teamGames.filter(r => {
        if (!r.Spread) return false;
        const spread = Math.abs(r.Spread);
        const margin = Math.abs(r.HomeScore - r.AwayScore);
        if (r.HomeTeam_x === team) {
          return (r.HomeScore > r.AwayScore && margin > spread) || (r.HomeScore < r.AwayScore && margin < spread)
        } else {
          return (r.AwayScore > r.HomeScore && margin > spread) || (r.AwayScore < r.HomeScore && margin < spread)
        }
      }).length;
      const atsWinRate = totalGames ? (teamATS / totalGames * 100).toFixed(1) : 0;

      const overGames = teamGames.filter(r => r.OverUnder && (r.HomeScore + r.AwayScore) > r.OverUnder).length;
      const underGames = teamGames.filter(r => r.OverUnder && (r.HomeScore + r.AwayScore) < r.OverUnder).length;
      const overPerc = (overGames / (overGames + underGames) * 100).toFixed(1) || 0;

      const html = `
        <div class="stat-card"><div class="stat-number">${totalGames}</div><div class="stat-label">Games Analyzed</div></div>
        <div class="stat-card"><div class="stat-number">${atsWinRate}%</div><div class="stat-label">ATS Win %</div></div>
        <div class="stat-card"><div class="stat-number">${overPerc}%</div><div class="stat-label">Over Win %</div></div>
        <div class="stat-card"><div class="stat-number">${(homeGames.length/totalGames*100).toFixed(1)}%</div><div class="stat-label">Home Game %</div></div>
      `;
      document.getElementById('team-stats').innerHTML = html;

      updateTeamHomeAwayChart(homeGames, awayGames);
      updateTeamATSSeasonChart(teamGames);
      updateTeamSpreadChart(teamGames);
      updateTeamTotalsChart(teamGames);
      updateTeamScoringChart(teamGames);
      updateTeamGamesTable(teamGames);
    }

    function updateTeamHomeAwayChart(homeGames, awayGames){
      const homeWins = homeGames.filter(r => r.HomeScore > r.AwayScore).length;
      const awayWins = awayGames.filter(r => r.AwayScore > r.HomeScore).length;
      const homeLosses = homeGames.filter(r => r.HomeScore < r.AwayScore).length;
      const awayLosses = awayGames.filter(r => r.AwayScore < r.HomeScore).length;
      const ctx=document.getElementById('teamHomeAwayChart'); if(!ctx) return; destroy('teamHomeAwayChart');
      charts.teamHomeAwayChart=new Chart(ctx.getContext('2d'), {
        type:'bar', data:{ labels:['Home', 'Away'], datasets:[{ label:'Wins', data:[homeWins, awayWins], backgroundColor:'#2a5298' }, { label:'Losses', data:[homeLosses, awayLosses], backgroundColor:'#ff6b35' }]},
        options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } } }
      });
    }

    function updateTeamATSSeasonChart(data){
      const seasons = [...new Set(data.map(r=>r.Season))].sort();
      const atsWinRates = seasons.map(s => {
        const seasonData = data.filter(r=>r.Season === s);
        const wins = seasonData.filter(r => (r.HomeTeam_x === data[0].HomeTeam_x && r.HomeScore + r.Spread > r.AwayScore) || (r.AwayTeam_x === data[0].AwayTeam_x && r.AwayScore - r.Spread > r.HomeScore)).length;
        const total = seasonData.filter(r => r.Spread != null).length;
        return total ? (wins/total*100) : 0;
      });
      const ctx=document.getElementById('teamATSSeasonChart'); if(!ctx) return; destroy('teamATSSeasonChart');
      charts.teamATSSeasonChart=new Chart(ctx.getContext('2d'), {
        type:'line', data:{ labels:seasons, datasets:[{ label:'ATS Win %', data:atsWinRates, borderColor:'#f7931e', backgroundColor:'rgba(247,147,30,.1)', fill:true }]},
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ min:0, max:100, title:{display:true, text:'ATS Win %'} }, x:{ title:{display:true, text:'Season'} } } }
      });
    }

    function updateTeamSpreadChart(data) {
      const wins = data.filter(r => (r.HomeTeam_x === r.HomeTeam_x && r.HomeScore + r.Spread > r.AwayScore) || (r.AwayTeam_x === r.AwayTeam_x && r.AwayScore - r.Spread > r.HomeScore)).length;
      const losses = data.filter(r => (r.HomeTeam_x === r.HomeTeam_x && r.HomeScore + r.Spread < r.AwayScore) || (r.AwayTeam_x === r.AwayTeam_x && r.AwayScore - r.Spread < r.HomeScore)).length;
      const pushes = data.filter(r => Math.abs(r.HomeScore - r.AwayScore) === Math.abs(r.Spread)).length;
      const ctx = document.getElementById('teamSpreadChart'); if(!ctx) return; destroy('teamSpreadChart');
      charts.teamSpreadChart = new Chart(ctx.getContext('2d'), {
        type:'pie', data:{ labels:['ATS Wins', 'ATS Losses', 'Pushes'], datasets:[{ data:[wins, losses, pushes], backgroundColor:['#00cec9', '#ff6b35', '#a29bfe']}]},
        options:{ responsive:true, maintainAspectRatio:false }
      });
    }

    function updateTeamTotalsChart(data) {
      const over = data.filter(r => r.OverUnder && (r.HomeScore + r.AwayScore) > r.OverUnder).length;
      const under = data.filter(r => r.OverUnder && (r.HomeScore + r.AwayScore) < r.OverUnder).length;
      const push = data.length - (over + under);
      const ctx = document.getElementById('teamTotalsChart'); if(!ctx) return; destroy('teamTotalsChart');
      charts.teamTotalsChart = new Chart(ctx.getContext('2d'), {
        type:'pie', data:{ labels:['Over', 'Under', 'Push'], datasets:[{ data:[over, under, push], backgroundColor:['#00b894', '#6c5ce7', '#a29bfe']}]},
        options:{ responsive:true, maintainAspectRatio:false }
      });
    }

    function updateTeamScoringChart(data) {
      const seasons = [...new Set(data.map(r => r.Season))].sort();
      const homeScores = seasons.map(s => {
        const seasonData = data.filter(r => r.Season === s && r.HomeTeam_x === document.getElementById('teamSelectAnalysis').value && r.HomeScore != null);
        return seasonData.reduce((sum, r) => sum + r.HomeScore, 0) / seasonData.length;
      });
      const awayScores = seasons.map(s => {
        const seasonData = data.filter(r => r.Season === s && r.AwayTeam_x === document.getElementById('teamSelectAnalysis').value && r.AwayScore != null);
        return seasonData.reduce((sum, r) => sum + r.AwayScore, 0) / seasonData.length;
      });
      const ctx = document.getElementById('teamScoringChart'); if(!ctx) return; destroy('teamScoringChart');
      charts.teamScoringChart = new Chart(ctx.getContext('2d'), {
        type: 'line', data: {
          labels: seasons,
          datasets: [
            { label: 'Avg Home Score', data: homeScores, borderColor: '#2a5298', fill: false },
            { label: 'Avg Away Score', data: awayScores, borderColor: '#f7931e', fill: false }
          ]
        },
        options: { responsive:true, maintainAspectRatio:false, scales: { y: { beginAtZero: true } } }
      });
    }

    function updateTeamGamesTable(data) {
      const tableDiv = document.getElementById('teamGamesTable');
      if (!tableDiv) return;
      const sortedData = data.slice(-10).reverse(); // Last 10 games
      let html = `<table><thead><tr><th>Date</th><th>Opponent</th><th>Result</th><th>Score</th><th>Spread Result</th></tr></thead><tbody>`;
      sortedData.forEach(g => {
        const isHome = g.HomeTeam_x === document.getElementById('teamSelectAnalysis').value;
        const opponent = isHome ? g.AwayTeam_x : g.HomeTeam_x;
        const teamScore = isHome ? g.HomeScore : g.AwayScore;
        const opponentScore = isHome ? g.AwayScore : g.HomeScore;
        const result = teamScore > opponentScore ? 'W' : (teamScore < opponentScore ? 'L' : 'T');
        const score = `${teamScore}-${opponentScore}`;
        let spreadResult = 'N/A';
        if (g.Spread) {
          const covered = isHome ? (teamScore + g.Spread > opponentScore) : (opponentScore - g.Spread > teamScore);
          spreadResult = covered ? 'Covered' : 'Not Covered';
          if (Math.abs(teamScore - opponentScore) === Math.abs(g.Spread)) spreadResult = 'Push';
        }

        html += `<tr><td>${g.StartDate.substring(0,10)}</td><td>vs ${opponent}</td><td>${result}</td><td>${score}</td><td>${spreadResult}</td></tr>`;
      });
      html += `</tbody></table>`;
      tableDiv.innerHTML = html;
    }

    // Yearly Analysis
    function updateYearAnalysis() {
      const year = document.getElementById('yearSelectAnalysis').value;
      const compareYear = document.getElementById('compareYearSelect').value;
      if (!year) return;

      const yearData = filteredData.filter(r => r.Season == year);
      const compareData = compareYear ? filteredData.filter(r => r.Season == compareYear) : null;

      const totalGames = yearData.length;
      const homeWins = yearData.filter(r => r.HomeScore > r.AwayScore).length;
      const avgScore = yearData.filter(r=>r.HomeScore!=null).reduce((s,r)=>s+r.HomeScore+r.AwayScore,0)/yearData.length;
      const overPerc = (yearData.filter(r => (r.HomeScore + r.AwayScore) > r.OverUnder).length / yearData.length * 100).toFixed(1);

      const html = `
        <div class="stat-card"><div class="stat-number">${totalGames}</div><div class="stat-label">${year} Total Games</div></div>
        <div class="stat-card"><div class="stat-number">${(homeWins / totalGames * 100).toFixed(1)}%</div><div class="stat-label">Home Win %</div></div>
        <div class="stat-card"><div class="stat-number">${avgScore.toFixed(1)}</div><div class="stat-label">Avg Total Score</div></div>
        <div class="stat-card"><div class="stat-number">${overPerc}%</div><div class="stat-label">Over %</div></div>
      `;
      document.getElementById('year-stats').innerHTML = html;

      updateYearMonthlyChart(year, yearData);
      updateYearConferenceChart(year, yearData);
      updateYearWeeklyChart(year, yearData);
      updateYearSpreadAccuracyChart(year, yearData);
      updateYearScoringDistChart(year, yearData);
      updateYearComparisonTable(year, yearData, compareYear, compareData);
    }

    function updateYearMonthlyChart(year, yearData){
      const months = {'Sep':0, 'Oct':0, 'Nov':0, 'Dec':0, 'Jan':0};
      yearData.forEach(r => {
        const month = new Date(r.StartDate).toLocaleString('en-us', { month: 'short' });
        if (months.hasOwnProperty(month)) months[month]++;
      });
      const ctx=document.getElementById('yearMonthlyChart'); if(!ctx) return; destroy('yearMonthlyChart');
      charts.yearMonthlyChart = new Chart(ctx.getContext('2d'), {
        type:'bar', data:{ labels:Object.keys(months), datasets:[{ label:'Games', data:Object.values(months), backgroundColor:'#ff6b35' }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
      });
    }

    function updateYearConferenceChart(year, yearData){
      const counts={}; yearData.forEach(r=>{ if(r.HomeConference) counts[r.HomeConference]=(counts[r.HomeConference]||0)+1; });
      const sorted=Object.entries(counts).sort(([,a],[,b])=>b-a).slice(0,10);
      const ctx=document.getElementById('yearConferenceChart'); if(!ctx) return; destroy('yearConferenceChart');
      charts.yearConferenceChart=new Chart(ctx.getContext('2d'), {
        type:'bar', data:{ labels:sorted.map(([n])=>n), datasets:[{ label:'Games', data:sorted.map(([,c])=>c), backgroundColor:'#2a5298' }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, indexAxis:'y', scales:{ x:{ beginAtZero:true } } }
      });
    }

    function updateYearWeeklyChart(year, yearData){
      const buckets={}; yearData.forEach(r=>{ if(r.Week!=null) buckets[r.Week]=(buckets[r.Week]||0)+1; });
      const ctx=document.getElementById('yearWeeklyChart'); if(!ctx) return; destroy('yearWeeklyChart');
      charts.yearWeeklyChart=new Chart(ctx.getContext('2d'), {
        type:'line', data:{ labels:Object.keys(buckets).sort((a,b)=>a-b), datasets:[{ label:'Games', data:Object.values(buckets), borderColor:'#f7931e', fill:true, tension:0.4 }]},
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true }, x:{ title:{display:true, text:'Week'} } } }
      });
    }

    function updateYearSpreadAccuracyChart(year, yearData){
      const diffs = yearData.filter(r=>r.Spread!=null && r.Completed).map(r => Math.abs(r.HomeScore - r.AwayScore) - Math.abs(r.Spread));
      const buckets={'-15+':0,'-10 to -14':0,'-5 to -9':0,'0 to -4':0,'1 to 4':0,'5 to 9':0,'10+':0};
      diffs.forEach(d => {
        if(d<-14) buckets['-15+']++;
        else if (d<-9) buckets['-10 to -14']++;
        else if (d<-4) buckets['-5 to -9']++;
        else if (d<0) buckets['0 to -4']++;
        else if (d<5) buckets['1 to 4']++;
        else if (d<10) buckets['5 to 9']++;
        else buckets['10+']++;
      });
      const ctx=document.getElementById('yearSpreadAccuracyChart'); if(!ctx) return; destroy('yearSpreadAccuracyChart');
      charts.yearSpreadAccuracyChart=new Chart(ctx.getContext('2d'), {
        type:'bar', data:{ labels:Object.keys(buckets), datasets:[{ label:'Games', data:Object.values(buckets), backgroundColor:'#00cec9' }]},
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true }, x:{ title:{display:true, text:'Spread Margin Difference'} } } }
      });
    }

    function updateYearScoringDistChart(year, yearData){
      const buckets={'<35':0,'35-50':0,'50-65':0,'65-80':0,'>80':0};
      yearData.forEach(r=>{ if(r.HomeScore!=null && r.AwayScore!=null){ const tot=r.HomeScore+r.AwayScore; if(tot<35) buckets['<35']++; else if (tot<50) buckets['35-50']++; else if (tot<65) buckets['50-65']++; else if (tot<80) buckets['65-80']++; else buckets['>80']++; } });
      const ctx=document.getElementById('yearScoringDistChart'); if(!ctx) return; destroy('yearScoringDistChart');
      charts.yearScoringDistChart=new Chart(ctx.getContext('2d'),{ type:'bar', data:{ labels:Object.keys(buckets), datasets:[{ label:'Games', data:Object.values(buckets), backgroundColor:'rgba(0,206,201,.8)', borderColor:'rgba(0,206,201,1)', borderWidth:2 }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true }, x:{ title:{ display:true, text:'Total Points' } } } } });
    }

    function updateYearComparisonTable(year, yearData, compareYear, compareData){
      const table = document.getElementById('yearComparisonTable');
      if (!table) return;

      const getMetrics = data => {
        const completed = data.filter(r => r.Completed);
        const homeWins = completed.filter(r => r.HomeScore > r.AwayScore).length;
        const totalGames = completed.length;
        const avgTotalScore = totalGames ? completed.reduce((s, r) => s + r.HomeScore + r.AwayScore, 0) / totalGames : 0;
        const atsWin = completed.filter(r => r.Spread != null && Math.abs(r.HomeScore - r.AwayScore) !== Math.abs(r.Spread)).length;
        const overWin = completed.filter(r => r.OverUnder != null && (r.HomeScore + r.AwayScore) > r.OverUnder).length;
        return {
          totalGames,
          homeWinPerc: (homeWins / totalGames * 100).toFixed(1),
          avgTotalScore: avgTotalScore.toFixed(1),
          atsWinPerc: atsWin ? (atsWin / completed.filter(r => r.Spread != null).length * 100).toFixed(1) : 'N/A',
          overWinPerc: overWin ? (overWin / completed.filter(r => r.OverUnder != null).length * 100).toFixed(1) : 'N/A'
        };
      };

      const metrics1 = getMetrics(yearData);
      const metrics2 = compareData ? getMetrics(compareData) : null;

      let html = `<table><thead><tr><th>Metric</th><th>${year}</th>${compareYear ? `<th>${compareYear}</th><th>Difference</th>` : ''}</tr></thead><tbody>`;
      
      const rows = [
        { label: 'Total Games', key: 'totalGames' },
        { label: 'Home Team Win %', key: 'homeWinPerc' },
        { label: 'Avg Total Score', key: 'avgTotalScore' },
        { label: 'ATS Win %', key: 'atsWinPerc' },
        { label: 'Over %', key: 'overWinPerc' }
      ];

      rows.forEach(row => {
        let diff = '';
        if (metrics2) {
          const val1 = parseFloat(metrics1[row.key]);
          const val2 = parseFloat(metrics2[row.key]);
          if (!isNaN(val1) && !isNaN(val2)) {
            const d = (val1 - val2).toFixed(1);
            diff = `<td>${d > 0 ? '+' : ''}${d}</td>`;
          } else {
            diff = `<td>N/A</td>`;
          }
        }
        html += `<tr><td>${row.label}</td><td>${metrics1[row.key]}</td>${metrics2 ? `<td>${metrics2[row.key]}</td>${diff}` : ''}</tr>`;
      });

      html += `</tbody></table>`;
      table.innerHTML = html;
    }

  </script>
</body>
</html>
