<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèà Football Betting Analysis Dashboard</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèà</text></svg>">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1e3c72, #2a5298); color:#333; min-height:100vh; }
    .header { background: linear-gradient(90deg, #ff6b35, #f7931e); color:#fff; text-align:center; padding:24px 20px; box-shadow:0 4px 8px rgba(0,0,0,.2); }
    .header h1 { font-size:2.2em; margin-bottom:8px; text-shadow:2px 2px 4px rgba(0,0,0,.3) }
    .header .pro-badge { background: rgba(255,255,255,.15); padding: 6px 16px; border-radius: 20px; font-size: 0.85em; margin-top: 12px; display: inline-block; letter-spacing:0.05em; text-transform:uppercase; }
    .sport-switch { display:flex; justify-content:center; gap:12px; margin-top:16px; flex-wrap:wrap; }
    .sport-button { background:rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.3); color:#fff; padding:10px 20px; border-radius:999px; font-weight:600; letter-spacing:0.05em; cursor:pointer; transition:all .2s ease; }
    .sport-button:hover { background:rgba(255,255,255,.28); transform:translateY(-1px); }
    .sport-button.active { background:#fff; color:#ff6b35; box-shadow:0 6px 12px rgba(0,0,0,.18); }
    .container { max-width:1200px; margin:0 auto; padding:20px }
    .tabs { display:flex; justify-content:center; gap:8px; margin:20px 0; background:rgba(255,255,255,.1); border-radius:10px; padding:5px; flex-wrap:wrap }
    .tab { background:transparent; border:none; padding:12px 20px; color:#fff; cursor:pointer; border-radius:8px; font-size:15px; transition:.2s; }
    .tab:hover { background:rgba(255,255,255,.2) }
    .tab.active { background: linear-gradient(90deg, #ff6b35, #f7931e); box-shadow:0 4px 8px rgba(0,0,0,.2) }
    .tab-content { display:none; animation:fadeIn .3s ease }
    .tab-content.active { display:block }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none} }
    .section { background:rgba(255,255,255,.95); border-radius:15px; padding:20px; margin:20px 0; box-shadow:0 8px 16px rgba(0,0,0,.1); }
    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(240px,1fr)); gap:18px; margin:20px 0 }
    .stat-card { background:linear-gradient(135deg, rgba(255,255,255,.95), rgba(255,255,255,.85)); border-radius:15px; padding:22px; text-align:center; box-shadow:0 8px 16px rgba(0,0,0,.1) }
    .stat-number { font-size:2.2em; font-weight:700; color:#ff6b35; margin-bottom:8px }
    .stat-label { color:#333; font-weight:500 }
    .chart-container { background:rgba(255,255,255,.95); border-radius:15px; padding:20px; margin:20px 0; box-shadow:0 8px 16px rgba(0,0,0,.1); }
    .chart-title { font-size:1.2em; font-weight:600; color:#333; text-align:center; margin-bottom:12px }
    .chart-wrapper { position:relative; height:380px; }
    .two-column { display:grid; grid-template-columns:1fr 1fr; gap:24px }
    .pro-insight { background:linear-gradient(90deg, #6c5ce7, #a29bfe); color:#fff; padding:12px; border-radius:10px; margin:12px 0 }
    .sharp-alert { background:linear-gradient(90deg, #e17055, #fd79a8); color:#fff; padding:8px 12px; border-radius:8px; margin:8px 0; font-size:0.9em }
    .ev-positive { color:#00b894; font-weight:bold }
    .ev-negative { color:#e17055; font-weight:bold }
    .key-number { background:#e17055; color:#fff; padding:2px 8px; border-radius:4px; font-weight:bold }
    .market-inefficiency { background:linear-gradient(90deg, #fdcb6e, #e17055); color:#fff; padding:8px; border-radius:8px; margin:8px 0 }
    .filters-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:12px; margin-top:12px }
    .filters-grid label { display:flex; flex-direction:column; gap:6px; font-size:0.8em; font-weight:600; color:#444; text-transform:uppercase; letter-spacing:0.05em }
    .filters-grid select { padding:10px; border-radius:8px; border:1px solid rgba(0,0,0,.12); font-size:0.95em; background:#fff; transition:border-color .2s, box-shadow .2s }
    .filters-grid select:focus { outline:none; border-color:#ff6b35; box-shadow:0 0 0 3px rgba(255,107,53,.25) }
    .table-header { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap }
    .table-actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .btn-export { background:linear-gradient(90deg, #2ecc71, #27ae60); border:none; color:#fff; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600; box-shadow:0 4px 8px rgba(0,0,0,.15); transition:transform .2s ease, box-shadow .2s ease }
    .btn-export:hover { transform:translateY(-1px); box-shadow:0 6px 12px rgba(0,0,0,.2) }
    .btn-export:active { transform:translateY(0); box-shadow:0 3px 6px rgba(0,0,0,.15) }
    .games-count { font-size:0.9em; color:#555 }
    .table-container { margin-top:12px; border-radius:12px; border:1px solid rgba(0,0,0,.08); overflow:hidden; box-shadow:0 6px 12px rgba(0,0,0,.08); background:#fff }
    .muted { color:#5a5a5a; font-size:0.8em; }
    .hidden { display:none !important; }
    .signal-chip { display:inline-block; background:rgba(255,107,53,.15); color:#ff6b35; padding:2px 8px; border-radius:999px; font-size:0.75em; font-weight:600; margin:2px 4px 2px 0; letter-spacing:0.05em; text-transform:uppercase; }
    #nflTable th, #nflTable td { padding:12px 10px; vertical-align:top; }
    #nflTable td { line-height:1.45; }
    #nflTable strong { color:#1e3c72; }
    #gamesTable { width:100%; border-collapse:collapse; font-size:0.92em }
    #gamesTable thead { background:linear-gradient(90deg, rgba(255,107,53,.18), rgba(247,147,30,.18)); color:#333; text-transform:uppercase; letter-spacing:0.05em; font-size:0.78em }
    #gamesTable th, #gamesTable td { padding:10px 12px; text-align:left; border-bottom:1px solid rgba(0,0,0,.05); white-space:nowrap }
    #gamesTable td:nth-child(4) { white-space:normal }
    #gamesTable tbody tr:nth-child(even) { background:rgba(0,0,0,.03) }
    #gamesTable tbody tr:hover { background:rgba(255,107,53,.1) }
    .empty-row td { text-align:center; color:#777; padding:26px 12px; font-style:italic }
    .filters-section { background:rgba(255,255,255,.9); border-radius:14px; padding:16px 20px; box-shadow:0 6px 12px rgba(0,0,0,.08); margin-bottom:20px }
    .filters-section h2 { font-size:1.1em; font-weight:600; margin-bottom:8px; color:#333 }
    .chart-empty { text-align:center; color:#777; font-style:italic; padding:40px 10px }
    .team-select-wrap { max-width:280px }
    .team-summary-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); gap:16px; margin:18px 0 }
    .team-summary-card { background:linear-gradient(135deg, rgba(255,255,255,.95), rgba(255,255,255,.85)); border-radius:12px; padding:16px; box-shadow:0 4px 10px rgba(0,0,0,.1); }
    .team-summary-card h3 { font-size:0.85em; text-transform:uppercase; letter-spacing:0.05em; color:#666; margin-bottom:6px }
    .team-summary-card p { font-size:1.4em; font-weight:700; color:#ff6b35 }
    .team-summary-card small { display:block; margin-top:6px; color:#666; font-size:0.75em }
    @media (max-width: 900px) { .two-column{ grid-template-columns:1fr } .header h1{ font-size:1.8em } }
  </style>
</head>
<body>
  <div class="header">
    <h1 id="header-title">üèà Football Betting Analysis Dashboard</h1>
    <p id="header-subtitle">Professional-grade analytics for college and pro football markets.</p>
    <div class="pro-badge" id="current-sport-label">Currently viewing: NCAAF</div>
    <div class="sport-switch" id="sport-switch">
      <button class="sport-button active" data-sport-button="ncaaf">NCAAF</button>
      <button class="sport-button" data-sport-button="nfl">NFL</button>
    </div>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab active" onclick="showTab('overview')">üìä Overview</button>
      <button class="tab" onclick="showTab('sharp')">‚ö° Sharp Money</button>
      <button class="tab" onclick="showTab('ev')">üí∞ Expected Value</button>
      <button class="tab" onclick="showTab('key-numbers')">üéØ Key Numbers</button>
      <button class="tab" onclick="showTab('spreads')">üìà Spreads</button>
      <button class="tab" onclick="showTab('totals')">üéØ Totals</button>
      <button class="tab" onclick="showTab('teams')">üèüÔ∏è Team Analyzer</button>
      <button class="tab" onclick="showTab('historical')">üìö Historical Data</button>
      <button class="tab" onclick="showTab('nflAdvanced')">üöÄ NFL Advanced</button>
    </div>

    <!-- Tab Contents -->
    <div id="overview" class="tab-content active">
      <div class="pro-insight" id="overview-insight">
        <strong>üî• Pro Insights:</strong> Track market movement, sharp signals, and EV swings for the current football season.
      </div>
      <div id="overview-stats" class="stats-grid">
        <div class="stat-card"><div class="stat-number">2,100</div><div class="stat-label">Total Games</div></div>
        <div class="stat-card"><div class="stat-number">97.8%</div><div class="stat-label">Spread Coverage</div></div>
        <div class="stat-card"><div class="stat-number ev-positive">+2.34%</div><div class="stat-label">Average EV</div></div>
        <div class="stat-card"><div class="stat-number">28.5%</div><div class="stat-label">Sharp Action Detected</div></div>
      </div>
      <div class="section filters-section">
        <h2>Overview Filters</h2>
        <div class="filters-grid">
          <label>Season
            <select id="overview-season">
              <option value="">All Seasons</option>
            </select>
          </label>
          <label>Conference
            <select id="overview-conf">
              <option value="">All Conferences / Divisions</option>
            </select>
          </label>
          <label>Book
            <select id="overview-book">
              <option value="">All Books</option>
            </select>
          </label>
        </div>
      </div>
      <div class="section">
        <div class="table-header">
          <h2>üìÖ Games</h2>
          <div class="table-actions">
            <span id="gamesCount" class="games-count">Loading games‚Ä¶</span>
            <button id="btn-export" type="button" class="btn-export">‚¨áÔ∏è Export CSV</button>
          </div>
        </div>
        <div class="table-container">
          <table id="gamesTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Away</th>
                <th>Home</th>
                <th>Conf / Div</th>
                <th style="text-align:right">Spread</th>
                <th style="text-align:right">Total</th>
                <th>Book</th>
              </tr>
            </thead>
            <tbody id="games-tbody">
              <tr class="empty-row"><td colspan="7">Loading games‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="two-column">
        <div class="chart-container">
          <div class="chart-title">üìà Games by Season</div>
          <div class="chart-wrapper"><canvas id="seasonChart"></canvas></div>
        </div>
        <div class="chart-container">
          <div class="chart-title">üè¢ Sportsbook Coverage</div>
          <div class="chart-wrapper"><canvas id="providerChart"></canvas></div>
        </div>
      </div>
      <div class="section" id="moneyline-section">
        <h2>üíµ Moneyline Snapshot</h2>
        <div id="moneyline-cards" class="team-summary-grid"></div>
        <div class="chart-container">
          <div class="chart-title">Moneyline ROI by Side</div>
          <div class="chart-wrapper"><canvas id="moneylineChart"></canvas></div>
        </div>
      </div>
    </div>

    <!-- Other tab contents here (keeping them brief for space) -->
    <div id="sharp" class="tab-content">
      <div class="section">
        <h2>‚ö° Sharp Money Analysis</h2>
        <!-- Content as in original -->
      </div>
    </div>

    <div id="ev" class="tab-content">
      <div class="section">
        <h2>üí∞ Expected Value Analysis</h2>
        <!-- Content as in original -->
      </div>
    </div>

    <!-- Other tabs... -->
    <div id="nflAdvanced" class="tab-content">
      <div class="section">
        <h2>Advanced NFL Analysis</h2>
        <p>This view highlights sharp money detection, arbitrage scanning, closing‚Äëline value and heat‚Äëmap style indicators for professional football.</p>
      </div>
    </div>
  </div>

<script>
/* Tabs */
function showTab(id) {
  document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`button.tab[onclick="showTab('${id}')"]`)?.classList.add('active');
  document.getElementById(id)?.classList.add('active');
}

/* Safer fetch -> JSON */
async function getJson(url) {
  const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
  const text = await res.text();
  try { return JSON.parse(text); }
  catch {
    console.error(`Non-JSON from ${url}:`, text.slice(0, 500));
    throw new Error(`Expected JSON from ${url} but got HTML/text`);
  }
}

let ALL_GAMES = [];
let STATS = null;
let CURRENT_SEASON = '';
let CURRENT_SPORT = 'ncaaf';

const SPORT_META = {
  ncaaf: {
    label: 'NCAAF',
    subtitle: 'Professional-grade analytics for college football betting.',
    insight: 'College market watchers: track live sharp money, EV swings, and conference line movement in one view.'
  },
  nfl: {
    label: 'NFL',
    subtitle: 'Professional-grade analytics for pro football betting.',
    insight: 'Pro bettors: monitor weekly market shifts, division trends, and sharp money signals across the league.'
  }
};

function getSportMeta(sport = CURRENT_SPORT) {
  return SPORT_META[sport] || SPORT_META.ncaaf;
}

function withSport(url) {
  const separator = url.includes('?') ? '&' : '?';
  return `${url}${separator}sport=${encodeURIComponent(CURRENT_SPORT)}`;
}

function determineCurrentSeason(stats) {
  const seasons = Array.isArray(stats?.seasons) ? stats.seasons : [];
  const numeric = seasons
    .map(value => Number(value))
    .filter(num => Number.isFinite(num))
    .sort((a, b) => b - a);
  return numeric.length ? String(numeric[0]) : '2024';
}

function setSport(sport) {
  const normalized = String(sport || '').toLowerCase();
  if (!SPORT_META[normalized]) return;
  if (CURRENT_SPORT === normalized) return;
  CURRENT_SPORT = normalized;
  updateSportUI();
  loadSportData();
}

function updateSportUI() {
  const meta = getSportMeta();
  document.title = `üèà ${meta.label} Betting Analysis Dashboard`;

  const subtitle = document.getElementById('header-subtitle');
  if (subtitle) subtitle.textContent = meta.subtitle;

  const badge = document.getElementById('current-sport-label');
  if (badge) badge.textContent = `Currently viewing: ${meta.label}`;

  const insight = document.getElementById('overview-insight');
  if (insight) insight.innerHTML = `<strong>üî• Pro Insights:</strong> ${meta.insight}`;

  document.querySelectorAll('[data-sport-button]').forEach(button => {
    const sport = button.getAttribute('data-sport-button');
    const isActive = sport === CURRENT_SPORT;
    button.classList.toggle('active', isActive);
  });
}

// Main data loading function
async function loadSportData() {
  try {
    console.log('üîç Starting loadSportData for:', CURRENT_SPORT);
    
    const statsUrl = withSport('/api/stats');
    const gamesUrl = withSport('/api/games');
    
    const [statsResp, gamesResp] = await Promise.all([
      getJson(statsUrl),
      getJson(gamesUrl)
    ]);

    console.log('üìä Stats Response:', statsResp);
    console.log('üèà Games Response:', gamesResp);

    if (!statsResp.success || !gamesResp.success) {
      throw new Error('API returned success=false');
    }

    const statsData = statsResp.data || {};
    const games = Array.isArray(gamesResp.data) ? gamesResp.data : [];
    
    ALL_GAMES = games;
    CURRENT_SEASON = determineCurrentSeason(statsData);

    console.log('üèÜ Set CURRENT_SEASON to:', CURRENT_SEASON);
    console.log('üèÜ ALL_GAMES length:', ALL_GAMES.length);

    updateSportUI();

    const totalGames = games.length || 0;
    const spreadCov = statsData.spreadCoverage || 100;
    const totalsCov = statsData.totalsCoverage || 100;
    const booksCount = Array.isArray(statsData.sportsbooks) ? statsData.sportsbooks.length : 1;

    const overviewStats = document.getElementById('overview-stats');
    if (overviewStats) {
      overviewStats.innerHTML = `
        <div class="stat-card"><div class="stat-number">${totalGames.toLocaleString()}</div><div class="stat-label">Total Games</div></div>
        <div class="stat-card"><div class="stat-number">${spreadCov.toFixed(1)}%</div><div class="stat-label">Spread Coverage</div></div>
        <div class="stat-card"><div class="stat-number">${totalsCov.toFixed(1)}%</div><div class="stat-label">Totals Coverage</div></div>
        <div class="stat-card"><div class="stat-number">${booksCount}</div><div class="stat-label">Books</div></div>
      `;
    }

    // Update games table
    const tbody = document.getElementById('games-tbody');
    if (tbody && games.length > 0) {
      const game = games[0];
      tbody.innerHTML = `
        <tr>
          <td>${new Date(game.startDate || Date.now()).toLocaleDateString()}</td>
          <td>${game.awayTeam || 'Away'}</td>
          <td>${game.homeTeam || 'Home'}</td>
          <td>${game.homeConference || 'Conference'}</td>
          <td style="text-align:right">${game.spread || '‚Äî'}</td>
          <td style="text-align:right">${game.overUnder || '‚Äî'}</td>
          <td>${game.lineProvider || 'Book'}</td>
        </tr>
      `;
      
      const gamesCount = document.getElementById('gamesCount');
      if (gamesCount) {
        gamesCount.textContent = `${games.length} games`;
      }
    }

    console.log('‚úÖ loadSportData completed successfully');
    
  } catch (error) {
    console.error(`‚ùå Failed to load ${CURRENT_SPORT} data:`, error);
    const overviewStats = document.getElementById('overview-stats');
    if (overviewStats) {
      overviewStats.innerHTML = `
        <div class="stat-card"><div class="stat-number">‚ùå</div><div class="stat-label">Error loading data</div></div>
        <div class="stat-card"><div class="stat-number">‚Äî</div><div class="stat-label">Check console</div></div>
      `;
    }
  }
}

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('[data-sport-button]').forEach(button => {
    button.addEventListener('click', () => setSport(button.getAttribute('data-sport-button')));
  });
  updateSportUI();
  loadSportData();
});
</script>

</body>
</html>
